<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>


<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<title>좌석 선택</title>
<script type="text/javascript">
	function changeRound(tkDetailNo) {
		console.log(tkDetailNo);
		window.location.href = "seat?tkNo=${tkDetailVOList[0].tkNo}&tkDetailNo=" + tkDetailNo;
	}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

    <div class="container-sm" style="max-width: 100%; overflow-x: hidden;">
        <div style="display: flex; flex-direction: column; min-height: 100vh; border: 2px solid #ccc;">
            
            <!-- 헤더 영역 -->
			<div style="display: flex; flex-direction: row; align-items: center; border: 2px solid #ccc;">
				<!-- 좌측: 좌석선택 -->
				<div style="width: 200px; text-align: center; padding: 20px;">좌석선택</div>

				<!-- 구분선 -->
				<div style="width: 1px; height: 80px; background-color: #ccc;"></div>

				<!-- 오른쪽 내용 -->
				<div style="display: flex; flex-direction: column; padding: 20px; gap: 10px; flex-grow: 1;">
					<h5 style="margin: 0;">${tkDetailVOList[0].gdsNm} | ${seatVOList[0].tkLctn} | ${tkDetailVOList[0].tkYmd}</h5>
					<select class="form-select form-select-lg" onchange="changeRound(this.value)" style="max-width: 250px;">
						<option selected>다른 회차 선택하기</option>
						<c:forEach var="tkDetailVO" items="${tkDetailVOList}">
							<option value="${tkDetailVO.tkDetailNo}">${tkDetailVO.tkYmd} / ${tkDetailVO.tkRound}회차</option>
						</c:forEach>
					</select>
				</div>
			</div>

            <!-- 본문 영역 -->
            <div style="display: flex; padding: 10px;">
                <div style="display: flex; flex-direction: column; flex: 3; justify-content: space-between;">
                    
                    <!-- 층 반복: 1층, 2층 -->
                    <c:forEach var="floorEntry" items="${floorSectionMap}">
					<c:set var="floor" value="${floorEntry.key}" />
					<c:set var="sections" value="${floorEntry.value}" />

					<div style="font-size: 15px; font-weight: bold; ">
						${floor}F
					</div>

					<c:forEach var="i" begin="0" end="${fn:length(sections) - 1}" step="3">
						<div style="display: flex; justify-content: center; margin-bottom: 10px;">
							<c:forEach var="j" begin="0" end="2">
								<c:set var="idx" value="${i + j}" />
								<c:if test="${idx lt fn:length(sections)}">
									<c:set var="sectionName" value="${sections[idx]}" />

									<!-- 정렬 방향 설정 -->
									<c:choose>
										<c:when test="${sectionName == 'A' || sectionName == 'D'}">
											<c:set var="alignStyle" value="flex-end" />
										</c:when>
										<c:when test="${sectionName == 'B'}">
											<c:set var="alignStyle" value="center" />
										</c:when>
										<c:otherwise>
											<c:set var="alignStyle" value="flex-start" />
										</c:otherwise>
									</c:choose>

									<div style="display: flex; flex-direction: column; align-items: ${alignStyle}; border: 2px solid #444; padding: 5px; margin: 1px; min-width: 160px;">
										<div style="font-weight: bold;  margin-bottom: 5px;">
											${sectionName}
										</div>

										<c:set var="currentRow" value="" />
										<c:forEach var="seat" items="${seatVOList}">
											<c:if test="${seat.seatFloor == floor && seat.seatSection == sectionName}">
												
												<c:if test="${currentRow != seat.seatRow}">
													<c:if test="${currentRow != ''}">
														</div> <!-- 이전 row 닫기 -->
													</c:if>
													<div style="display: flex; margin-bottom: 1px;">
													<c:set var="currentRow" value="${seat.seatRow}" />
												</c:if>

												<!-- 좌석 출력 -->
												<c:set var="color" value="skyblue" />
												<c:if test="${seat.seatGrade == 0}">
													<c:set var="color" value="mediumpurple" />
												</c:if>
												<c:if test="${seat.seatGrade == 1}">
													<c:set var="color" value="green" />
												</c:if>

												<div style="font-size: 1rem; width: 18px; height: 18px; line-height: 15px; text-align: center; color: ${color}; cursor: pointer; "
													 onclick="selectSeat('${seat.seatNo}','${seat.seatGrade}','${seat.seatFloor}','${seat.seatSection}','${seat.seatRow}','${seat.seatDetailNo}')" 
													 id="${seat.seatNo}">■</div>
											</c:if>
										</c:forEach>

										<c:if test="${currentRow != ''}">
											</div> <!-- 마지막 row 닫기 -->
										</c:if>
									</div> <!-- 구역 박스 닫기 -->
								</c:if>
								<div id="jh${i}${j}" style="display:inline-block;width:0;padding:0;margin:0;"></div>
							</c:forEach>
						</div>
					</c:forEach>
				</c:forEach>

                </div>

                <!-- 오른쪽 영역 -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 10px; padding-left: 10px;">
                    <div style="text-align: center; padding: 30px;">
						가격정보 ${tkDetailVOList}
					</div>
                    <div style="text-align: center; padding: 30px;" id="checkDiv">
						좌석확인<br/>
						<a id="ckeckSeat"></a>
					</div> 
                    <div style="text-align: center; padding: 30px;">
						<button type="button" class="btn btn-primary">결제하기</button>
					</div>
                </div>
            </div>
        </div>
    </div>

<script>
<!-- 콘솔 위치 표시 (임시) -->
const jhBox = document.querySelector("#jh30");
if (jhBox) {
	jhBox.style = "width:370px; text-align:center; border:1px solid gray";
	jhBox.innerText = "CONSOL";
}
	function selectSeat(seatNo, seatGrade, seatFloor, seatSection, seatRow, seatDetailNo ){
		// alert("선택한 좌석: "+seatNo);
		console.log(" : "+seatNo+" : "+ seatGrade+" : "+ seatFloor+" : "+ seatSection+" : "+ seatRow+" : "+ seatDetailNo)
		

		const ckeckSeat= document.querySelector("#ckeckSeat");
		ckeckSeat.innerText+=seatFloor+'F '+seatSection+'구역 '+seatRow+'열 '+seatDetailNo+'\n';

		const selectedSeat =document.getElementById(seatNo);
		selectedSeat.style.cssText += "box-shadow: inset 0 0 0 5px black; font-size: 0.8rem;";
		
	}
</script>
	
</body>

</html>
