<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="/shop/main.css" />
<link href="/bootstrap-5.3.3-dist/icon/bootstrap-icons.css" rel="stylesheet">
<title>Insert title here</title>
</head>
<style type="text/css">
html, body {
  height: 100%;
  margin: 0;
}

.wrapper {
  min-height: 100%;
  display: flex;
  flex-direction: column;
}

.content {
  flex: 1;
}

footer {
  height: 80px; /* 원하는 푸터 높이 */
  background-color: #f8f9fa;
}

/* 수량 조정 영역 스타일 */
.input-group input[type="button"] {
  width: 40px;
}

.input-group input[type="text"] {
  width: 60px;
}
</style>

<body>

  <div class="wrapper">

    <%@ include file="../../shopHeader.jsp" %>
	
    <!-- ✅ content 시작 -->
    <div class="content">
      <!-- Title -->
      <div class="d-flex justify-content-center">
        <div class="card card-header-container col-8">
          <h3 class="mt-5">장바구니</h3>
        </div>
      </div>

      <div class="container mt-5">
        <div class="card col-10">
          <!-- card-header -->
          <div class="card-header">
	        <div class="d-flex justify-content-between align-items-center">
		    <span><input class="form-check-input me-2" type="checkbox" checked>전체</span>
		    <input type="button" value="삭제" class="btn btn-outline-danger btn-sm">
		  	</div>
    	  </div>
          
          <!-- card-body -->
          <c:set var="gramt" value="0"/>
          <c:forEach var="cartVO" items="${cartList}" step="1">
          	<c:set var="gramt" value="${gramt + cartVO.amount}" />
            <div class="card-body">
              <input type="hidden" name="gdsNo" value="${cartVO.gdsNo}" />
              <input type="text" name="unitPrice" value="${cartVO.goodsVO.unitPrice}" />
              <div class="d-flex justify-content-between align-items-center p-3">
                <!-- 왼쪽: 체크박스 + 이미지 + 제품 정보 -->
		        <div class="d-flex align-items-center">
		          <input class="form-check-input me-3" type="checkbox" checked>
		          <img src="/upload/${cartVO.goodsVO.fileGroupVO.fileDetailVOList[0].fileSaveLocate}" class="img-thumbnail" style="width: 80px; height: 80px;" alt="상품이미지">
		          <div class="ms-3">
		            <div class="fw-bold">${cartVO.goodsVO.gdsNm}</div>
		              <div class="input-group mt-2" style="width: 130px;">
		                <button class="btn btn-light border disabled" >-</button>
		                <input type="text" class="form-control text-center" value="${cartVO.qty}">
		                <button class="btn btn-light border">+</button>
		              </div>
		          </div>
		        </div>
		      
		        <!-- 오른쪽: 금액 + X버튼 -->
		        <div class="d-flex flex-column align-items-end">
		          <div class="fw-bold mb-2">
		            <span>₩<fmt:formatNumber value="${cartVO.amount}" pattern="#,###" /></span>
		            <button class="btn btn-link close-btn p-0">
		              <i class="bi bi-x fs-4"></i>
		            </button>
		          </div>
		        </div>
              </div>
            <hr>
            </div>
          </c:forEach>
          
          <!-- card-footer -->
          <div class="card-footer bg-white border-0">
		    <div class="d-flex justify-content-between align-items-center px-3 py-2">
		      <div class="fw-bold">
		        총 ₩<fmt:formatNumber value="${gramt}" pattern="#,###" />
		      </div>
		      <button class="btn btn-primary">${cartList.size()}개 상품 결제 진행</button>
		    </div>
		  </div>
        </div>
      </div>
    </div>
    <!-- ✅ content 끝 -->

    <%@ include file="../../shopfooter.jsp" %>
  </div>
</body>

<script type="text/javascript">

$('.btn.btn-light.border').on('click', function(){
	
	let $quantity = $(this).closest('div').find('input');
	let op = $(this).text();
	
	console.log($quantity.val());
	
	if(op === '+'){
		changeQty($quantity, 1);
	}
	
	else if(op === '-'){
		changeQty($quantity, -1);
	}
})



//수량 변경 함수
const changeQty = ($quantity, qty) => {
	//현재 수량 가져오기
	let currentQuantity = parseInt($quantity.val());
	
	//클릭한 버튼값에 따라 수량변경
	currentQuantity += qty;
	
	//변경된 수량을 input 필드에 반영
	$quantity.val(currentQuantity);
	
	// 수량이 1일 경우 - 감소 버튼 비활성화
	if (currentQuantity === 1) {
		$quantity.prev().addClass("disabled");
	} else {
		$quantity.prev().removeClass("disabled");
	}
	
	let unitPrice = $quantity.closest('.card-body').find('input').eq(1).val();
	
	console.log("unitPrice * currentQuantity" + unitPrice * currentQuantity);
	
	//가격 계산하기
	let amount = unitPrice * currentQuantity;
	amount = amount.toLocaleString();
	$quantity.closest('.card-body').find('i').closest('div').find('span').text("₩" + amount);
	
	/*
	
	// 가격 계산하기
	let amount = currentQuantity * 1;
	
	//가격 저장하기
	$("input[name='goodsVOList[0].amount']").val(amount);
	$("input[name='goodsVOList[0].gramt']").val(amount);
	
	// 가격을 세자리마다 쉼표 추가하여 포맷팅
	amount = amount.toLocaleString();

	// 가격을 화면에 반영
	$("#amount").text("₩" + amount);
	*/
	
	
}

$('.btn.btn-link.close-btn').on('click', function(){
	
	let gdsNo = $(this).closest('.card-body').find('input').eq(0).val();
	
	fetch('/shop/cart/delete', {
		method: "post",
		headers: {
			"Content-Type": "application/json;charset=UTF-8",
		},
		body: JSON.stringify(gdsNo)
	}).then( (resp) => {
		resp.text().then( (rslt) => {
			console.log(rslt);
			
			if(rslt == "success") {
				$(this).closest('.card-body').remove();
			}else {
				alert("상품 삭제를 실패했습니다.");
			}
		})
	})
});

</script>

</html>