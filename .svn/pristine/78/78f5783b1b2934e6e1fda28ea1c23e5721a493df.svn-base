<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.home.alarm.mapper.AlarmMapper">

	<update id="savePersonalStng">
		UPDATE noti_stng
		SET		
			bd_stng_yn =#{bdStngYn}
			, lp_stng_yn =#{lpStngYn}
			, lv_stng_yn =#{lvStngYn}
			, lk_stng_yn =#{lkStngYn}
			, me_stng_yn =#{meStngYn}
		WHERE com_profile_no = #{comProfileNo}
	</update>

	<select id="personalStng" parameterType="int" resultType="com.ohot.home.alarm.vo.NotiStngVO">
		SELECT 
				com_profile_no
				, mem_no
				, bd_stng_yn
				, lp_stng_yn
				, lv_stng_yn
				, lk_stng_yn
				, me_stng_yn
				, art_group_no
		  FROM noti_stng
		 WHERE com_profile_no =#{comProfileNo}
 	</select>

	<insert id="alarmReply" parameterType="com.ohot.home.community.vo.CommunityReplyVO">
		INSERT INTO NOTIFICATION(
								NOTI_NO
								, NOTI_DT
								, NOTI_SNDR_NO
								, NOTI_RCVR_NO
								, NOTI_CN
								, NOTI_ORG_NO
								, NOTI_ORG_TB
		)
		
		SELECT 
				NOTIFICATION_SEQ.NEXTVAL
				,SYSDATE
				,#{artGroupNo}
				,mem_no
				,('üí≠ '||#{comNm}||'ÎãòÏù¥ ['||SUBSTR(#{replyContent}, 1, 10)||'...] ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌñàÏäµÎãàÎã§')
				,#{boardNo}
				,'COMMUNITY_REPLY'
		 FROM  NOTI_STNG 
		 WHERE art_group_no = #{artGroupNo}
		 AND lp_stng_yn ='Y'
	</insert>

	<insert id="alarmComPost" parameterType="com.ohot.home.community.vo.CommunityPostVO">
		<selectKey resultType="int" order="BEFORE" keyProperty="notiNo">
				SELECT NVL(MAX(NOTI_NO),0)+1 FROM NOTIFICATION
		</selectKey>
		INSERT INTO NOTIFICATION(
								NOTI_NO
								, NOTI_DT
								, NOTI_SNDR_NO
								, NOTI_RCVR_NO
								, NOTI_CN
								, NOTI_ORG_NO
								, NOTI_ORG_TB
		)
		
		SELECT 
				NOTIFICATION_SEQ.NEXTVAL
				,SYSDATE
				,#{artGroupNo}
				,mem_no
				,('üìù '||#{comNm}||'ÎãòÏù¥ ['||SUBSTR(#{boardTitle}, 1, 10)||'...] Ìè¨Ïä§Ìä∏Î•º Îì±Î°ùÌñàÏäµÎãàÎã§')
				,#{boardNo}
				,'COMMUNITY_POST'
		 FROM  NOTI_STNG 
		 WHERE art_group_no = #{artGroupNo}
		 AND bd_stng_yn ='Y'
	</insert>

	<select id="registeredGroupList" parameterType="int" resultType="com.ohot.vo.ArtistGroupVO">
		SELECT
		    	art_group_no,
		    	art_group_nm
                
		FROM artist_group ag
		WHERE 1=1
		AND art_group_no >=1
		AND art_group_del_yn='N'
		AND art_group_no IN (
						        SELECT cp.art_group_no
						        FROM community_profile cp
						        WHERE cp.mem_no = #{memNo}
						        AND cp.com_delyn='N'
						        AND cp.com_auth = 'ROLE_MEM'
						    )
		ORDER BY art_group_nm
	</select>
	
	<select id="alarmDetailList" resultType="com.ohot.home.alarm.vo.NotificationVO">
		SELECT
			    noti_no,
			    TO_CHAR(noti_dt, 'YYYY-MM-DD HH24:MI:SS') AS noti_dt,
			    noti_sndr_no,
			    noti_rcvr_no,
			    noti_cn,
			    noti_org_no,
			    noti_org_tb,
			    (
		        SELECT file_save_locate
		        FROM (
		            SELECT fd.file_save_locate
		            FROM file_detail fd
		            JOIN artist_group a ON fd.file_group_no = a.file_group_no
		            WHERE a.art_group_no = n.noti_sndr_no
		            ORDER BY fd.file_sn DESC
		        )
		        WHERE ROWNUM = 1
		    ) AS file_save_locate
		FROM notification n
		WHERE 1=1
		AND noti_rcvr_no = #{memNo}
		AND noti_dt >= SYSDATE -3
		<if test="artGroupNo !=0 and artGroupNo !='' and artGroupNo !=null">
			AND noti_sndr_no = #{artGroupNo}
		</if>
		ORDER BY noti_dt DESC
		FETCH FIRST 20 ROWS ONLY
	</select>

</mapper>