package com.ohot.employee.controller;

import java.sql.ResultSet;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.json.JSONArray;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ohot.employee.service.EmployeeService;
import com.ohot.employee.vo.DepartmentVO;
import com.ohot.vo.EmployeeVO;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/emp")
public class EmployeeController {
	
	@Autowired
	EmployeeService employeeService;
	
	@GetMapping("/home")
	public String home(){
		return "employee/home";
	}
	
	@GetMapping("/treeList")
	public String treeList() {
		
		return "employee/tree";
	}
	
	@ResponseBody
	@GetMapping("/treeListAjax")
	public String treeListAjax(){
		
		List<DepartmentVO> treeList = this.employeeService.treeList();
		
		
		JSONArray jsonArray = new JSONArray();
		Set<String> deptSet = new HashSet<>();
		
		for(DepartmentVO row : treeList) {
			String deptNo = String.valueOf(row.getDeptNo());
			String upDept = (row.getUpDept() == 0) ? "#" : String.valueOf(row.getUpDept());
			String deptNm = row.getDeptNm();
			
			// json  import org.json.JSONArray; import org.json.JSONObject; 사용!
			if(!deptSet.contains(deptNo)) {
				JSONObject deptNode = new JSONObject();
				deptNode.put("id", deptNo);
				deptNode.put("parent", upDept);
				deptNode.put("text", deptNm != null ? deptNm : "(이름없음)");
				deptNode.put("icon", "glyphicon glyphicon-folder-open");
				jsonArray.put(deptNode);
				deptSet.add(deptNo);
			}
			
			//사원정보 추가
			List<EmployeeVO> empList = row.getEmployeeVOList();
			
			if(empList != null) {
				
				for(EmployeeVO emp : empList) {
					
					String empNo = String.valueOf(emp.getEmpNo());
					String empNm = emp.getEmpNm();
					
					JSONObject empNode = new JSONObject();
					empNode.put("id", empNo);
					empNode.put("parent", deptNo);
					empNode.put("text", empNm);
					empNode.put("icon", "glyphicon glyphicon-user");
					
					
					JSONObject data = new JSONObject();
					String empEmail = emp.getEmpEmlAddr();
					String position = emp.getJbgdCd();
					
					data.put("email", empEmail);
					data.put("position", position);
					
					empNode.put("data", data);
					
					jsonArray.put(empNode);
				}
			}
		}
		log.info("jsonArray : " +jsonArray.toString());
		
		return jsonArray.toString();
	}
	
}
