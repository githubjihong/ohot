<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.employee.mapper.EmployeeMapper">

	<resultMap type="com.ohot.vo.EmployeeVO" id="employeeMap">
		<result property="enabled" column="ENABLED"/>
		<result property="snsEmpYn" column="SNS_EMP_YN"/>
		<result property="empNo" column="EMP_NO"/>
		<result property="empPswd" column="EMP_PSWD"/>
		<result property="empNm" column="EMP_NM"/>
		<result property="empRrno" column="EMP_RRNO"/>
		<result property="empBrdt" column="EMP_BRDT"/>
		<result property="empTelno" column="EMP_TELNO"/>
		<result property="empEmlAddr" column="EMP_EML_ADDR"/>
		<result property="jncmpYmd" column="JNCMP_YMD"/>
		<result property="rsgntnYmd" column="RSGNTN_YMD"/>
		<result property="empZip" column="EMP_ZIP"/>
		<result property="empAddr" column="EMP_ADDR"/>
		<result property="empDaddr" column="EMP_DADDR"/>
		<result property="offcsPhoto" column="OFFCS_PHOTO"/>
		<result property="jbgdCd" column="JBGD_CD"/>
		<result property="sexdtnCd" column="SEXDTN_CD"/>
		<result property="deptNo" column="DEPT_NO"/>
		<result property="empStngYn" column="EMP_STNG_YN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="stampFileGroupNo" column="STAMP_FILE_GROUP_NO"/>
		<result property="position" column="POSITION" />
		<result property="profileSaveLocate" column="PROFILE_SAVE_LOCATE" />
		<collection property="atrzDocVOList" resultMap="atrzDocMap"></collection>
		<collection property="atrzLineVOList" resultMap="atrzLineMap"></collection>
		<collection property="atrzRefVOList" resultMap="atrzRefMap"></collection>
	</resultMap>

	<resultMap type="com.ohot.employee.vo.DepartmentVO" id="departmentMap">
		<result property="rnum" column="RNUM"/>
		<result property="deptNo" column="DEPT_NO"/>
		<result property="deptNm" column="DEPT_NM"/>
		<result property="upDept" column="UP_DEPT"/>
		<result property="deptSn" column="DEPT_SN"/>
		<result property="crtYmd" column="CRT_YMD"/>
		<collection property="employeeVOList" resultMap="employeeMap"></collection>
	</resultMap>
	
	<resultMap type="com.ohot.employee.vo.AtrzDocVO" id="atrzDocMap">
		<result property="atrzDocNo" column="ATRZ_DOC_NO"/>
		<result property="docFmNo" column="DOC_FM_NO"/>
		<result property="drftTtl" column="DRFT_TTL"/>
		<result property="drftCn" column="DRFT_CN"/>
		<result property="emrgYn" column="EMRG_YN"/>
		<result property="drftYmd" column="DRFT_YMD"/>
		<result property="ddlnYmd" column="DDLN_YMD"/>
		<result property="drftEmpNo" column="DRFT_EMP_NO"/>
		<result property="offcsPhoto" column="OFFCS_PHOTO"/>
		<result property="drftJbgdCd" column="DRFT_JBGD_CD"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="drftStampFileGroupNo" column="DRFT_STAMP_FILE_GROUP_NO"/>
		<result property="atrzSttsCd" column="ATRZ_STTS_CD"/>
		<result property="atrzLnSttsCd" column="ATRZ_LN_STTS_CD"/>
		<result property="drftStampFileSaveLocate" column="DRFT_STAMP_FILE_SAVE_LOCATE"/>
		<result property="drftDt" column="DRFT_DT"/>
		<association property="approvedConcertPlanVO" resultMap="approvedConcertPlanMap"></association>
		<collection property="atrzRefVOList" resultMap="atrzRefMap"></collection>
		<collection property="atrzLineVOList" resultMap="atrzLineMap"></collection>
	</resultMap>
	
	<resultMap type="com.ohot.employee.vo.AtrzLineVO" id="atrzLineMap">
		<result property="aprvrStampFileGroupNo" column="APRVR_STAMP_FILE_GROUP_NO"/>
		<result property="atrzLnNo" column="ATRZ_LN_NO"/>
		<result property="atrzDocNo" column="ATRZ_DOC_NO"/>
		<result property="atrzEmpNo" column="ATRZ_EMP_NO"/>
		<result property="atrzLnSttsCd" column="ATRZ_LN_STTS_CD"/>
		<result property="atrzOpnn" column="ATRZ_OPNN"/>
		<result property="rjctRsn" column="RJCT_RSN"/>
		<result property="atrzDt" column="ATRZ_DT"/>
		<result property="atrzSn" column="ATRZ_SN"/>
		<result property="aprvrJbgdCd" column="APRVR_JBGD_CD"/>
		<result property="aprvrOffcsPhoto" column="APRVR_OFFCS_PHOTO"/>
		<result property="lastAtrzYn" column="LAST_ATRZ_YN"/>
		<result property="aprvrStampFileSaveLocate" column="APRVR_STAMP_FILE_SAVE_LOCATE"/>
	</resultMap>
	
	<resultMap type="com.ohot.employee.vo.AtrzRefVO" id="atrzRefMap">
		<result property="atrzRefNo" column="ATRZ_REF_NO"/>
		<result property="refEmpNo" column="REF_EMP_NO"/>
		<result property="atrzDocNo" column="ATRZ_DOC_NO"/>
		<result property="atrzIdntyYn" column="ATRZ_IDNTY_YN"/>
		<result property="refJbgdCd" column="REF_JBGD_CD"/>
	</resultMap>

	<resultMap type="com.ohot.employee.vo.ApprovedConcertPlanVO" id="approvedConcertPlanMap">
		<result property="conPlanNo" column="CON_PLAN_NO"/>
		<result property="atrzDocNo" column="ATRZ_DOC_NO"/>
		<result property="gdsNm" column="GDS_NM"/>
		<result property="tkCtgr" column="TK_CTGR"/>
		<result property="tkLctn" column="TK_LCTN"/>
		<result property="playerNm" column="PLAYER_NM"/>
		<result property="hostOrg" column="HOST_ORG"/>
		<result property="expectedAudience" column="EXPECTED_AUDIENCE"/>
		<result property="expectedBudget" column="EXPECTED_BUDGET"/>
		<result property="background" column="BACKGROUND"/>
		<result property="requests" column="REQUESTS"/>
		<result property="remarks" column="REMARKS"/>
		<result property="regYmd" column="REG_YMD"/>
	</resultMap>

	<select id="treeList" resultMap="departmentMap">
		/*com.ohot.employee.mapper.EmployeeMapper.treeList*/
		SELECT 
		        e.emp_no
		        , e.emp_nm
		        , e.emp_eml_addr
		        , FN_CODE_NO_TO_CODE_NM(e.jbgd_cd) AS position
		        , e.jbgd_cd
		        , e.jncmp_ymd
		        , d.dept_no
		        , d.dept_nm
		        , d.up_dept
		        , d.dept_sn
		        ,( 
		       	  SELECT fd.file_save_locate
		       	    FROM file_detail fd
		       	   WHERE fd.file_group_no = e.file_group_no
		       	) AS profile_save_locate 
		  FROM employee e
		  LEFT OUTER JOIN department d ON(e.dept_no = d.dept_no)
		 WHERE e.rsgntn_ymd IS NULL
	</select>
	
	<select id="atrzDocSelectKey" resultType="String" parameterType="com.ohot.employee.vo.AtrzDocVO">
		/*com.ohot.employee.mapper.EmployeeMapper.atrzDocSelectKey*/
		SELECT 
		       #{prefix} || '-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' ||
		       LPAD(NVL(TO_NUMBER(SUBSTR(MAX(ATRZ_DOC_NO), -3)), 0)+1,3,'0') AS ATRZ_DOC_NO
		  FROM ATRZ_DOC
		 WHERE SUBSTR(ATRZ_DOC_NO, 5, 8) = TO_CHAR(SYSDATE, 'YYYYMMDD')
		   AND ATRZ_DOC_NO LIKE #{prefix} || '-%'
	</select>
	
	<insert id="atrzDocInsert" parameterType="com.ohot.employee.vo.AtrzDocVO" >
		/*com.ohot.employee.mapper.EmployeeMapper.atrzDocInsert*/
		INSERT INTO atrz_doc(
								atrz_doc_no
								, doc_fm_no
								, drft_ttl
								, drft_cn
								, emrg_yn
								, drft_ymd
								<if test="ddlnYmd != null and ddlnYmd != ''">
									, ddln_ymd
								</if>
								, drft_emp_no
								, drft_jbgd_cd
								<if test="fileGroupNo != null and fileGroupNo !=''">
									, file_group_no
								</if>
								<if test="drftStampFileGroupNo != null and drftStampFileGroupNo != ''">
									, drft_stamp_file_group_no
								</if>
								, atrz_stts_cd
								, atrz_ln_stts_cd
							)  
		 VALUES (
				  #{atrzDocNo}
				  , #{docFmNo}
				  , #{drftTtl}
				  , #{drftCn}
				  , #{emrgYn}
				  , SYSDATE
				  <if test="ddlnYmd != null and ddlnYmd != ''">
					  , #{ddlnYmd}
				  </if>
				  , #{drftEmpNo}
				  , #{drftJbgdCd}
				  <if test="fileGroupNo !=null and fileGroupNo !=''">
					  , #{fileGroupNo}
				  </if>
				  <if test="drftStampFileGroupNo!=null and drftStampFileGroupNo != ''">
					  , #{drftStampFileGroupNo}
				  </if>
				  , 'APR01'
				  , 'DRAFTED'
			    )
	
	</insert>
	
	<insert id="atrzLineInsert" parameterType="com.ohot.employee.vo.AtrzLineVO">
		/*com.ohot.employee.mapper.EmployeeMapper.atrzLineInsert*/
		<selectKey resultType="int" order="BEFORE" keyProperty="atrzLnNo">
			SELECT NVL(MAX(atrz_ln_no), 0) + 1 FROM atrz_line
		</selectKey>
		INSERT
		  INTO atrz_line(
		  				  atrz_ln_no
		  				  , atrz_doc_no
		  				  , atrz_emp_no
		  				  , atrz_ln_stts_cd
		  				  <if test="atrzOpnn!=null and atrzOpnn !=''">
		  				  	, atrz_opnn
		  				  </if>
		  				  <if test="rjctRsn != null and rjctRsn !=''">
		  				  	, rjct_rsn
		  				  </if>
		  				  , atrz_sn
		  				  , aprvr_jbgd_cd
		  				  , last_atrz_yn
		  				  <if test="aprvrStampFileGroupNo != null and aprvrStampFileGroupNo !=''">
		  				  	, aprvr_stamp_file_group_no
		  				  </if>
		  				)
		 VALUES (
		 		  #{atrzLnNo}
		  		  , #{atrzDocNo}
		  		  , #{atrzEmpNo}
		  		  , 'WAIT'
		  		  <if test="atrzOpnn!=null and atrzOpnn !=''">
		  		  	, #{atrzOpnn}
		  		  </if>
		  		  <if test="rjctRsn != null and rjctRsn !=''">
		  		  	, #{rjctRsn}
		  		  </if>
		  		  , #{atrzSn}
		  		  , #{aprvrJbgdCd}
		  		  , 'N'
		  		  <if test="aprvrStampFileGroupNo != null and aprvrStampFileGroupNo !=''">
		  		  	, #{aprvrStampFileGroupNo}
		  		  </if>
		 		)
		  				
	</insert>

	<insert id="atrzRefInsert" parameterType="com.ohot.employee.vo.AtrzRefVO">
		/*com.ohot.employee.mapper.EmployeeMapper.atrzLineInsert*/
		<selectKey resultType="int" order="BEFORE" keyProperty="atrzRefNo">
			SELECT NVL(MAX(atrz_ref_no), 0) + 1 FROM atrz_ref
		</selectKey>
		INSERT
		  INTO atrz_ref(
		  				 atrz_ref_no
		  				 , ref_emp_no
		  				 , atrz_doc_no
		  				 , atrz_idnty_yn
		  				 , ref_jbgd_cd
		  				)
		VALUES (
				 #{atrzRefNo}
			  	 , #{refEmpNo}
			  	 , #{atrzDocNo}
			  	 , 'N'
			  	 , #{refJbgdCd}
				)
		
	</insert>

	<insert id="approvedConcertPlanInsert" parameterType="com.ohot.employee.vo.ApprovedConcertPlanVO">
		/*com.ohot.employee.mapper.EmployeeMapper.approvedConcertPlanInsert*/
		<selectKey resultType="int" order="BEFORE" keyProperty="conPlanNo">
			SELECT NVL(MAX(con_plan_no),0)+1 FROM approved_concert_plan
		</selectKey>
		INSERT 
		  INTO approved_concert_plan(
		  								con_plan_no
		  								, atrz_doc_no
		  								, gds_nm
		  								, tk_ctgr
		  								, tk_lctn
		  								, player_nm
		  								, host_org
		  								, expected_audience
		  								, expected_budget
		  								, background
		  								<if test="requests != null and requests != ''">
		  								, requests
		  								</if>
		  								<if test="remarks != null and remarks != ''">
		  								, remarks
		  								</if>
		  								, reg_ymd
									 )
		VALUES (
				  #{conPlanNo}
				  , #{atrzDocNo}
				  , #{gdsNm}
				  , #{tkCtgr}
				  , #{tkLctn}
				  , #{playerNm}
				  , #{hostOrg}
				  , #{expectedAudience}
				  , #{expectedBudget}
				  , #{background}
				  <if test="requests != null and requests != ''">
				  , #{requests}
				  </if>
				  <if test="remarks != null and remarks != ''">
				  , #{remarks}
				  </if>
				  , SYSDATE
				)								
	</insert>
	
	<!-- 부서, 사원, 결재문서, 직인파일 조인  -->
	<select id="atrzDocDetail" parameterType="String" resultMap="departmentMap">
		/*com.ohot.employee.mapper.EmployeeMapper.atrzDocDetail*/
		SELECT 
		       d.dept_no
		       , d.dept_nm
		       , e.emp_no
		       , e.emp_nm
		       , FN_CODE_NO_TO_CODE_NM(e.jbgd_cd) AS position
		       , e.jbgd_cd
		       ,( 
		       	  SELECT fd.file_save_locate
		       	    FROM file_detail fd
		       	   WHERE fd.file_group_no = e.file_group_no
		       	) AS profile_save_locate 
		       , ad.atrz_doc_no
		       , ad.doc_fm_no
		       , ad.drft_ttl
		       , ad.emrg_yn
		       , TO_CHAR(ad.drft_ymd, 'YYYY-MM-DD') AS drft_ymd
		       , TO_CHAR(ad.drft_ymd, 'YYYY-MM-DD HH24:MI') AS drft_dt
		       , ad.ddln_ymd
		       , ad.drft_emp_no
		       ,( 
		       	  SELECT fd.file_save_locate
		       	    FROM file_detail fd
		       	   WHERE fd.file_group_no = ad.drft_stamp_file_group_no
		       	) AS drft_stamp_file_save_locate
		       , FN_CODE_NO_TO_CODE_NM(ad.drft_jbgd_cd) AS drft_jbgd_cd
		       , ad.drft_stamp_file_group_no
		       , FN_CODE_NO_TO_CODE_NM(ad.atrz_stts_cd) AS atrz_stts_cd
		       , FN_CODE_NO_TO_CODE_NM(ad.atrz_ln_stts_cd) AS atrz_ln_stts_cd
		       , fg.file_regdate
		       , fd.file_sn
		       , fd.file_original_name
		       , fd.file_save_name
		       , fd.file_save_locate
		  FROM department d  
		  LEFT OUTER JOIN employee e ON(d.dept_no = e.dept_no)
		  LEFT OUTER JOIN atrz_doc ad ON(e.emp_no = ad.drft_emp_no)
		  LEFT OUTER JOIN file_group fg ON(ad.drft_stamp_file_group_no = fg.file_group_no)
		  LEFT OUTER JOIN (
			                 SELECT 
			                       file_sn
			                       , file_group_no
			                       , file_original_name
			                       , file_save_name
			                       , file_save_locate
			                       , file_size
			                       , file_ext
			                       , file_mime
			                       , file_fancysize
			                       , file_save_date
			                       , file_downcount
			                       , ROW_NUMBER() OVER (PARTITION BY file_group_no ORDER BY file_sn DESC) AS RN
			                   FROM file_detail
			          ) FD ON fg.file_group_no = fd.file_group_no AND FD.RN = 1
		 WHERE ad.atrz_doc_no = #{atrzDocNo}
	</select>
	
	<!-- 부서, 사원, 결재참조 -->
	<select id="atrzRefDetail" parameterType="String" resultMap="departmentMap">
		/*com.ohot.employee.mapper.EmployeeMapper.atrzRefDetail*/
		SELECT 
		       d.dept_no
		       , d.dept_nm
		       , e.emp_no
		       , e.emp_nm
		       , e.jbgd_cd
		       , ar.atrz_ref_no
		       , ar.ref_emp_no
		       , ar.atrz_doc_no
		       , ar.atrz_idnty_yn
		       , FN_CODE_NO_TO_CODE_NM(ar.ref_jbgd_cd) AS ref_jbgd_cd
		  FROM DEPARTMENT d  
		  LEFT OUTER JOIN EMPLOYEE e ON(d.dept_no = e.dept_no)
		  LEFT OUTER JOIN atrz_ref ar ON(e.emp_no = ar.ref_emp_no)
		 WHERE ar.atrz_doc_no = #{atrzDocNo}
	</select>

	<!-- 부서, 사원, 결재선, 직인파일 조인  -->
	<select id="atrzLineDetail" parameterType="String" resultMap="departmentMap">
		/*com.ohot.employee.mapper.EmployeeMapper.atrzLineDetail*/
		SELECT 
		       d.dept_no
		       , d.dept_nm
		       , e.emp_no
		       , e.emp_nm
		       , FN_CODE_NO_TO_CODE_NM(e.jbgd_cd) AS jbgd_cd
		       ,( 
		       	  SELECT fd.file_save_locate
		       	    FROM file_detail fd
		       	   WHERE fd.file_group_no = e.file_group_no
		       	) AS profile_save_locate 
		       , al.atrz_ln_no
		       , al.atrz_doc_no
		       , al.atrz_emp_no
		       , FN_CODE_NO_TO_CODE_NM(al.atrz_ln_stts_cd) AS atrz_ln_stts_cd
		       , al.atrz_opnn
		       , al.rjct_rsn
		       , al.atrz_dt
		       , al.atrz_sn
		       , FN_CODE_NO_TO_CODE_NM(al.aprvr_jbgd_cd) AS aprvr_jbgd_cd
		       , al.last_atrz_yn
		       , al.aprvr_stamp_file_group_no
		       ,( 
		       	  SELECT fd.file_save_locate
		       	    FROM file_detail fd
		       	   WHERE fd.file_group_no = al.aprvr_stamp_file_group_no
		       	) AS aprvr_stamp_file_save_locate
		       , fg.file_regdate
		       , fd.file_sn
		       , fd.file_original_name
		       , fd.file_save_name
		       , fd.file_save_locate
		  FROM DEPARTMENT d  
		  LEFT OUTER JOIN employee e ON(d.dept_no = e.dept_no)
		  LEFT OUTER JOIN atrz_line al ON(e.emp_no = al.atrz_emp_no)
		  LEFT OUTER JOIN file_group fg ON(al.aprvr_stamp_file_group_no = fg.file_group_no)
		  LEFT OUTER JOIN (
		                 SELECT 
		                       file_sn
		                       , file_group_no
		                       , file_original_name
		                       , file_save_name
		                       , file_save_locate
		                       , file_size
		                       , file_ext
		                       , file_mime
		                       , file_fancysize
		                       , file_save_date
		                       , file_downcount
		                       , ROW_NUMBER() OVER (PARTITION BY file_group_no ORDER BY file_sn DESC) AS RN
		                   FROM file_detail
		          ) FD ON fg.file_group_no = fd.file_group_no AND FD.RN = 1
		 WHERE al.atrz_doc_no = #{atrzDocNo}
	</select>

	<!-- 최종공연승인 select  -->
	<select id="aprrovedConcertPlanDetail" parameterType="String" resultType="com.ohot.employee.vo.ApprovedConcertPlanVO">
		/*com.ohot.employee.mapper.EmployeeMapper.aprrovedConcertPlanDetail*/
		SELECT
		        con_plan_no
		        , atrz_doc_no
		        , gds_nm
		        , tk_ctgr
		        , tk_lctn
		        , player_nm
		        , host_org
		        , expected_audience
		        , expected_budget
		        , background
		        , requests
		        , remarks
		        , reg_ymd
		  FROM approved_concert_plan
		 WHERE atrz_doc_no = #{atrzDocNo}
	</select>
	
	<!-- 자신이 결재자에 포함되어있으면 가져오는 결재문서리스트 -->
	<select id="atrzAllList" resultMap="departmentMap" parameterType="com.ohot.employee.vo.AtrzLineVO">
		/*com.ohot.employee.mapper.EmployeeMapper.atrzAllList*/
		SELECT 
			   ROW_NUMBER() OVER(ORDER BY ad.atrz_doc_no ASC) AS rnum
               , d.dept_no
		       , d.dept_nm
		       , e.emp_no
		       , e.emp_nm
		       , FN_CODE_NO_TO_CODE_NM(e.jbgd_cd) AS position
		       , e.jbgd_cd
		       , ad.atrz_doc_no
		       , ad.doc_fm_no
		       , ad.drft_ttl
		       , ad.emrg_yn
		       , TO_CHAR(ad.drft_ymd, 'YYYY-MM-DD HH24:MI') AS drft_dt
		       , TO_CHAR(ad.drft_ymd, 'YYYY-MM-DD') AS drft_ymd
		       , ad.ddln_ymd
		       , ad.drft_emp_no
		       , FN_CODE_NO_TO_CODE_NM(ad.drft_jbgd_cd) AS drft_jbgd_cd
		       , ad.drft_stamp_file_group_no
		       , FN_CODE_NO_TO_CODE_NM(ad.atrz_stts_cd) AS atrz_stts_cd
		       , FN_CODE_NO_TO_CODE_NM(ad.atrz_ln_stts_cd) AS atrz_ln_stts_cd
               , al.atrz_ln_no
		       , al.atrz_doc_no
		       , al.atrz_emp_no
		       , FN_CODE_NO_TO_CODE_NM(al.atrz_ln_stts_cd) AS atrz_ln_stts_cd
		       , al.atrz_opnn
		       , al.rjct_rsn
		       , al.atrz_dt
		       , al.atrz_sn
		       , FN_CODE_NO_TO_CODE_NM(al.aprvr_jbgd_cd) AS aprvr_jbgd_cd
		       , al.last_atrz_yn
		  FROM department d  
		  LEFT OUTER JOIN employee e ON(d.dept_no = e.dept_no)
		  LEFT OUTER JOIN atrz_doc ad ON(e.emp_no = ad.drft_emp_no)
          LEFT OUTER JOIN atrz_line al ON(ad.atrz_doc_no = al.atrz_doc_no)
		  WHERE al.atrz_emp_no = #{atrzEmpNo}        
	</select>
	
	<update id="atrzLineUpdate" parameterType="com.ohot.employee.vo.AtrzLineVO">
		UPDATE ATRZ_LINE
		   SET 
		   		atrz_ln_stts_cd = #{atrzLnSttsCd}
		   		<if test="atrzOpnn!=null and atrzOpnn!=''">
			   		, atrz_opnn = #{atrzOpnn}
		   		</if>
		   		<if test="rjctRsn!=null and rjctRsn!=''">
			   		, rjct_rsn = #{rjctRsn}
		   		</if>
		   		, atrz_dt = SYSDATE
		 WHERE atrz_doc_no = #{atrzDocNo}
		   AND atrz_emp_no = #{atrzEmpNo}		
	</update>
	
</mapper>