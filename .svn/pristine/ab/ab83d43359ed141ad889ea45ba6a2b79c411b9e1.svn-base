<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="/shop/main.css" />
<script src="https://js.tosspayments.com/v2/standard"></script>
<title>Insert title here</title>
</head>

<style>
html, body {
  height: 88%;  /* html과 body의 높이를 100%로 설정 */
}

</style>

<body>
	<%@ include file="../shopHeader.jsp" %>
	
	<section class="page-background">
	  <!-- Form 영역 -->
	  <form action="" class="container">
	    <div class="col-12 col-sm-9">
	      <h1 class="header-title">주문서</h1>
	    </div>
	  
	    <div class="row">
		  <!-- 왼쪽 영역 -->    
	      <div class="col-12 col-sm-9 ps-0">
	        <!-- 주문상품 -->
	        <div class="card card-container">	
	    	  <div class="card-body card-body-container">
	    	    <div class="accordion accordion-flush" id="orderAccordion">
	    		  <!-- 주문 상품 -->
	    		  <button class="accordion-button collapsed collapsed-accordion-btn" type="button" 
	    			data-bs-toggle="collapse" data-bs-target="#orderItemCollapse" aria-expanded="false" aria-controls="orderItemCollapse">
	          	  
	          	    <div class="col-2 text-start">
	                  <h5 class="card-title card-title-container">주문 상품</h5>
	                </div>
	              
	                <div class="col-10 text-end">
				      <h5 class="card-title card-title-right">
				   	    ${artistGroupVO.goodsVOList[0].gdsNm}
				      </h5>
				    </div>
				  </button>	    
					    
				  <!-- 주문상품 상세 화면 -->	    	
				  <div id="orderItemCollapse" class="accordion-collapse collapse" data-bs-parent="#orderAccordion">	      
				    <div class="accordion-body">
				      <div class="card card-container-bottom-border p-2 ">
					    <div class="row g-0">
						  <!-- 왼쪽 이미지 -->
						  <div class="col-2 text-center">
						    <img src="/upload/${artistGroupVO.goodsVOList[0].fileSavePath}" class="img-fluid rounded" alt="상품 이미지" style="width: 100px; height: 100px;">
						  </div>
						    
						  <div class="col-10">
						    <div class="card-body p-2">
						      <h5 class="card-title mb-1">${artistGroupVO.goodsVOList[0].gdsNm}</h5>
						      <p class="card-text mb-0">${artistGroupVO.goodsVOList[0].qty}개</p>
						      <p class="card-text">${artistGroupVO.goodsVOList[0].unitPrice}원</p>
						    </div>
						  </div>
						</div>
					  </div>
				    
				      <!-- 총합계 영역 -->
				      <div class="d-flex justify-content-between align-items-center mt-3">
				        <span class="fw-bold">총 상품 금액(1개)</span>
				        <span class="text-end">${artistGroupVO.goodsVOList[0].totalPrice}원</span>
				      </div>
				    </div>       
				  </div>	     
				</div>
			  </div>        
			</div>
			
			<!-- 주문자 -->
			<div class="card card-container">	
	    	  <div class="card-body card-body-container">
	    	    <div class="accordion accordion-flush" id="customerAccordion">
	    		  <!-- 주문자 -->
	    		  <button class="accordion-button collapsed collapsed-accordion-btn" type="button" 
	    			data-bs-toggle="collapse" data-bs-target="#customerCollapse" aria-expanded="false" aria-controls="customerCollapse">
	          	  
	          	    <div class="col-2 text-start">
	                  <h5 class="card-title card-title-container">주문자</h5>
	                </div>
	              
	                <div class="col-10 text-end">
				      <h5 class="card-title card-title-right">
				   	    ${memberVO.memFirstName} ${memberVO.memLastName}, ${memberVO.memEmail} 
  				      </h5>
				    </div>
				  </button>	    
					    
				  <!-- 주문자 상세 화면 -->	    	
				  <div id="customerCollapse" class="accordion-collapse collapse" data-bs-parent="#customerAccordion">
				    <div class="accordion-body">
			         <!-- 주문자 정보 영역 -->
					  <div class="d-flex justify-content-between align-items-center mt-3">
					    <div class="d-flex flex-column">
						  <span class="fw-bold">${memberVO.memFirstName} ${memberVO.memLastName}</span>
						  <span>${memberVO.memEmail}</span>
						  <span>${memberVO.memTelno}</span>
						</div>
						<div class="d-flex flex-column align-items-end">
						  <button class="btn btn-primary mt-2">변경</button>
						</div>
					  </div>
				    </div>
				  </div>
				</div>
			  </div>        
			</div>
			
			<!-- 결제UI -->
			<div class="card card-container">	
	    	  <div class="card-body card-body-container">
	    	    <div class="accordion accordion-flush">
	    		  <!-- 결제수단 -->
	    		  <div class="accordion-button collapsed collapsed-accordion-btn col-2 text-start">
	                <h5 class="card-title card-title-container">결제수단</h5>
	              </div>
	              
	              <div class="accordion-body">
	                <div id="payment-method"></div>
				  </div>
				</div>
			  </div>        
			</div>
		  </div>
			
		  <!-- 결제금액 영역 -->
		  <div class="col-12 col-sm-3 ps-0">
		    <div class="card card-container">
		      <div class="card-header card-header-container">결제 금액</div>
		      
		      <div class="card-body">
		        <div class="d-flex justify-content-between">
    			  <span class="fw-bold">상품 금액 : </span>
    			  <span class="text-end">₩${artistGroupVO.goodsVOList[0].totalPrice}</span>
    			  <hr>
  				</div>
  				<div class="d-flex justify-content-between">
    			  <span class="fw-bold">총 결제 금액 : </span>
    			  <span class="text-end">₩${artistGroupVO.goodsVOList[0].totalPrice}</span>
  				</div>
  				
  				<div class="text-wrap" id="agreement" >
  				  
  				</div>
  				
  				<button type="button" class="btn btn-primary w-100" id="payment-button">
        		  동의 후 ₩${artistGroupVO.goodsVOList[0].totalPrice} 결제
      			</button>
		      </div>
		    </div>
		  </div>
		</div>
	  </form>
	</section>
	  	
	<%@ include file="../shopfooter.jsp" %>
</body>

<!-- JS 영역 -->
<script>
$(function(){
  main();
});

async function main() {
  const payMentBtn = $("#payment-button");
  
  //------  결제위젯 초기화 ------
  const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
  const tossPayments = TossPayments(clientKey);
  
  // 회원 결제
  const customerKey = "H57frYJIlpWdgTeb0IqwG";
  const widgets = tossPayments.widgets({
    customerKey,
  });
  
  //------ 주문의 결제 금액 설정 ------
  await widgets.setAmount({
    currency: "KRW",
    value: ${artistGroupVO.goodsVOList[0].totalPrice},
  });
  
  await Promise.all([
    // ------  결제 UI 렌더링 ------
    widgets.renderPaymentMethods({
	  selector: "#payment-method",
	  variantKey: "DEFAULT",
	}),
	// ------  이용약관 UI 렌더링 ------
	  widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" }),
	]);
  
  // http://localhost:28080/payment/success?paymentType=NORMAL&orderId=X3cmhewbyeyf9a5PSdIRR&paymentKey=tgen_20250404174709KUbX5&amount=50000
  payMentBtn.on("click", async function () {
    await widgets.requestPayment({
	  orderId: `${seqGeneratorVO.uuid}`,	//Random 생성;
	  orderName: `${memberVO.memEmail}`,
	      
	  //결제가 완료 된 후 이동되는 URL 설정
	  successUrl: window.location.origin + "/payment/confirm",
	  failUrl: window.location.origin + "/payment/fail",
	}) 
  });
}
</script>
</html>