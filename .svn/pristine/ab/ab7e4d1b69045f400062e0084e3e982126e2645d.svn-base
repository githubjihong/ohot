<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title></title>
<meta name="description" content="">
<meta name="keywords" content="">
<link rel="stylesheet" href="/main/assets/css/card.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
	<!-- header.jsp 시작 -->
	<%@ include file="header.jsp"%>
	
<sec:authorize access="isAuthenticated()">
	<sec:authentication property="principal.usersVO" var="userVO" />
</sec:authorize>
${userVO}
<br>

	<input type="hidden" id="memNo" value="${userVO.userNo}"> 
	
	<!-- 전체 아티스트그룹 값 출력 -->
	<%-- 	<p>${artistGroupList}</p> --%>
	<%-- 	<p>${artistGroupList[0]}</p> --%>
	<%-- 	<p>${artistGroupList[0].fileGroupVO.fileDetailVOList[0]}</p> --%>

	<!-- 	<h3>dm List</h3> -->
	<%-- 	<div>${dmList}</div> --%>

	<!-- 	<h3>새로운 아티스트를 만나 보세요!</h3> -->
	<%-- 	<div>${newArtistGroupList}</div> --%>

	<!-- 	<h3>회원일 때 가입 리스트</h3> -->
	<%-- 	<div>${joinArtistGroupList}</div> --%>

	<!-- 	<h3>굿즈 리스트</h3> -->
	<%-- 	<div>${joinGroupGoodsList}</div> --%>

	<main class="main">
		<!-- 
		가입한 커뮤니티 리스트 (회원만)
		
		가입한 그룹 굿즈 리스트 (회원만)
		
		디엠 리스트 (회원 + 비회원)
		 
		새로운 아티스트를 만나보세요 (회원+비회원) (회원은 가입하지 않은 그룹만, 비회원은 전체)
	
	 -->

		<!-- ///// 회원 관점 시작 ///// -->
		<sec:authorize access="isAuthenticated()">
			<!-- 나의 커뮤니티 시작 -->
			<div class="grayBackground">
				<div class="container py-5">
					<h5 class="text fw-bold mb-4">나의 커뮤니티</h5>
					<div class="d-flex flex-wrap justify-content-start"
						style="gap: 16px;">
						<!-- 가입한 커뮤니티 리스트 시작 -->
						<c:forEach var="artGroup" items="${joinArtistGroupList}">
							<c:set var="groupFile"
								value="${artGroup.fileGroupVO.fileDetailVOList[0]}" />
							<form action="/oho/community/fanBoardList" method="get">
								<input type="hidden" name="artGroupNo" value="${artGroup.artGroupNo}" />
								<input type="hidden" name="memNo" value="${memNo}" />
								<button class="card-artist">
									<!-- 그룹 대표 이미지 -->
									<img src="/upload${groupFile.fileSaveLocate}" class="bg-img">
									<!-- 그룹 로고 -->
									<div class="logo-wrap">
										<img src="/images/hongdg.jpg">
									</div>
									<!-- 그룹 명 -->
									<div class="card-body">
										<h6>${artGroup.artGroupNm}</h6>
									</div>
								</button>
							</form>
						</c:forEach>
						<!-- 가입한 커뮤니티 리스트 끝 -->
					</div>
				</div>
			</div>
			<!-- 나의 커뮤니티 끝 -->
			
		<!-- 구독한 그룹의 굿즈샵 시작 -->
			<div class="container py-5">
				<h5 class="text fw-bold mb-4">Merch</h5>
				<div class="d-flex flex-wrap justify-content-start"
					style="gap: 16px;">
					<button class="card-artistNm active">전체</button>
					<c:forEach var="artGroup" items="${joinArtistGroupList}">
						<button class="card-artistNm" data-group="${artGroup.artGroupNo}">${artGroup.artGroupNm}</button>
					</c:forEach>
				</div>
			</div>
			<div class="container">
				<!-- 굿즈 리스트 시작 -->
				<div id="goodsListContainer" class="d-flex flex-wrap justify-content-center"
					style="gap: 16px;">
					<c:forEach var="goods" items="${joinGroupGoodsList}">
						<form action="/shop/artistGroup/${goods.artGroupNo}/detail/${goods.gdsNo}" method="get">
							<c:set var="goodsFile" value="${goods.fileGroupVO.fileDetailVOList[0]}" />
							<button class="card-goods">
								<!-- 굿즈 이미지 -->
								<img src="/upload${goodsFile.fileSaveLocate}" class="bg-img">
							</button>
							${goods.gdsNm}
							₩<fmt:formatNumber value="${goods.unitPrice}" type="number" />
						</form>
					</c:forEach>
				</div>
				<!-- 굿즈 리스트 끝 -->
			</div>
			<!-- 구독한 그룹의 굿즈샵 끝 -->
		</sec:authorize>
		<!-- ///// 회원 관점 끝 ///// -->



		<!-- ///// 비회원 관점 시작 ///// -->
		<!-- DM 리스트 시작-->
		<div class="container py-5">
			<h5 class="text fw-bold mb-4" style="color: black !important;">
				아티스트와 DM을 나눠 보세요!
				<button class="svg-btn">
					<svg xmlns="http://www.w3.org/2000/svg" width="27" height="27"
						fill="#33C1CF" stroke-width="2.5" class="bi bi-arrow-clockwise"
						viewBox="0 0 16 16" style="margin-left: 10px;">
					  <path fill-rule="evenodd"
							d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
					  <path
							d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466" />
					</svg>
				</button>
			</h5>
			<!-- DM 리스트 반복 시작 -->
			<c:forEach var="artGroup" items="${dmList}" varStatus="status"
				begin="0" end="6">
				<input type="hidden" value="${artGroup.artGroupNo}" />
				<!-- 그룹 번호 (PK) -->
				<c:set var="logoFile"
					value="${artGroup.fileGroupVO.fileDetailVOList[0]}" />
				<button class="btn-dmlist">
					<!-- 그룹 로고 -->
					<div class="logo-wrap">
						<img src="/upload${logoFile.fileSaveLocate}">
					</div>
					<!-- 그룹 명 -->
					<div class="card-body">
						<h6>${artGroup.artGroupNm}</h6>
					</div>
				</button>
			</c:forEach>
			<!-- DM 리스트 반복 끝 -->
			<br> <br> <br> <img
				src="https://tpc.googlesyndication.com/simgad/17702928538065432889"
				width="60%" style="display: block; margin: 0 auto;" />
		</div>
		<!-- DM 리스트 끝-->

		<!-- 아티스트 그룹 리스트 시작 -->
		<div class="container py-5">
			<h5 class="text fw-bold mb-4">새로운 아티스트를 만나보세요!</h5>
			<div class="d-flex flex-wrap justify-content-start"
				style="gap: 16px;">
				<!-- 모든 그룹 출력 시작 -->
				<c:forEach var="artGroup" items="${newArtistGroupList}">
					<c:set var="groupFile"
						value="${artGroup.fileGroupVO.fileDetailVOList[0]}" />
					<form action="/oho/groupProfile" method="get">
						<input type="hidden" name="artGroupNo"
							value="${artGroup.artGroupNo}" />
						<!-- 그룹 번호 (PK) -->
						<button class="card-artist">
							<!-- 그룹 대표 이미지 -->
							<img src="/upload${groupFile.fileSaveLocate}" class="bg-img">
							<!-- 그룹 로고 -->
							<div class="logo-wrap">
								<img src="/images/hongdg.jpg">
							</div>
							<!-- 그룹 명 -->
							<div class="card-body">
								<h6>${artGroup.artGroupNm}</h6>
							</div>
						</button>
					</form>
				</c:forEach>
				<!-- 모든 그룹 출력 끝 -->
			</div>
		</div>
		<!-- 아티스트 그룹 리스트 끝 -->
		<!-- ///// 비회원 관점 끝 ///// -->



	</main>

	<%@ include file="footer.jsp"%>

	<!-- Scroll Top -->
	<a href="#" id="scroll-top"
		class="scroll-top d-flex align-items-center justify-content-center active">
		<i class="bi bi-arrow-up-short"></i>
	</a>
	<!-- 	<i class="bi bi-arrow-up-short"></i> -->

	<script>
	// 굿즈샵 리스트 비동기
	const gdsList = $(".card-artistNm");
	
	gdsList.on("click", function() {
		console.log("확인");

		// 선택 버튼 색상 변경
		$(".card-artistNm").removeClass("active");
		$(this).addClass("active");

		// 버튼 클릭 시 데이터 비동기 처리
		const artGroupNo = $(this).data("group");
		const memNo = $("#memNo").val();
		console.log("groupNO", artGroupNo);
		console.log("memNo", memNo);
		
		const data = {
				"artGroupNo" : artGroupNo,
				"memNo" : memNo
		}
		
		console.log("data 확인 ", data);

		axios.post("/oho/getGoodsList", data).then(resp => {
			console.log("찍히나", resp.data);
			
			// 굿즈리스트 렌더링
			renderGoodsList(resp.data);
			
		})

	})
	
	
	function renderGoodsList(goodsList) {
	const container = document.getElementById("goodsListContainer");
	container.innerHTML = ""; // 기존 내용 비우기

	if (goodsList.length === 0) {
		container.innerHTML = "<p>굿즈가 없습니다.</p>";
		return;
	}

	goodsList.forEach(goods => {
		
		console.log("goods : ", goods);
		// ? => 옵셔널 체이닝 : 해당 값이 null이나 undefined가 아니면 접근하고, 그렇지 않으면 에러 없이 그냥 undefined를 반환해주는 문법
		
		// 굿즈샵 상세페이지 /shop/artistGroup/{artistGroup}/detail/{gdsNo}
		const artGroupNo = goods.artGroupNo;
		console.log("artGroupNo : ", artGroupNo);
		const gdsNo = goods.gdsNo;
		console.log("gdsNo : ", gdsNo);
		let goodsImg = "";
		
		if (goods.fileGroupVO?.fileDetailVOList?.length > 0 && goods.fileGroupVO.fileDetailVOList[0] != null) {
			goodsImg = goods.fileGroupVO.fileDetailVOList[0].fileSaveLocate;
			console.log("goodsImg : ", goodsImg);
		}
		
		const form = document.createElement("form");
		form.action = `/shop/artistGroup/` + artGroupNo + `/detail/` + gdsNo;
		form.method = "get";

		form.innerHTML = `
			<button class="card-goods">
				<img src="/upload\${goodsImg}" class="bg-img">
			</button>
			\${goods.gdsNm} ₩\${goods.unitPrice}
		`;


/*
			<form action="/oho/community/fanBoardList" method="get">
				<c:set var="goodsFile"
					value="${goods.fileGroupVO.fileDetailVOList[0]}" />
				<button class="card-goods">
					<!-- 그룹 대표 이미지 -->
					<img src="/upload${goodsFile.fileSaveLocate}" class="bg-img">
				</button>
				${goods.gdsNm}
				₩<fmt:formatNumber value="${goods.unitPrice}" type="number" />
			</form>
*/

		container.appendChild(form);
	});
}


	</script>

	<!-- Main JS File -->
	<script src="/main/assets/js/main.js"></script>
</body>
</html>