<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html>

<head>
	<title>oHoT</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/login/vendor/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="/login/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="/login/css/util.css">
	<link rel="stylesheet" type="text/css" href="/login/css/main.css">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<!-- header.jsp 시작 -->
<%@ include file="header.jsp" %>
<div class="limiter">
		<div class="container-login100">
			<div class="wrap-login100" style="padding: 177px 130px 177px 95px;">
				<div class="login100-pic js-tilt" data-tilt="" style="will-change: transform; transform: perspective(300px) rotateX(0deg) rotateY(0deg);">
					<img src="/images/banner1.png" alt="IMG">
				</div>

				<form class="login100-form validate-form" action="/signup" method="post">
					<span class="login100-form-title">
						<img src="/images/oHoT_logo.png" class="logo" style="width : 100px; height : 100%">
						 회원가입
					</span>
					<br>
					
					<div  id="emailDiv" class="wrap-input100 validate-input" data-validate="Valid email is required: aaa@oho.com">
						<input id="email" class="input100" type="text" name="newEmail" placeholder="your@email.com">
						<span class="focus-input100"></span>
						<span class="symbol-input100">
							<i class="fa fa-envelope" aria-hidden="true"></i>
						</span>
					</div>
					<button id="valiBtn" type="button" class="btn-getstarted" onclick="emailCheck()">인증번호 발송</button>
					
					<div id="codeSectionDiv" class="wrap-input100 validate-input" data-validate="Password is required" style="display:none;">
						<input id="authCode" class="input100" placeholder="인증번호 입력">
						<span class="focus-input100"></span>
						<span class="symbol-input100">
							<i class="fa fa-lock" aria-hidden="true"></i>
						</span>
					</div>
					<button id="verifyCodeBtn" type="button" class="btn-getstarted" style="display:none;">인증 확인</button>
					
					<div id="newPwDiv" class="wrap-input100 validate-input" data-validate="Password is required" style="display:none;">
						<input id="newPw" class="input100" type="password" name="newPassword" autocomplete="current-password" placeholder="비밀번호">
						<span class="focus-input100"></span>
						<span class="symbol-input100">
							<i class="fa fa-lock" aria-hidden="true"></i>
						</span>
					</div>
					
					<div id="pwConfirmDiv" class="wrap-input100 validate-input" data-validate="Password is required" style="display:none;">
						<input id="pwConfirm" class="input100" type="password" autocomplete="current-password" placeholder="비밀번호 재입력">
						<span class="focus-input100"></span>
						<span class="symbol-input100">
							<i class="fa fa-lock" aria-hidden="true"></i>
						</span>
					</div>
						<p id="pwMsg" style="font-size: 14px; margin-top: 5px; min-height: 83px; transition: color 0.3s ease;"></p>

					<div class="container-login100-form-btn">
						<button id="next" class="login100-form-btn" style="visibility: hidden;">
							다음으로!
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		function emailCheck() {
			const email = $("#email").val();
			console.log("loginform : ", email);
		
			// 이메일이 양식에 맞을 경우
			if(email.trim().match(/^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{1,5}|[0-9]{1,3})(\]?)$/)){
				
				console.log("email : ", email);
				
				
				// 이메일 중복 체크
				axios.post("/emailCheck", {email}).then(result => {
					console.log("result : ", result.data);
					
					// 중복체크 통과 (새로운 회원)
					if(result.data == "success") {
						
						// 1. 인증코드 발송
					 	axios.post("/sendCode", { email }).then(resp => {
							console.log("resp : ", resp)
							
							// 1-1. 발송 성공 alert
							sendSuccess();
							// 1-2. 이메일 입력창 readonly
							$("#email").attr("readonly", true);
							// 1-3. 인증번호 발송 버튼 지우기
							document.getElementById("valiBtn").remove();
							// 1-4. 인증코드 입력창 활성화
							document.getElementById("codeSectionDiv").style.display = "block";
							// 1-5. 인증확인 버튼 활성화
							document.getElementById("verifyCodeBtn").style.display = "block";
							
						}).catch(()=> {
							sendFail();
						});
						
						// 2. 인증번호 일치
						document.getElementById("verifyCodeBtn").addEventListener("click", () => {
							const email = document.getElementById("email").value;
  							const code = document.getElementById("authCode").value;

							axios.post("/verifyCode", { email, code }).then(resp => {
								console.log("verifyCode : ", resp.data);
								
								if(resp.data == "timeOut") { // 타임 초과
									timeOut();
								} else if(resp.data == "fail") { // 인증번호 불일치
									verifyFail();
								} else { // 인증번호 일치 (성공!)
									verifySuccess();
								
									// 2-1. 인증번호 입력창, 인증확인 버튼 지우기
									document.getElementById("codeSectionDiv").remove();
									document.getElementById("verifyCodeBtn").remove();
									// 2-2. 비밀번호, 재입력창 활성화
									document.getElementById("newPwDiv").style.display = "block";
	 								document.getElementById("pwConfirmDiv").style.display = "block";
	 								document.getElementById("pwMsg").style.display = "block";
	 								
	 								// 2-3. 비밀번호 / 재입력 일치 여부 체크
	 								pwCheck();
	 								
								}
							})
						})
						
					}else { // 메일 중복 미통과 (기존 회원)
						alMail(); // 사용 불가 alert
					}
				})
				
			// 이메일이 양식에 맞지 않을 경우
			}else{
				Swal.fire({
		            icon: 'warning',
		            title: 'Oops..',
		            text: '이메일을 양식에 맞게 입력해 주세요.',
		            confirmButtonText: '확인'
		        });
			}
		}
		
		// 비밀번호/비밀번호 재입력 체크 함수
		function pwCheck() {
			const newPw = document.getElementById("newPw");
			const pwConfirm = document.getElementById("pwConfirm");
			const pwMsg = document.getElementById("pwMsg");
			const next = document.getElementById("next");

			// 비밀번호 재입력창에 글자가 입력될 때
			pwConfirm.addEventListener("input", () => {
				if(pwConfirm.value === "" ) pwMsg.textContent = "";
				else if(pwConfirm.value == newPw.value) {
					pwMsg.textContent = "비밀번호가 일치합니다.";
					pwMsg.style.color = "green";
					// "다음" 버튼 활성화
					next.style.visibility = "visible";
					
				}else {
					pwMsg.textContent = "비밀번호가 틀립니다.";
					pwMsg.style.color = "red";
					
					// "다음" 버튼 비활성화
					next.style.visibility = "hidden";
				}
			})
			
			
		}
		
		function newMail() {
			Swal.fire({
	            icon: 'success',
	            title: '사용가능한 이메일입니다!',
	            text: '회원가입을 계속 진행해 주세요.',
	            confirmButtonText: '확인'
	        });
		}
		
		function alMail() {
			Swal.fire({
	            icon: 'warning',
	            title: '이미 사용 중인 이메일입니다.',
	            text: '로그인을 해 주세요!',
	            confirmButtonText: '확인'
	        });
		}
		
		function sendSuccess() {
			Swal.fire({
	            icon: 'success',
	            title: '인증번호를 발송했습니다!',
	            text: '해당 메일에서 확인해 주세요.',
	            confirmButtonText: '확인'
	        });
		}
		
		function sendFail() {
			Swal.fire({
	            icon: 'error',
	            title: '인증번호 전송에 실패했습니다.',
	            text: '다시 시도해 주세요.',
	            confirmButtonText: '확인'
	        });
		}
		
		function timeOut() {
			Swal.fire({
	            icon: 'error',
	            title: '인증 유효시간이 지났습니다.',
	            text: '다시 시도해 주세요.',
	            confirmButtonText: '확인'
	        });
		}
		
		function verifyFail() {
			Swal.fire({
	            icon: 'error',
	            title: '인증번호가 일치하지 않습니다.',
	            text: '다시 시도해 주세요.',
	            confirmButtonText: '확인'
	        });
		}
		
		function verifySuccess() {
			Swal.fire({
	            icon: 'success',
	            title: '인증 성공!',
	            text: '비밀번호를 설정해 주세요.',
	            confirmButtonText: '확인'
	        });
		}
	</script>
	
<%@ include file="footer.jsp" %>
<script src="/login/vendor/jquery/jquery-3.2.1.min.js"></script>
<script src="/login/vendor/bootstrap/js/popper.js"></script>
<script src="/login/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="/login/vendor/select2/select2.min.js"></script>
<script src="/login/vendor/tilt/tilt.jquery.min.js"></script>
<script>
		$('.js-tilt').tilt({
			scale: 1.1
		})
</script>
<script src="/login/js/main.js"></script>
</body>
</html>