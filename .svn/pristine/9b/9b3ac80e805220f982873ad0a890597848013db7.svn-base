<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.shop.mapper.TicketMapper">
	<select id="ticketList" resultMap="goodsMap">
		SELECT 
				g.gds_no
				, g.gds_type
				, g.gds_nm
				, g.expln
				, g.comm_code_grp_no
				, g.art_group_no
				, g.art_no
				, g.file_group_no
			    , t.tk_no
			    , t.tk_ctgr
			    , t.tk_lctn
			    , REGEXP_REPLACE(t.tk_start_ymd, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS tk_start_ymd
			    ,REGEXP_REPLACE(t.tk_finish_ymd, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS tk_finish_ymd
			    ,(SELECT tf.file_save_locate
		             FROM file_detail tf
	 	            WHERE tf.file_group_no = t.poster_file) AS tk_file_save_locate
	 	        ,(SELECT a.art_group_nm FROM artist_group a WHERE a.art_group_no = g.art_group_no) AS art_group_nm
                ,(SELECT a.art_act_nm FROM artist a WHERE a.art_no = g.art_no) AS art_act_nm
	 	 FROM goods g
	 	 LEFT JOIN ticket t ON g.gds_no = t.gds_no
		WHERE g.comm_code_grp_no='GD02'
	      AND g.gds_del_yn='N'
	        <if test="category != null and category != ''">
	            AND t.tk_ctgr = #{tkCtgr}
	        </if>
	</select>
	
	<select id="ticketDetail" parameterType="int" resultMap="goodsMap">
		SELECT T.TK_NO, T.TK_CTGR, T.TK_LCTN, REGEXP_REPLACE(T.TK_START_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS TK_START_YMD
		       ,REGEXP_REPLACE(T.TK_FINISH_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS TK_FINISH_YMD
		       ,T.POSTER_FILE, T.TK_VPRICE, T.TK_RPRICE, T.TK_SPRICE
		       ,TD.TK_DETAIL_NO, REGEXP_REPLACE(TD.TK_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS TK_YMD, TD.TK_ROUND
		       , G.GDS_NO, G.GDS_TYPE, G.GDS_NM, G.UNIT_PRICE, G.EXPLN, G.PIC, G.COMM_CODE_GRP_NO, G.REG_DT, G.ART_GROUP_NO, G.ART_NO, G.FILE_GROUP_NO
		       , F.FILE_SN, F.FILE_GROUP_NO, F.FILE_ORIGINAL_NAME, F.FILE_SAVE_NAME, F.FILE_SAVE_LOCATE, F.FILE_SIZE, F.FILE_EXT
		       , F.FILE_MIME, F.FILE_FANCYSIZE, F.FILE_SAVE_DATE, F.FILE_DOWNCOUNT 
		       , (SELECT TF.FILE_SAVE_LOCATE
		            FROM FILE_DETAIL TF
	 	           WHERE TF.FILE_GROUP_NO = T.POSTER_FILE) AS TK_FILE_SAVE_LOCATE
	 	       ,(SELECT A.ART_GROUP_NM FROM ARTIST_GROUP A WHERE A.ART_GROUP_NO = G.ART_GROUP_NO) AS ART_GROUP_NM
               ,(SELECT A.ART_ACT_NM FROM ARTIST A WHERE A.ART_NO = G.ART_NO) AS ART_NM
		FROM GOODS G
	    LEFT JOIN TICKET T ON G.GDS_NO = T.GDS_NO
	    LEFT JOIN TK_DETAIL TD ON T.TK_NO = TD.TK_NO
	    LEFT JOIN FILE_GROUP FG ON G.FILE_GROUP_NO = FG.FILE_GROUP_NO
	    LEFT JOIN FILE_DETAIL F ON F.FILE_GROUP_NO = FG.FILE_GROUP_NO
	    WHERE G.GDS_NO = #{gdsNo}
	</select>
	
		
	<select id="tkSeat" parameterType="long" resultType="com.ohot.shop.vo.SeatVO">
		SELECT 
				seat_no
				,seat_grade
				,tk_lctn
				,seat_floor
				,seat_section
				,seat_row
				,seat_detail_no
		FROM seat
		ORDER BY seat_no
	</select>
	
	<select id="seatTkDetail" parameterType="long" resultType="com.ohot.shop.vo.TkDetailVO">
		SELECT TK_DETAIL_NO, TK_YMD, TK_ROUND, TK_NO, GDS_NM
		FROM TK_DETAIL
		WHERE TK_NO=#{tkNo}
	</select>
	
	<resultMap type="com.ohot.shop.vo.GoodsVO" id="goodsMap">
		<result property="gdsNo" column="GDS_NO"/>
		<result property="gdsType" column="GDS_TYPE"/>
		<result property="gdsNm" column="GDS_NM"/>
		<result property="unitPrice" column="UNIT_PRICE"/>
		<result property="expln" column="EXPLN"/>
		<result property="pic" column="PIC"/>
		<result property="regDt" column="REG_DT"/>
		<result property="commCodeGrpNo" column="COMM_CODE_GRP_NO"/>
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artNo" column="ART_NO"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="artGroupNm" column="ART_GROUP_NM"/>
		<result property="artActNm" column="ART_ACT_NM"/>
	    <association property="fileGroupVO"  resultMap="fileGroupMap"/>
	    <association property="ticketVO"  resultMap="ticketMap"/>
	</resultMap>
	
	<resultMap type="com.ohot.shop.vo.TicketVO" id="ticketMap">
		<result property="posterFile" column="POSTER_FILE"/>
		<result property="tkVprice" column="TK_VPRICE"/>
		<result property="tkRprice" column="TK_RPRICE"/>
		<result property="tkSprice" column="TK_SPRICE"/>
		<result property="tkNo" column="TK_NO"/>
		<result property="tkCtgr" column="TK_CTGR"/>
		<result property="tkLctn" column="TK_LCTN"/>
		<result property="gdsNo" column="GDS_NO"/>
		<result property="tkStartYmd" column="TK_START_YMD"/>
		<result property="tkFinishYmd" column="TK_FINISH_YMD"/>
		<result property="tkFileSaveLocate" column="TK_FILE_SAVE_LOCATE"/>
		<association property="fileGroupVO" resultMap="fileGroupMap"/>
		<collection property="tkDetailVOList" resultMap="tkDetailMap" />
	</resultMap>
	
	<resultMap type="com.ohot.shop.vo.TkDetailVO" id="tkDetailMap">
		<result property="tkDetailNo" column="TK_DETAIL_NO"/>
		<result property="tkYmd" column="TK_YMD"/>
		<result property="tkRound" column="TK_ROUND"/>
		<result property="tkNo" column="TK_NO"/>
	</resultMap>
	
		<resultMap type="com.ohot.vo.FileGroupVO" id="fileGroupMap">
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileRegdate" column="FILE_REGDATE"/>
		<collection property="fileDetailVOList" resultMap="fileDetailMap"></collection>
	</resultMap>
	
	<resultMap type="com.ohot.vo.FileDetailVO" id="fileDetailMap">
		<result property="fileSn" column="FILE_SN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
		<result property="fileSaveName" column="FILE_SAVE_NAME"/>
		<result property="fileSaveLocate" column="FILE_SAVE_LOCATE"/>
		<result property="fileSize" column="FILE_SIZE"/>
		<result property="fileExt" column="FILE_EXT"/>
		<result property="fileMime" column="FILE_MIME"/>
		<result property="fileFancysize" column="FILE_FANCYSIZE"/>
		<result property="fileSaveDate" column="FILE_SAVE_DATE"/>
		<result property="fileDowncount" column="FILE_DOWNCOUNT"/>
	</resultMap>
</mapper>