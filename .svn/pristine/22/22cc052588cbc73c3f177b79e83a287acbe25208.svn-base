package com.ohot.shop.controller;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.ohot.home.community.vo.CommunityProfileVO;
import com.ohot.mapper.CommonCodeGroupMapper;
import com.ohot.mapper.SeqGeneratorMapper;
import com.ohot.service.BannerFileService;
import com.ohot.service.MemberService;
import com.ohot.shop.service.ShopService;
import com.ohot.shop.service.TicketService;
import com.ohot.shop.vo.GoodsVO;
import com.ohot.shop.vo.OrdersVO;
import com.ohot.shop.vo.ShippingInfoVO;
import com.ohot.vo.ArtistGroupVO;
import com.ohot.vo.BannerFileVO;
import com.ohot.vo.CommonCodeGroupVO;
import com.ohot.vo.CustomUser;
import com.ohot.vo.MemberVO;
import com.ohot.vo.SeqGeneratorVO;
import com.ohot.vo.UsersVO;

import jakarta.servlet.http.HttpSession;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/shop")
public class ShopController {
	
	@Autowired
	ShopService shopService;
	
	@Autowired
	MemberService memberService;
	
	@Autowired
	CommonCodeGroupMapper commonCodeGroupMapper;
	
	@Autowired
	SeqGeneratorMapper seqGeneratorMapper;
	
	@Autowired
	TicketService ticketService;
	
	@Autowired
	BannerFileService bannerFileService;
	
	// /shop 시리즈의 공통  model
	@ModelAttribute
	public void gongTong(Model model) {
		
		CommonCodeGroupVO commonCodeGroupVO = new CommonCodeGroupVO();
		commonCodeGroupVO.setCommCodeGrpNo("GD01");
		
		commonCodeGroupVO = this.commonCodeGroupMapper.commonCodeGroupList(commonCodeGroupVO);
		log.info("gongTong->commonCodeGroupVO : " + commonCodeGroupVO);
		
		//굿즈크기(GD01) : S/M/L
		model.addAttribute("commonCodeGroupVO", commonCodeGroupVO);
	}
	
	// /shop 시리즈 공통 model(상품유형 가져오기)
	@ModelAttribute
	public void gongTongGdsType(Model model) {
		CommonCodeGroupVO commonCodeGroupVO = new CommonCodeGroupVO();
		commonCodeGroupVO.setCommCodeGrpNo("GD03");
		
		commonCodeGroupVO = this.commonCodeGroupMapper.commonCodeGroupList(commonCodeGroupVO);
		log.info("gongTongGdsType->commonCodeGroupVO : " + commonCodeGroupVO);
		
		//상품유형(GD03) : G/A/M/D
		model.addAttribute("commonCodeGroupVOGdsType", commonCodeGroupVO);
	}
	
	/* shop Main Home Page */
	@GetMapping("/home")
	public String goodsForm(Model model, @AuthenticationPrincipal CustomUser customUser, @RequestParam(value = "tkCtgr", required = false) String tkCtgr) {
		
		UsersVO usersVO = null;
		
		List<CommunityProfileVO> communityProfileVOList = null;
		List<ArtistGroupVO> artistGroupVOList = null;
		
		//로그인 여부 체크
		if(customUser != null) {
			usersVO = customUser.getUsersVO();
			log.info("usersVO : "+ usersVO);
			
			//Recommended Artist 조회
			communityProfileVOList = shopService.communityProfileList(usersVO);
			log.info("communityProfileVOList : " + communityProfileVOList);
		}
		
		//artist 목록이 없을 때 처리
		if(communityProfileVOList == null || communityProfileVOList.isEmpty()) {
			
			//Recommended Artist 조회
			model.addAttribute("title", "Recommended Artist");
			
			//비 회원이거나 아티스트 그룹 목록이 없을 때 출력
			communityProfileVOList = shopService.communityProfileBaseList();
			
			//아티스트 그룹번호 조회
			List<Integer> artistGroupNoList = new ArrayList<Integer>();
			for (CommunityProfileVO communityProfileVO : communityProfileVOList) {
				artistGroupNoList.add(communityProfileVO.getArtistGroupVO().getArtGroupNo());
			}
			
			log.info("artistGroupNoList : " + artistGroupNoList);
			
			artistGroupVOList = shopService.artstGroupBaseList(artistGroupNoList);
			
		}else {	//회원이면서 아티스트 그룹 목록이 있을 때 출력
			model.addAttribute("title", "My Artist");
			
			//artistGroupVOList 조회
			artistGroupVOList = shopService.artstGroupList(usersVO);
		}
		
		model.addAttribute("artistGroupVOList", artistGroupVOList);
		model.addAttribute("communityProfileVOList", communityProfileVOList);
		
		//BannerList
		//TASK_SE_NM(업무구분명으로 조회)
		String taskSeNm = "shop";
		List<BannerFileVO> bannerFileVOList = bannerFileService.bannerFileList(taskSeNm);
		log.info("bannerFileVOList : " + bannerFileVOList);
		
		//artist 그룹목록 가져오기
		int limit = 3;
		List<ArtistGroupVO> topArtistsList = shopService.topArtistsList(limit);
		log.info("topArtistsList : " + topArtistsList);
		
		//artist 최상위그룹(1번)에 대한 굿즈 목록 가져오기
		ArtistGroupVO artistGroupVO = topArtistsList.get(0);
		List<ArtistGroupVO> topArtist = shopService.topArtistGoodsList(artistGroupVO); 
		log.info("topArtist : " + topArtist);
		
		//티켓 리스트 목록 가져오기
		List<GoodsVO> goodsVOList = this.ticketService.ticketList(tkCtgr);
		log.info("ticketList -> GoodsVO : "+goodsVOList);
		
		model.addAttribute("topArtistsList", topArtistsList);
		model.addAttribute("topArtist", topArtist);
		model.addAttribute("bannerFileVOList", bannerFileVOList);
		model.addAttribute("goodsVOList", goodsVOList);
		
		return "shop/home";
	}
	
	/* 아티스트 굿즈샵 홈페이지 */
	@GetMapping("/artistGroup")
	public String artistGroupForm(Model model, @RequestParam(required = false, defaultValue = "0") int artGroupNo) {
		
		//아티스트 그룹번호 조회
		List<Integer> artistGroupNoList = new ArrayList<Integer>();
		
		artistGroupNoList.add(artGroupNo);
		
		List<ArtistGroupVO> artistGroupVOList = shopService.artstGroupBaseList(artistGroupNoList);
		
		model.addAttribute("artistGroupVOList", artistGroupVOList);
		
		return "shop/groupList";
		
	}
	
	/* 아티스트 상품 유형 조회 */
	@ResponseBody
	@PostMapping("/artistGroup/gdsTypeAjax")
	public List<GoodsVO> gdsTypeAjax(@RequestBody GoodsVO goodsVO) {
		
		log.info("goodsVO : " + goodsVO);
		
		List<GoodsVO> goodsList = shopService.getGdsTypeList(goodsVO);
		
		log.info("goodsList : "  + goodsList);
		
		return goodsList;
	}
	
	
	/* 아티스트의 그룹 상품을 조회 */
	@ResponseBody
	@PostMapping("/artistGroup/topArtistAjax")
	public List<ArtistGroupVO> topArtistAjax(@RequestBody ArtistGroupVO artistGroupVO) {
		
		log.info("artistGroupVO : " + artistGroupVO);
		
		List<ArtistGroupVO> topArtist = shopService.topArtistGoodsList(artistGroupVO); 
		
		return topArtist;
	}
	
	
	/* Goods Shop Detail */
	/* localhost:28080/shop/artistGroup/6/detail/24 */
	@GetMapping("/artistGroup/{artistGroup}/detail/{gdsNo}")
	public String goodsDetailForm(@PathVariable int artistGroup, @PathVariable int gdsNo, Model model, 
								  RedirectAttributes redirectAttributes) {
		
		// URL 파라미터로 받은 artistGroup과 gdsNo 값 로깅
		log.info("artistGroup : " + artistGroup);
		log.info("gdsNo : " + gdsNo);
		
		// GoodsVO 객체 생성하여 artistGroup과 gdsNo 값 설정
		GoodsVO goodsVO = new GoodsVO();
		goodsVO.setArtGroupNo(artistGroup);
		goodsVO.setGdsNo(gdsNo);
		
		// shopService를 사용하여 해당 상품에 대한 상세 정보를 가져옴
		goodsVO = shopService.goodsDetail(goodsVO);
		
		log.info("goodsVO : " + goodsVO);
		
		// goodsVO가 null인 경우, 상품 정보를 찾을 수 없으므로 홈 페이지로 리다이렉트
		if(goodsVO == null ) {
			redirectAttributes.addFlashAttribute("alertMessage", "상품 페이지가 없습니다!");
			return "redirect:/shop/error";
		}else {
			model.addAttribute("goodsVO", goodsVO);
			return "shop/detail";
		}
	}
	
	/* error 발생 시 예외 처리 */
	@GetMapping("/error")
	public String error(@ModelAttribute("alertMessage") String alertMessage, Model model) {
		
		log.info("alertMessage : " + alertMessage);
		
		model.addAttribute("alertMessage", alertMessage);
		
		return "shop/error";
	}
	
	
	
	/* Goods Shop orders*/
	@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@PostMapping("/ordersPost")
	public String goodsPostOrdersForm(ArtistGroupVO artistGroupVO, Model model, 
									  @AuthenticationPrincipal CustomUser customUser,
									  HttpSession session,
									  @RequestParam(required = false) String gdsType,
									  @RequestParam(required = false, defaultValue = "0") int artGroupNo) {
		
		log.info("goodsPostOrdersForm->artistGroupVO : " + artistGroupVO);
		UsersVO usersVO = null;
		MemberVO memberVO = new MemberVO();
		
		// seqGenerator에서 관리하는 시퀀스 정보를 가져와서, orders 테이블의 기본키 값을 삽입하기 위한 코드
		SeqGeneratorVO seqGeneratorVO = new SeqGeneratorVO();
		
		
		List<GoodsVO> goodsVOList = new ArrayList<GoodsVO>();
		
		//로그인 체크
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
		}else {
			usersVO = customUser.getUsersVO();
			memberVO.setMemNo((int)usersVO.getUserNo());
			
			//MemberShip 결제인 경우
			if(artGroupNo > 0 && gdsType != null) {
				GoodsVO goodsVO = new GoodsVO();
				goodsVO.setArtGroupNo(artGroupNo);
				goodsVO.setGdsType(gdsType);
				goodsVO = shopService.getMemberShip(goodsVO);
				
				log.info("goodsVO : " + goodsVO);
				
				
				String fileSaveLocate = goodsVO.getFileGroupVO().getFileDetailVOList().get(0).getFileSaveLocate();
				
				goodsVO.setFileSavePath(fileSaveLocate);
				goodsVO.setQty(1);
				goodsVO.setAmount(goodsVO.getUnitPrice());
				goodsVO.setGramt(goodsVO.getUnitPrice());
				
				goodsVOList.add(goodsVO);
				artistGroupVO.setGoodsVOList(goodsVOList);
				
				
			}else {
				// artistGroupVO 객체에서 상품 정보를 가져와 세션에 저장
				goodsVOList = artistGroupVO.getGoodsVOList();
			}
			
			session.setAttribute("goodsVOList", goodsVOList);
			
			// seqGeneratorVO에 업무 유형("order") 값을 설정하고, seqGenerator에서 해당 시퀀스 값을 조회하여 가져옴
			seqGeneratorVO.setTaskSeNm("order");
			
			// NULL or seqGeneratorVO return;
			seqGeneratorVO = seqGeneratorMapper.findSeqGenerator(seqGeneratorVO);
			//seqGenerator 값이 null인 경우
			if(seqGeneratorVO == null) {
				seqGeneratorVO = new SeqGeneratorVO();
				seqGeneratorVO.setTaskSeNm("order");
				seqGeneratorMapper.updateSeqGeneratorDate(seqGeneratorVO);
				seqGeneratorVO = seqGeneratorMapper.findSeqGenerator(seqGeneratorVO);
				log.info("seqGeneratorVO : " + seqGeneratorVO);
			}
			
			//Payment param에 사용하는 OrderesId 생성코드
			seqGeneratorVO.setUuid(UUID.randomUUID());
			
			session.setAttribute("seqGeneratorVO", seqGeneratorVO);
			
			//Member 정보가져오기
			memberVO = memberService.memberDetail(memberVO);
			
			//배송정보 가져오기
			List<ShippingInfoVO> shippingInfoVOList = shopService.getShippingInfoList(usersVO);
			
			model.addAttribute("artistGroupVO", artistGroupVO);
			model.addAttribute("memberVO", memberVO);
			model.addAttribute("shippingInfoVOList", shippingInfoVOList);
		}
		
		return "shop/orders";
	}
	
	/* orders Detail */
	//@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@GetMapping("/ordersDetail")
	public String ordersDetailForm(@AuthenticationPrincipal CustomUser customUser, Model model, RedirectAttributes redirectAttributes) {
		UsersVO usersVO = null;
		OrdersVO ordersVO = new OrdersVO();
		
		if(customUser == null) {
			redirectAttributes.addFlashAttribute("alertMessage", "로그인 후 이용바랍니다!");
			return "redirect:/shop/error";
		}else {
			usersVO = customUser.getUsersVO();
			ordersVO.setMemNo(usersVO.getUserNo());
		}
		
		//결제 내역 가져오기
		List<OrdersVO> ordersList = shopService.getOrdersList(ordersVO);
		log.info("ordersList : " + ordersList);
		
		model.addAttribute("ordersList", ordersList);
		
		return "shop/ordersDetail";
	}
	
	/* 배송 관리*/
	@GetMapping("/addrManager")
	public String addrManageFrom(@AuthenticationPrincipal CustomUser customUser, Model model) {
		
		UsersVO usersVO = null;
		
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
			
		}else {
			usersVO = customUser.getUsersVO();
		}
		
		//배송 주소 목록 가져오기
		List<ShippingInfoVO> shippingInfoVOList = shopService.getShippingInfoList(usersVO);
		
		log.info("shippingInfoVOList : " + shippingInfoVOList);
		
		model.addAttribute("shippingInfoVOList", shippingInfoVOList);
		
		return "shop/addr/addrManager";
	}
	
	/* 배송 주소 등록*/
	@ResponseBody
	@PostMapping("/addrManagerPost")
	public String addrManagePost(@AuthenticationPrincipal CustomUser customUser, ShippingInfoVO shippingInfoVO) {
		
		log.info("shippingInfoVO" + shippingInfoVO);
		
		UsersVO usersVO = null;
		
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
			return "fail";
		}else {
			usersVO = customUser.getUsersVO();
			shippingInfoVO.setMemNo(usersVO.getUserNo());
			
			//기본 배송지가 있는지 체크
			Integer isDefaultChk = shopService.shippingInfoIsDefaultChecked(usersVO.getUserNo());
			
			//기본 배송지가 있는 경우 기본 배송 주소를 N으로 변경
			if(isDefaultChk != null) {
				int isDefaultChkInt = (int)isDefaultChk; 
				shopService.shippingInfoIsDefaultUpdate(isDefaultChkInt);
			}
			
			
			//입력된 배송주소를 DB에 저장
			int result = shopService.shippingInfoInsert(shippingInfoVO);
			
			if(result > 0) {
				return "success";
			}
			
		}
		return "fail";
	}
	
	@ResponseBody
	@PostMapping("/addrManagerUpdateForm")
	public ShippingInfoVO addrManageUpdateForm(@AuthenticationPrincipal CustomUser customUser, @RequestBody ShippingInfoVO shippingInfoVO) {
		log.info("shippingInfoVO" + shippingInfoVO);
		
		UsersVO usersVO = null;
		
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
			
		}else {
			usersVO = customUser.getUsersVO();
			shippingInfoVO.setMemNo(usersVO.getUserNo());
		}
		
		//배송 주소 목록 가져오기
		shippingInfoVO = shopService.getShippingInfo(shippingInfoVO);
		
		log.info("shippingInfoVO : " + shippingInfoVO);
		
		return shippingInfoVO;
	}
	
	/* 배송 주소 업데이트 */
	@ResponseBody
	@PostMapping("/addrManagerUpdatePost")
	public String addrManagerUpdatePost(@AuthenticationPrincipal CustomUser customUser, ShippingInfoVO shippingInfoVO) {
		
		log.info("shippingInfoVO" + shippingInfoVO);
		
		UsersVO usersVO = null;
		
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
			return "fail";
		}else {
			usersVO = customUser.getUsersVO();
			shippingInfoVO.setMemNo(usersVO.getUserNo());
			
			//기본 배송지가 있는지 체크
			Integer isDefaultChk = shopService.shippingInfoIsDefaultChecked(usersVO.getUserNo());
			
			//기본 배송지가 있는 경우 기본 배송 주소를 N으로 변경
			if(isDefaultChk != null) {
				int isDefaultChkInt = (int)isDefaultChk; 
				shopService.shippingInfoIsDefaultUpdate(isDefaultChkInt);
			}
			
			//입력된 배송주소를 DB에 저장
			int result = shopService.shippingInfoUpdate(shippingInfoVO);
			
			if(result > 0) {
				return "success";
			}
			
		}
		return "fail";
	}
	
	/* 배송 주소 삭제 */
	@ResponseBody
	@PostMapping("/addrManagerDeletePost")
	public String addrManagerDeletePost(@AuthenticationPrincipal CustomUser customUser, @RequestBody ShippingInfoVO shippingInfoVO) {
		
		log.info("shippingInfoVO" + shippingInfoVO);
		
		UsersVO usersVO = null;
		
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
			return "fail";
		}else {
			usersVO = customUser.getUsersVO();
			shippingInfoVO.setMemNo(usersVO.getUserNo());
			
			//입력된 배송주소를 DB에 저장
			int result = shopService.shippingInfoDelete(shippingInfoVO);
			
			if(result > 0) {
				return "success";
			}
			
		}
		return "fail";
	}
	
	/* ordersPostAjax: 미사용 코드(참조용) */
	@ResponseBody
	@PostMapping("/ordersPostAjax")
	public ArtistGroupVO goodsOrdersPost(@RequestBody ArtistGroupVO artistGroupVO) {
		log.info("artistGroupVO : "+ artistGroupVO);
		return artistGroupVO;
	}
}