<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.admin.mapper.AdminGoodsMapper">
	
	<insert id="goodsInsert" parameterType="com.ohot.shop.vo.GoodsVO" >
	 <selectKey resultType="int" order="BEFORE" keyProperty="gdsNo">
		SELECT NVL(MAX(GDS_NO),0)+1 FROM GOODS
	</selectKey>
	 INSERT INTO GOODS(GDS_NO, GDS_TYPE, GDS_NM, UNIT_PRICE, EXPLN, PIC, REG_DT, COMM_CODE_GRP_NO, ART_GROUP_NO, ART_NO, FILE_GROUP_NO, QTY, GDS_DEL_YN)
	 VALUES(#{gdsNo}, #{gdsType}, #{gdsNm}, #{ticketVO.tkVprice}, #{expln}, #{pic}, SYSDATE, 'GD02', ${artGroupNo}, ${artNo}, ${fileGroupNo}, 0, 'N')
	</insert>
	
	<insert id="ticketInsert" parameterType="com.ohot.shop.vo.TicketVO">
		<selectKey resultType="long" order="BEFORE" keyProperty="tkNo">
			SELECT NVL(MAX(TK_NO),0)+1 FROM TICKET
		</selectKey>
		INSERT INTO TICKET(TK_NO, TK_CTGR, TK_LCTN, GDS_NO, TK_START_YMD, TK_FINISH_YMD, POSTER_FILE, TK_VPRICE, TK_RPRICE, TK_SPRICE)
		VALUES(#{tkNo},#{tkCtgr},#{tkLctn},#{gdsNo},#{tkStartYmd},#{tkFinishYmd},#{posterFile},#{tkVprice},#{tkRprice},#{tkSprice})
	</insert>
	

	<insert id="tkDetailInsert" parameterType="com.ohot.shop.vo.TkDetailVO">
		INSERT INTO TK_DETAIL ( TK_YMD, TK_ROUND, TK_NO, GDS_NM,TK_DETAIL_NO)
		VALUES( #{tkYmd}, #{tkRound}, #{tkNo}, #{gdsNm}, TO_NUMBER(#{tkYmd}|| #{tkRound} || '0' || #{tkNo}))
	</insert>
	
	<select id="ticketPosterImg" parameterType="long" resultType="com.ohot.vo.FileDetailVO">
		SELECT FILE_SN, FILE_GROUP_NO, FILE_ORIGINAL_NAME, FILE_SAVE_NAME, FILE_SAVE_LOCATE, FILE_SIZE, FILE_EXT, FILE_MIME, FILE_FANCYSIZE, FILE_SAVE_DATE, FILE_DOWNCOUNT
		FROM FILE_DETAIL
		WHERE FILE_GROUP_NO=#{fileGroupNo}
	</select>
		
	<select id="ticketList" resultMap="goodsMap">
		SELECT G.GDS_NO, G.GDS_TYPE, G.GDS_NM, G.UNIT_PRICE, G.EXPLN, G.PIC, TO_CHAR(G.REG_DT,'YYYY-MM-DD') AS REG_DT, G.ART_GROUP_NO, ART_NO
		       ,T.TK_NO, T.TK_CTGR, T.TK_LCTN, TO_CHAR(TO_DATE(T.TK_START_YMD), 'YYYY-MM-DD') AS TK_START_YMD
		       ,TO_CHAR(TO_DATE(T.TK_FINISH_YMD), 'YYYY-MM-DD') AS TK_FINISH_YMD
		       ,(SELECT TF.FILE_SAVE_LOCATE
		            FROM FILE_DETAIL TF
	 	           WHERE TF.FILE_GROUP_NO = T.POSTER_FILE) AS TK_FILE_SAVE_LOCATE
	 	       ,(SELECT A.ART_GROUP_NM FROM ARTIST_GROUP A WHERE A.ART_GROUP_NO = G.ART_GROUP_NO) AS ART_GROUP_NM
               ,(SELECT A.ART_ACT_NM FROM ARTIST A WHERE A.ART_NO = G.ART_NO) AS ART_ACT_NM
		FROM GOODS G
		LEFT JOIN TICKET T ON G.GDS_NO = T.GDS_NO
		WHERE COMM_CODE_GRP_NO='GD02'
		AND GDS_DEL_YN='N'
	</select>

	<select id="ticketDetail" parameterType="int" resultMap="goodsMap">
		SELECT T.TK_NO, T.TK_CTGR, T.TK_LCTN, TO_CHAR(TO_DATE(T.TK_START_YMD), 'YYYY-MM-DD') AS TK_START_YMD
		       ,TO_CHAR(TO_DATE(T.TK_FINISH_YMD), 'YYYY-MM-DD') AS TK_FINISH_YMD
		       ,T.POSTER_FILE, T.TK_VPRICE, T.TK_RPRICE, T.TK_SPRICE
		       ,TD.TK_DETAIL_NO, TO_CHAR(TO_DATE(TD.TK_YMD), 'YYYY-MM-DD') AS TK_YMD, TD.TK_ROUND
		       , G.GDS_NO, G.GDS_TYPE, G.GDS_NM, G.UNIT_PRICE, G.EXPLN, G.PIC, G.COMM_CODE_GRP_NO, G.REG_DT, G.ART_GROUP_NO, G.ART_NO, G.FILE_GROUP_NO
		       , F.FILE_SN, F.FILE_GROUP_NO, F.FILE_ORIGINAL_NAME, F.FILE_SAVE_NAME, F.FILE_SAVE_LOCATE, F.FILE_SIZE, F.FILE_EXT
		       , F.FILE_MIME, F.FILE_FANCYSIZE, F.FILE_SAVE_DATE, F.FILE_DOWNCOUNT 
		       ,(SELECT TF.FILE_SAVE_LOCATE
		            FROM FILE_DETAIL TF
	 	           WHERE TF.FILE_GROUP_NO = T.POSTER_FILE) AS TK_FILE_SAVE_LOCATE
	 	       ,(SELECT A.ART_GROUP_NM FROM ARTIST_GROUP A WHERE A.ART_GROUP_NO = G.ART_GROUP_NO) AS ART_GROUP_NM
               ,(SELECT A.ART_ACT_NM FROM ARTIST A WHERE A.ART_NO = G.ART_NO) AS ART_ACT_NM
		FROM GOODS G
	    LEFT JOIN TICKET T ON G.GDS_NO = T.GDS_NO
	    LEFT JOIN TK_DETAIL TD ON T.TK_NO = TD.TK_NO
	    LEFT JOIN FILE_GROUP FG ON G.FILE_GROUP_NO = FG.FILE_GROUP_NO
	    LEFT JOIN FILE_DETAIL F ON F.FILE_GROUP_NO = FG.FILE_GROUP_NO
	    WHERE G.GDS_NO = #{gdsNo}
	</select>
	
	<update id="ticketUpdateGds" parameterType="com.ohot.shop.vo.GoodsVO" >
		UPDATE GOODS
		   SET GDS_NM = #{gdsNm}
		   	   , UNIT_PRICE = #{ticketVO.tkVprice}
		   	   , EXPLN = #{expln}
		   	   , PIC = #{pic}
		   	   , REG_DT = SYSDATE
		   	   , FILE_GROUP_NO = #{fileGroupNo}
		WHERE  GDS_NO = #{gdsNo}
	</update>
	<update id="ticketUpdateTk" parameterType="com.ohot.shop.vo.TicketVO" >
		UPDATE TICKET
		   SET TK_CTGR = #{tkCtgr}
		   	   , TK_LCTN = #{tkLctn}
		   	   , POSTER_FILE = #{posterFile}
		   	   , TK_VPRICE = #{tkVprice}
		   	   , TK_RPRICE = #{tkRprice}
		   	   , TK_SPRICE = #{tkSprice}
		WHERE  TK_NO = ${tkNo}
	</update>
	<update id="ticketUpdateTkDe" parameterType="com.ohot.shop.vo.TkDetailVO" >
		UPDATE TK_DETAIL
		   SET TK_YMD = #{tkYmd}
		   , TK_ROUND = #{tkRound}
		   , GDS_NM = #{gdsNm}
		 WHERE TK_DETAIL_NO= #{tkDetailNo}
	</update>
	
	<update id="ticketDelete" parameterType="int">
		UPDATE GOODS
		SET GDS_DEL_YN ='Y'
		WHERE GDS_NO =#{gdsNo}
	</update>
	
	<resultMap type="com.ohot.shop.vo.GoodsVO" id="goodsMap">
		<result property="gdsNo" column="GDS_NO"/>
		<result property="gdsType" column="GDS_TYPE"/>
		<result property="gdsNm" column="GDS_NM"/>
		<result property="unitPrice" column="UNIT_PRICE"/>
		<result property="expln" column="EXPLN"/>
		<result property="pic" column="PIC"/>
		<result property="regDt" column="REG_DT"/>
		<result property="commCodeGrpNo" column="COMM_CODE_GRP_NO"/>
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artNo" column="ART_NO"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="artGroupNm" column="ART_GROUP_NM"/>
		<result property="artActNm" column="ART_ACT_NM"/>
	    <association property="fileGroupVO"  resultMap="fileGroupMap"/>
	    <association property="ticketVO"  resultMap="ticketMap"/>
	</resultMap>
	
	<resultMap type="com.ohot.shop.vo.TicketVO" id="ticketMap">
		<result property="posterFile" column="POSTER_FILE"/>
		<result property="tkVprice" column="TK_VPRICE"/>
		<result property="tkRprice" column="TK_RPRICE"/>
		<result property="tkSprice" column="TK_SPRICE"/>
		<result property="tkNo" column="TK_NO"/>
		<result property="tkCtgr" column="TK_CTGR"/>
		<result property="tkLctn" column="TK_LCTN"/>
		<result property="gdsNo" column="GDS_NO"/>
		<result property="tkStartYmd" column="TK_START_YMD"/>
		<result property="tkFinishYmd" column="TK_FINISH_YMD"/>
		<result property="tkFileSaveLocate" column="TK_FILE_SAVE_LOCATE"/>
		<association property="fileGroupVO" resultMap="fileGroupMap"/>
		<collection property="tkDetailVOList" resultMap="tkDetailMap" />
	</resultMap>
	
	<resultMap type="com.ohot.shop.vo.TkDetailVO" id="tkDetailMap">
		<result property="tkDetailNo" column="TK_DETAIL_NO"/>
		<result property="tkYmd" column="TK_YMD"/>
		<result property="tkRound" column="TK_ROUND"/>
		<result property="tkNo" column="TK_NO"/>
	</resultMap>
	
		<resultMap type="com.ohot.vo.FileGroupVO" id="fileGroupMap">
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileRegdate" column="FILE_REGDATE"/>
		<collection property="fileDetailVOList" resultMap="fileDetailMap"></collection>
	</resultMap>
	
	<resultMap type="com.ohot.vo.FileDetailVO" id="fileDetailMap">
		<result property="fileSn" column="FILE_SN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
		<result property="fileSaveName" column="FILE_SAVE_NAME"/>
		<result property="fileSaveLocate" column="FILE_SAVE_LOCATE"/>
		<result property="fileSize" column="FILE_SIZE"/>
		<result property="fileExt" column="FILE_EXT"/>
		<result property="fileMime" column="FILE_MIME"/>
		<result property="fileFancysize" column="FILE_FANCYSIZE"/>
		<result property="fileSaveDate" column="FILE_SAVE_DATE"/>
		<result property="fileDowncount" column="FILE_DOWNCOUNT"/>
	</resultMap>
</mapper>