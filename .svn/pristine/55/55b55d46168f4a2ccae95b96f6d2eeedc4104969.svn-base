/**
 * 미디어 라이브 관리자 페이지 js
 * 
 */

$(function () {
  // DataTable 초기화
  const dataTable = $('#example2').DataTable({
    "paging": true,
    "lengthChange": true, // 페이지당 항목 수 선택 옵션
    "searching": false, // 테이블 내 검색창 옵션
    "ordering": true,
    "info": true,
    "autoWidth": false,
    "responsive": true,
  });

  // Select2 초기화
  $('#community-name, #membership-filter, #banner-filter, #delete-filter').select2({
    placeholder: "선택",
    allowClear: true,
    theme: 'bootstrap4'
  });

  // 날짜 피커 초기화
  $('#start-date, #end-date').datetimepicker({
    format: 'YYYY-MM-DD'
  });

  // 검색 폼 제출 이벤트 처리
  $('form').on('submit', function(e) {
    e.preventDefault();
    searchMediaPosts();
  });

  // 검색 함수
  function searchMediaPosts() {
    // 로딩 표시
    $('#example2 tbody').html('<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> 검색 중...</td></tr>');
    
    // 검색 파라미터 수집
    const params = {
      artGroupNo: $('#community-name').val(),
      startDate: $('#start-date input').val(),
      endDate: $('#end-date input').val(),
      membershipYn: $('#membership-filter').val(),
      bannerYn: $('#banner-filter').val(),
      deleteYn: $('#delete-filter').val(),
      title: $('#search-title').val()
    };

    // AJAX 요청
    $.ajax({
      url: '/admin/media/search',
      type: 'GET',
      data: params,
      dataType: 'json',
      success: function(response) {
        updateMediaPostTable(response);
      },
      error: function(xhr, status, error) {
        console.error('검색 중 오류: ', error);
        $('#example2 tbody').html('<tr><td colspan="9" class="text-center text-danger">검색 오류</td></tr>');
      }
    });
  }

  // 테이블 업데이트 함수
  function updateMediaPostTable(data) {
    // 기존 DataTable 제거
    dataTable.destroy();
    
    const tableBody = $('#example2 tbody');
    tableBody.empty();
    
    if (data.length === 0) {
      tableBody.append('<tr><td colspan="9" class="text-center">검색 결과가 없습니다.</td></tr>');
      
      // 빈 데이터로 DataTable 다시 초기화
      $('#example2').DataTable({
        "paging": true,
        "lengthChange": true,
        "searching": false,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
      });
      
      return;
    }
    
    // 결과 데이터로 테이블 행 생성
    $.each(data, function(index, post) {
      const row = `
        <tr>
          <td>${index + 1}</td>
          <td>${post.mediaPostNo}</td>
          <td>${post.artistGroupVO ? post.artistGroupVO.artGroupNm : '-'}</td>
          <td class="dtr-control sorting_1" tabindex="0">${post.mediaPostTitle}</td>
          <td>${formatDate(post.mediaRegDt)}</td>
          <td>${post.mediaMebershipYn === 'Y' ? '멤버십' : '일반'}</td>
          <td>${post.isbannerYn === 'Y' ? '배너' : '일반'}</td>
          <td>${post.mediaDelYn === 'Y' ? '삭제' : '게시중'}</td>
          <td class="dtr-control sorting_1" tabindex="0">
            <a href="/admin/media/detail/${post.mediaPostNo}" class="btn btn-sm btn-info">게시글 바로가기</a>
          </td>
        </tr>
      `;
      tableBody.append(row);
    });
    
    // 테이블 다시 초기화
    $('#example2').DataTable({
      "paging": true,
      "lengthChange": true,
      "searching": false,
      "ordering": true,
      "info": true,
      "autoWidth": false,
      "responsive": true,
    });
  }
  
  // 날짜 포맷 함수
  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.getFullYear() + '-' + 
           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
           String(date.getDate()).padStart(2, '0');
  }
});