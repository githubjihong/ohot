<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="/adminlte/dist/css/adminlte.min.css" />
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<!-- <script src='fullcalendar/dist/index.global.js'></script> -->
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
 
 <script>
	let selectedDate = "";
	let selTkDetailNo = "";

	let ticketList = [
        <c:forEach var="ticket" items="${goodsVO.ticketVO.tkDetailVOList}" varStatus="loop">
        {
            "tkNo": ${ticket.tkNo},
            "tkYmd": "${ticket.tkYmd}",
            "tkRound": ${ticket.tkRound},
            "tkDetailNo" :${ticket.tkDetailNo}
        }<c:if test="${!loop.last}">,</c:if>
        </c:forEach>
    ];

	let endDay= new Date("${goodsVO.ticketVO.tkFinishYmd}");
	endDay.setDate(endDay.getDate()+1);
	let chEndDate = endDay.toISOString().split("T")[0];
	console.log(chEndDate);
	let stDay= new Date("${goodsVO.ticketVO.tkStartYmd}");
	stDay.setDate(stDay.getDate());
	let chStDate = stDay.toISOString().split("T")[0];
	

	document.addEventListener('DOMContentLoaded', function() {
		var calendarEl = document.getElementById('calendar');
		var calendar = new FullCalendar.Calendar(calendarEl, {
			initialView : 'dayGridMonth',
			//locale:'ko',
			now: chStDate ,
				
			headerToolbar : false,
			height : "380px",
			
			showNonCurrentDates: false,
			//expandRows:true,
//             validRange:{
//           	  start:chStDate,
//           	  end:chEndDate
//             },
			events : [ {
				start :chStDate,
				end :chEndDate,
				display:'background',
				color:'green'
				
			}],

/* 			eventClassNames: function(arg){
				//console.log("체킁: ",chEndDate);
				return "merong";
			}, */

			selectable : true,
			selectMirror : true,
			selectConstraint : {
				start : chStDate,
				end : chEndDate
			},
			windowResize : true,
			dateClick : function(info) {
				selectedDate = info.dateStr;
				//console.log("클릭한 날짜: " + selectedDate);
				groundbtn();
				
			},
			eventDidMount: function(info) {
				//console.log(ticketList[5].tkYmd+"ddfsd")
	            
				ticketList.forEach(ticket => {
			        let eventDate = ticket.tkYmd; // 공연 날짜
					//console.log(eventDate +"어디야!")
			        
			        // 해당 날짜의 숫자 색상을 변경
			        $("td[data-date='" + eventDate + "'] .fc-daygrid-day-number").css({
			            "color": "red",
			            "font-weight": "bold"
			        });
			    });
	        }
		});
		calendar.render();
	

	function groundbtn(){
		const ground = document.getElementById("ground");
		ground.innerHTML="";

		// 선택한 날짜(`tkYmd`)에 해당하는 `tkRound`만 필터링
		let filteredTickets = ticketList.filter(ticket => ticket.tkYmd === selectedDate);
		console.log(filteredTickets)
            
            if (filteredTickets.length === 0) {
                alert("선택한 날짜에 공연이 없습니다.");
                return;
            }

			// tkRound를 키로 하고, tkDetailNo를 값으로 저장하는 Map 생성
		    let roundMap = new Map();
		    filteredTickets.forEach(ticket => {
		        roundMap.set(ticket.tkRound, ticket.tkDetailNo);
		    });

		 // 회차별 버튼 추가
		    roundMap.forEach((tkDetailNo, round) => {
		        const btn = document.createElement("button");
		        btn.className = "btn btn-outline-success mr-4 mt-2 ml-3";
		        btn.textContent = round + '타임';
		        btn.value = tkDetailNo;  // tkDetailNo 저장
		        btn.id = 'btn' + round;
		        
                console.log(tkDetailNo +"dd")
				
				// 클릭 이벤트 추가
				btn.onclick = function () {
				selTkDetailNo = btn.value; // 선택한 tkDetailNo 저장

				// 모든 버튼을 원래 상태로 초기화
			    document.querySelectorAll("#ground button").forEach(b => {
			        b.className = "btn btn-outline-success mr-4";
			    });
				
				btn.className = "btn btn-success  mr-4";
				console.log("선택한 회차:", selTkDetailNo + "회차"+round);

				};

                ground.appendChild(btn);
            });
		}
	});
	
	function reserv() {
		console.log("선택된 날짜: "+selectedDate)
		console.log("되나? : "+"${goodsVO.ticketVO.tkNo}")
		if (selectedDate >= "${goodsVO.ticketVO.tkStartYmd}" &&selectedDate < chEndDate) {
			if(selTkDetailNo !="" && selTkDetailNo !=null ){
				
                console.log(" 제대로선택? : "+ selectedDate+ "   "+selTkDetailNo);
				window.open("seat?tkNo=${goodsVO.ticketVO.tkNo}&tkDetailNo="+selTkDetailNo,"_blank", "width=1200,height=800,top=100,left=50");
				
			}else alert("회차를 선택해주세요")
        }else{
			if(selectedDate==""||selectedDate==null){
				alert("날짜를 선택해주세요");
			}else	alert("선택할 수 없는 날짜입니다");
		}
	}
	
</script>

<style type="text/css">

	.fc-col-header-cell-cushion {
		color: black;
	}
	
	.fc-day-sun .fc-col-header-cell-cushion {
		color: red;
	}
	
	.fc-day-sat .fc-col-header-cell-cushion {
		color: blue;
	}
	
	.fc-daygrid-day-number {
		color: rgb(199, 198, 198);
		opacity: 80%;
	}
	

	.fc-daygrid-day-top {
    width: 50px;  /* 너비 줄이기 */
    height: 20px; /* 높이 줄이기 */
    font-size:18px !important; /* 폰트 크기 조정 */
}
	.fc-daygrid-day-top a{
	text-decoration: none !important;
}


	.fc-day-today {
    background-color: white !important; 
	}




</style>
<meta charset="UTF-8">
<title>공연상세</title>
</head>
<body>
	
	<%@ include file="../shopHeader.jsp" %>
	<!-- /// 제목 시작 /// -->
	<div class="jumbotron">
		<!-- container : 내용이 들어갈 때 -->
		<div class="container">
			<h1 class="display-3">ticketList</h1>
			${goodsVO }
		</div>
	</div>
	<!-- /// 제목 끝 /// -->
	
	<!-- /// 내용 시작 /// -->
	<input type="hidden" name="gdsNo" value="${goodsVO.gdsNo}" />
	<div class="container-sm">
		<!-- 행(row=tuple)별 처리. 내용을 중간 정렬 -->
		<div class="row " style="height:480px">
			<div class="card-body col-md-4">
				<p>파일그룹넘버(포스터)</p>
				 
				 <img src="/upload${goodsVO.ticketVO.tkFileSaveLocate}" alt="안돼!!" title="${goodsVO.gdsNm}" style="width:250px; height: 350px;"/>
			</div>
			<div class="col-md-4">
				<h5>공연정보</h5>
				<table class="table table-hover text-nowrap">
					
					<tr>
						<th>상품명</th>
						<td>${goodsVO.gdsNm}</td>
					</tr>
					<tr>
						<th>가격</th>
						<td>${goodsVO.unitPrice} 원</td>
					</tr>
					<tr>
						<th>설명</th>
						<td>${goodsVO.expln}</td>
					</tr>
					<tr>
						<th>공연기간</th>
						<td>${goodsVO.ticketVO.tkStartYmd} ~ ${goodsVO.ticketVO.tkFinishYmd}</td>
					</tr>
					<tr>
						<th>공연장소</th>
						<td>${goodsVO.ticketVO.tkLctn}</td>
					</tr>
				</table>
			</div>
			<label class="col-md-4">
				<div id="calendar" >
					<!-- 캘린더 영역 -->
				</div>
				<div id="ground" style="text-align: center; height: 50px;" >
				</div>
				<a type="button" onclick="reserv()"  target="_blank" class="btn btn-primary btn-block" >예매하기</a>
			</label>
		</div>
		
		<div style="text-align: center">
			<button class="btn btn-outline-info">상세정보</button>
			<button class="btn btn-outline-info">공연장정보</button>
			<button class="btn btn-outline-warning">기대평</button>
		</div>
		<br/>
		<div>
			<c:forEach var="fileDetail" items="${goodsVO.fileGroupVO.fileDetailVOList}">
				<img alt="경로확인" src="/upload/${fileDetail.fileSaveLocate }" style="width: 100%;" id="explnImg">
			</c:forEach>
		</div>
		
		<!-- /// 버튼 영역 시작 /// -->
		<div class="row text-center">
			<div class="col-sm-offset-2 col-sm-10"></div>
		</div>
		<!-- /// 버튼 영역 끝 /// -->
	</div>
	<!-- /// 내용 끝 /// -->
	<%@ include file="../footer.jsp" %>
</body>
</html>