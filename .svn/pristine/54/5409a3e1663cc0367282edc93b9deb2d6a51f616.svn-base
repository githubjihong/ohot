package com.ohot.admin.controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import com.ohot.admin.service.AdminGoodsService;
import com.ohot.service.ArtistGroupService;
import com.ohot.service.ArtistService;
import com.ohot.shop.vo.GoodsVO;
import com.ohot.shop.vo.TkDetailVO;
import com.ohot.vo.ArtistGroupVO;
import com.ohot.vo.ArtistVO;
import com.ohot.vo.FileDetailVO;
import com.ohot.vo.FileGroupVO;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/admin/shop")
public class AdminGoodsController {
	
	@Autowired
	AdminGoodsService adminGoodsService;
	
	@Autowired
	ArtistGroupService artistGroupService;
	
	@Autowired
	ArtistService artistService;
	
	//전역변수
	long tkNo = 0L;

	//굿즈 등록
	
	
	
	//공연 리스트
	@GetMapping("/ticketList")
	public String ticketList(GoodsVO goodsVO, Model model) {
		log.info("ticketLsit->goodsVO: "+goodsVO);
		List<GoodsVO> goodsVOList = this.adminGoodsService.ticketList();
		model.addAttribute("goodsVOList", goodsVOList);
		
		
		
		return "admin/shop/ticketList";
	}
	
	//티켓상세
	@GetMapping("/ticketDetail")
	public String ticketDetail(int gdsNo,Model model) {
		log.info("ticketDetail->goodsVO: "+gdsNo);
		
		GoodsVO goodsVO= this.adminGoodsService.ticketDetail(gdsNo);
		model.addAttribute("goodsVO", goodsVO);
		
		return "admin/shop/ticketDetail";
	}
	
	//티켓 등록
	@GetMapping("/ticketCreate")
	public String ticketCreate(ArtistGroupVO artistGroupVO, Model model) {
		log.info("ticketCreate->artistGroupVO: "+artistGroupVO);
		
		List<ArtistGroupVO> artistGroupVOList = this.artistGroupService.homeArtistGroupList();
		model.addAttribute("artistGroupVOList", artistGroupVOList);
		
		List<ArtistVO> artistVOList = this.artistService.artistList();
		model.addAttribute("artistVOList", artistVOList);
		
		return "admin/shop/ticketCreate";
	}
	
	//1) /admin/goods/ticketCreate 에서 왼쪽 하단의 [저장]버튼 클릭
	@ResponseBody
	@PostMapping("/ticketCreatePost")
	public int ticketCreatePost( GoodsVO goodsVO , @RequestPart(value="uploadFile") MultipartFile[] uploadFiles) {
		
		log.info("ticketCreatePost-> goodsVO: "+goodsVO);
		
		//2) 전역 프로퍼티에 넣음
		int gdsNo = this.adminGoodsService.ticketInsert(goodsVO, uploadFiles);
		tkNo=goodsVO.getTicketVO().getTkNo();
		log.info("ticketcreate->gdsNo: "+gdsNo);
		
		return gdsNo;
	}
	
	@ResponseBody
	@PostMapping("/ticketEventPost")
	public long ticketEventPost(@RequestBody List<TkDetailVO> tkDetailVOList) {
		log.info("ticketEventPost실행->tkDetailVOList : " + tkDetailVOList);
		for (TkDetailVO detail : tkDetailVOList) {
	        log.info("tkYmd 값: " + detail.getTkYmd());
	        log.info("tkRound 타입: " + ( ((Object) detail.getTkRound()).getClass() == Long.class ));
	        log.info("tkYmd 타입: " + (((Object) detail.getTkYmd()).getClass() == Long.class ));
	        log.info("gdsNm 타입: " + (detail.getGdsNm().getClass() == String.class));
	    }
		log.info("----------------------"+tkDetailVOList);
		
		for (TkDetailVO tkDetailVO : tkDetailVOList) {
			//3) 전역 프로퍼티 활용
			tkDetailVO.setTkNo(this.tkNo);
			
			//TkDetailVO(tkDetailNo=0, tkYmd=20250408, tkRound=1, tkNo=15, gdsNm=에스파 봄콘서트)
			log.info("ticketEventPost->tkDetailVO[전] : " + tkDetailVO);
			int result=0;
			result += this.adminGoodsService.tkDetailInsert(tkDetailVO); // 서비스 호출
			log.info("ticketEventPost-> tkDetailVO[후] : "+ tkDetailVO);
			
	    }
		
		//4) 전역 프로퍼티 활용
		return this.tkNo;
	}
	
	//티켓포스터 등록
	@ResponseBody
	@PostMapping("/ticketPosterPost")
	public FileDetailVO ticketPosterPost(@RequestParam(value="uploadFile") MultipartFile[] uploadFile) {
		FileDetailVO result=this.adminGoodsService.ticketPoster(uploadFile);
		log.info(result+"dddd");
		return result;
	}
	
	
}
