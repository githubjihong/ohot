/**
 * 티켓 관리자 페이지 검색 js
 * 
 */

$(function() {
	
	fn_search(1)
// 검색 버튼 클릭 시
	$('#btnSearch').on('click', function() {
		fn_search(1);
	});
});


// 공통 검색 및 페이징 함수
function fn_search(page) {
	console.log("fn_search실행 data: "+page)
	const datas = {
		artGroupNo: $('#artGroupNo').val(),
		tkCtgr: $('#tkCtgr').val(),
		tkLctn: $('#tkLctn').val(),
		gdsNo: $('#gdsNo').val(),
		pic: $('#pic').val(),
		gdsDelYn: $('#gdsDelYn').val(),
		gdsNm: $('#gdsNm').val(),
		startDate: $('#start-date input').val(),
		endDate: $('#end-date input').val(),
		
		page: page,
		startRow: (page - 1) * 10 + 1,
		endRow: page * 10
	};
	const instance = axios.create();
	instance.interceptors.request.use(function() { $('#listBody').html('<tr><td colspan="5" class="text-center">로딩 중...</td></tr>'); });

	axios.post('/admin/shop/tkListSearchPost', datas).then(resp => {
		const { content, currentPage, totalPages, startPage, endPage } = resp.data;
	    renderTable(content);
	    renderPagination({ currentPage, totalPages, startPage, endPage });
	}).catch(() => {
		$('#listBody').html('<tr><td colspan="5" class="text-center text-danger">검색 중 오류 발생</td></tr>');
	})

};

// 테이블 렌더링 함수
function renderTable(data) {
  console.log("renderTable 실행:", data);
  const tbody = $('#listBody');
  tbody.empty();

  if (!data || data.length === 0) {
    tbody.append('<tr><td colspan="9" class="text-center">데이터가 없습니다.</td></tr>');
    return;
  }

  data.forEach((item, idx) => {
    const playNm = !item.artGroupNm ? item.artActNm : item.artGroupNm;
    const row = `
      <tr onclick="location.href='adTicketDetail?gdsNo=${item.gdsNo}'" style="cursor: pointer;">
        <td>${item.gdsNo}</td>
        <td><img src="/upload/${item.ticketVO.tkFileSaveLocate}" alt="포스터" width="50px" height="80px"></td>
        <td>${item.gdsNm}</td>
        <td>${item.ticketVO.tkLctn}</td>
        <td>${item.ticketVO.tkStartYmd} ~ ${item.ticketVO.tkFinishYmd}</td>
        <td>${numberWithCommas(item.unitPrice)}원</td>
        <td>${playNm}</td>
        <td>${item.pic}</td>
        <td>${item.regDt}</td>
      </tr>
    `;
    tbody.append(row);
  });
}

// 숫자 세 자리 콤마 포맷 함수
function numberWithCommas(dateStr) {
  return dateStr != null ? dateStr.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '-';
}

function renderPagination(paging) {
	console.log("renderPagination실행 data: "+paging)
  const container = $('#pagination-container');
  container.empty();

  if (!paging || paging.totalPages === 0) {
    return;
  }
  let html = '<ul class="pagination">';

  const disabledFirst = paging.startPage <= paging.blockSize ? 'disabled' : '';
  const disabledLast = paging.endPage >= paging.totalPages ? 'disabled' : '';

  html += `<li class="page-item ${disabledFirst}">
      <a class="page-link" href="#" onclick="fn_search(1)"><<</a></li>`;
  html += `<li class="page-item ${disabledFirst}">
      <a class="page-link" href="#" onclick="fn_search(${paging.startPage - 1})"><</a></li>`;

  for (let i = paging.startPage; i <= paging.endPage; i++) {
    const active = i === paging.currentPage ? 'active' : '';
    html += `<li class="page-item ${active}">
        <a class="page-link" href="#" onclick="fn_search(${i})">${i}</a></li>`;
  }

  html += `<li class="page-item ${disabledLast}">
      <a class="page-link" href="#" onclick="fn_search(${paging.startPage + paging.blockSize})">></a></li>`;
  html += `<li class="page-item ${disabledLast}">
      <a class="page-link" href="#" onclick="fn_search(${paging.totalPages})">>></a></li>`;

  html += '</ul>';

  container.append(html);
}

