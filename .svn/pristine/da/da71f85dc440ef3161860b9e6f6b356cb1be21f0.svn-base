<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.shop.mapper.ShopMapper">
	
	<!-- CommunityProfileVO -->
	<resultMap type="com.ohot.home.community.vo.CommunityProfileVO" id="communityProfileMapInfo">
		<result property="comProfileNo" column="COM_PROFILE_NO"/>
		<result property="memNo" column="MEM_NO"/>
		<result property="comNm" column="COM_NM"/>
		<result property="comFileGroupNo" column="COM_FILE_GROUP_NO"/>
		<result property="comJoinYmd" column="COM_JOIN_YMD"/>
		<result property="comDelyn" column="COM_DELYN"/>
		<result property="comAuth" column="COM_AUTH"/>
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<association property="artistGroupVO" resultMap="artistGroupMap"></association>
	</resultMap>
	
	<!-- artistGroupVO -->
	<resultMap type="com.ohot.vo.ArtistGroupVO" id="artistGroupMap">
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artGroupDebutYmd" column="ART_GROUP_DEBUT_YMD"/>
		<result property="artGroupNm" column="ART_GROUP_NM"/>
		<result property="artGroupExpln" column="ART_GROUP_EXPLN"/>
		<result property="artGroupRegYmd" column="ART_GROUP_REG_YMD"/>
		<result property="artGroupDelYn" column="ART_GROUP_DEL_YN"/>
		<association property="fileGroupVO" resultMap="fileGroupMap"></association>
	</resultMap>
	
	<!-- artistGroupVO : FILE_GROUP = 1 : 1 -->
	<resultMap type="com.ohot.vo.FileGroupVO" id="fileGroupMap">
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileRegdate" column="FILE_REGDATE"/>
		<collection property="fileDetailVOList" resultMap="fileDetailMap"></collection>
	</resultMap>
	
	<!-- FILE_GROUP : FILE_DETAIL = 1 : N -->
	<resultMap type="com.ohot.vo.FileDetailVO" id="fileDetailMap">
		<result property="fileSn" column="FILE_SN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
		<result property="fileSaveName" column="FILE_SAVE_NAME"/>
		<result property="fileSaveLocate" column="FILE_SAVE_LOCATE"/>
		<result property="fileSize" column="FILE_SIZE"/>
		<result property="fileExt" column="FILE_EXT"/>
		<result property="fileMime" column="FILE_MIME"/>
		<result property="fileFancysize" column="FILE_FANCYSIZE"/>
		<result property="fileSaveDate" column="FILE_SAVE_DATE"/>
		<result property="fileDowncount" column="FILE_DOWNCOUNT"/>
	</resultMap>
	
	<!-- 회원이 가입한 아티스트의 그룹번호 조회 -->
	<select id="communityProfileList" parameterType="com.ohot.vo.UsersVO" resultMap="communityProfileMapInfo">
		SELECT A.COM_PROFILE_NO, A.MEM_NO, A.COM_NM, A.COM_FILE_GROUP_NO, A.COM_JOIN_YMD, A.COM_DELYN, A.COM_AUTH, A.ART_GROUP_NO
		     , B.ART_GROUP_DEBUT_YMD, B.ART_GROUP_NM, B.ART_GROUP_EXPLN, B.ART_GROUP_REG_YMD, B.ART_GROUP_DEL_YN, B.FILE_GROUP_NO
		     , C.FILE_REGDATE
		     , D.FILE_SN, D.FILE_ORIGINAL_NAME, D.FILE_SAVE_NAME, D.FILE_SAVE_LOCATE, D.FILE_SIZE, D.FILE_EXT, D.FILE_MIME, D.FILE_FANCYSIZE, D.FILE_SAVE_DATE, D.FILE_DOWNCOUNT
  		FROM COMMUNITY_PROFILE A INNER JOIN ARTIST_GROUP B ON(A.ART_GROUP_NO = B.ART_GROUP_NO)
                           		 LEFT OUTER JOIN FILE_GROUP C ON (B.FILE_GROUP_NO = C.FILE_GROUP_NO)
                           		 LEFT OUTER JOIN FILE_DETAIL D ON (C.FILE_GROUP_NO = D.FILE_GROUP_NO)
		WHERE
			<choose>
				<when test='userNo != null and userNo != ""'>
					A.MEM_NO = #{userNo}
				</when>	
				<otherwise>
					A.MEM_NO = 6
				</otherwise>
			</choose>
	</select>
	
	<!-- 
	ARTIST_GROUP : GOODS = 1 : N
	GOODS : FILE_GROUP = 1 : 1
	FILE_GROUP : FILE_DETAIL = 1: N
	 -->
	<!-- ArtistGroupVO -->
	<resultMap type="com.ohot.vo.ArtistGroupVO" id="artstGroupMapInfo">
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artGroupDebutYmd" column="ART_GROUP_DEBUT_YMD"/>
		<result property="artGroupNm" column="ART_GROUP_NM"/>
		<result property="artGroupExpln" column="ART_GROUP_EXPLN"/>
		<result property="artGroupRegYmd" column="ART_GROUP_REG_YMD"/>
		<result property="artGroupDelYn" column="ART_GROUP_DEL_YN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<collection property="goodsVOList" resultMap="goodsMap"></collection>
	</resultMap>
	
	<!-- ARTIST_GROUP : GOODS = 1 : N -->
	<resultMap type="com.ohot.shop.vo.GoodsVO" id="goodsMap">
		<result property="qty" column="QTY"/>
		<result property="gdsDelYn" column="GDS_DEL_YN"/>
		<result property="gdsNo" column="GDS_NO"/>
		<result property="gdsType" column="GDS_TYPE"/>
		<result property="gdsNm" column="GDS_NM"/>
		<result property="unitPrice" column="UNIT_PRICE"/>
		<result property="expln" column="EXPLN"/>
		<result property="pic" column="PIC"/>
		<result property="regDt" column="REG_DT"/>
		<result property="commCodeGrpNo" column="COMM_CODE_GRP_NO"/>
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artNo" column="ART_NO"/>
		<result property="artGroupNm" column="ART_GROUP_NM"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<association property="fileGroupVO" resultMap="fileGroupMap"></association>
	</resultMap>
	
	<!-- goodsShop Artist Group List
	* 자식 테이블 쪽의 중복 컬럼은 제외하기
	 -->
	<select id="artstGroupList" parameterType="com.ohot.vo.UsersVO" resultMap="artstGroupMapInfo">
		SELECT A.ART_GROUP_NO, A.ART_GROUP_DEBUT_YMD, A.ART_GROUP_NM, A.ART_GROUP_EXPLN, A.ART_GROUP_REG_YMD, A.ART_GROUP_DEL_YN, A.FILE_GROUP_NO
		     , B.GDS_NO, B.GDS_TYPE, B.GDS_NM, B.UNIT_PRICE, B.EXPLN, B.PIC, B.REG_DT, B.COMM_CODE_GRP_NO, B.ART_NO, B.QTY, B.GDS_DEL_YN
		     , C.FILE_REGDATE
		     , D.FILE_SN, D.FILE_ORIGINAL_NAME, D.FILE_SAVE_NAME, D.FILE_SAVE_LOCATE, D.FILE_SIZE, D.FILE_EXT, D.FILE_MIME, D.FILE_FANCYSIZE, D.FILE_SAVE_DATE, D.FILE_DOWNCOUNT
  		FROM ARTIST_GROUP A INNER JOIN GOODS B ON(A.ART_GROUP_NO = B.ART_GROUP_NO)
                      LEFT OUTER JOIN FILE_GROUP C ON (B.FILE_GROUP_NO = C.FILE_GROUP_NO)
                      LEFT OUTER JOIN FILE_DETAIL D ON (C.FILE_GROUP_NO = D.FILE_GROUP_NO)
		WHERE A.ART_GROUP_NO IN ( SELECT ART_GROUP_NO
  								    FROM COMMUNITY_PROFILE
								  WHERE
									<choose>
										<when test='userNo != null and userNo != ""'>
											MEM_NO = #{userNo}
										</when>	
										<otherwise>
											MEM_NO = 6
										</otherwise>
									</choose>)
	</select>
	
	<!-- goodsShop Detail -->
	<select id="goodsDetail" parameterType="com.ohot.shop.vo.GoodsVO" resultMap="goodsMap">
		SELECT A.GDS_NO, A.GDS_TYPE, A.GDS_NM, A.UNIT_PRICE, A.EXPLN, A.PIC, A.REG_DT, A.COMM_CODE_GRP_NO, A.ART_GROUP_NO, A.ART_NO, A.FILE_GROUP_NO, A.QTY, A.GDS_DEL_YN
		     , B.FILE_REGDATE
		     , C.FILE_SN, C.FILE_GROUP_NO, C.FILE_ORIGINAL_NAME, C.FILE_SAVE_NAME, C.FILE_SAVE_LOCATE, C.FILE_SIZE
		     , C.FILE_EXT, C.FILE_MIME, C.FILE_FANCYSIZE, C.FILE_SAVE_DATE, C.FILE_DOWNCOUNT
             , D.ART_GROUP_NM
	  	FROM GOODS A LEFT OUTER JOIN FILE_GROUP B ON(A.FILE_GROUP_NO = B.FILE_GROUP_NO)
	                 LEFT OUTER JOIN FILE_DETAIL C ON(B.FILE_GROUP_NO = C.FILE_GROUP_NO)
                     LEFT OUTER JOIN ARTIST_GROUP D ON(A.ART_GROUP_NO = D.ART_GROUP_NO)
		WHERE A.ART_GROUP_NO = #{artGroupNo} AND A.GDS_NO = #{gdsNo}
	</select>
	
	<!-- goodsShop Insert -->
	<insert id="goodsShopInsert" parameterType="com.ohot.shop.vo.GoodsVO">
		<selectKey resultType="int" order="BEFORE" keyProperty="gdsNo">
			SELECT NVL(MAX(GDS_NO),0)+1 FROM GOODS
		</selectKey>
	
		INSERT INTO GOODS 
			(GDS_NO, GDS_TYPE, GDS_NM, UNIT_PRICE, EXPLN, PIC, REG_DT, COMM_CODE_GRP_NO, ART_GROUP_NO, FILE_GROUP_NO)
		 VALUES 
		 	(#{gdsNo}, #{gdsType}, #{gdsNm}, #{unitPrice}, #{expln}, #{pic}, SYSDATE, #{commCodeGrpNo}, #{artGroupNo}, #{fileGroupNo})
	</insert>
</mapper>