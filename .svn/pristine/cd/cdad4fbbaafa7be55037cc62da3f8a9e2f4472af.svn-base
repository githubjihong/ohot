<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div class="wrapper" class="sidebar-mini" style="height: auto;">

		<!-- 관리자 헤더네비바  -->
		<%@ include file="../adminHeader.jsp"%>

		<!-- 관리자 사이드바 -->
		<%@ include file="../adminSidebar.jsp"%>
		<!-- 신고관리 -->
		<div class="content-wrapper"><br>
		${ReportManageList }<br>

			<div class="container mt-4">
			<h2>신고 목록</h2>
				<div class="row">
					<div class="col-md-4">
						<label for="search" class="form-label">검색:</label> <input
							type="text" id="search" class="form-control"
							placeholder="이름, 전화번호 검색">
					</div>
					<div class="col-md-2 align-self-end">
						<button class="btn btn-primary">검색</button>
					</div>
				</div>
				<div class="nav nav-tabs">
					<a class="nav-link ${empty param.memberType ? 'active' : ''}" aria-selected="${empty param.memberType? 'true' : 'false' }" 
						href="/admin/Reportmanage/reportList?memberType=">전체보기</a>
					<a class="nav-link ${param.memberType eq 'M01' ? 'active' : ''}" aria-selected="${param.memberType eq 'M01' ? 'true' : 'false' }" 
						href="/admin/member/memberList?memberType=M01">게시글 신고</a>
					<a class="nav-link ${param.memberType eq 'M01' ? 'active' : ''}" aria-selected="${param.memberType eq 'M01' ? 'true' : 'false' }" 
						href="/admin/member/memberList?memberType=M01">댓글 신고</a>
					<a class="nav-link ${param.memberType eq 'M02' ? 'active' : ''}" aria-selected="${param.memberType eq 'M02' ? 'true' : 'false' }" 
						href="/admin/member/memberList?memberType=M02">디엠 신고</a>
				</div>
				<div class="tab-content" id="myTabContent">
					<div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
						<table class="table table-hover mt-3">
							<thead class="table-dark">
								<tr>
									<th>신고No</th>
									<th>신고No</th>
									<th>신고사유</th>
									<th>회원이름</th>
									<th>등록일시</th>
									<th>해지일시</th>
									<th>신고횟수</th>
									<th>회원번호</th>
									<th></th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								<c:forEach var="reportmanageVO" items="${ReportManageList}">
									<tr>
										<td>${reportmanageVO.reportPostNo }</td>
										<td>${reportmanageVO.reportTitle }</td>
										<td>${reportmanageVO.memName }</td>
										<td>${reportmanageVO.reportRegDt }</td>
										<td id="terminationStatus">${reportmanageVO.reportTermination}일</td>
										<td>${reportmanageVO.reportCnt }</td>
										<td>${reportmanageVO.memNo }</td>
										<td>
											<button type="button" class="btn btn-secondary"
												data-toggle="modal" data-target="#updateModal"
												id="updateReportmanage" onclick="updateReportmanage(${reportmanageVO.memNo})">신고상세</button>
										</td>
										<td>
											<button type="button" class="btn btn-danger"
												data-toggle="modal" id="deleteMember"
												onclick="deleteMember(${memberVO.memNo})">삭제</button>
										</td>
									</tr>
								</c:forEach>
							</tbody>
						</table>
					</div>
					<!-- 신고글 목록 -->
					
					<!-- 신고관리 상세보기 폼 -->
					<form id="editForm" name="editForm">
			<div class="modal" id="updateModal">
				<div
					class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
					<div class="modal-content">

						<!-- Modal Header -->
						<div class="modal-header">
							<h4 class="modal-title">신고상세</h4>
							<button type="button" class="close" data-dismiss="modal">&times;</button>
						</div>

						<!-- Modal body -->
						<div class="modal-body">
							<input type="hidden" id="memNo" name="memNo" /> <input
								type="hidden" id="fileGroupNo" name="fileGroupNo" />


							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고자</label>
								<div class="col-sm-8">
									<input type="text" id="memBirth" name="memBirth"
										class="form-control" />
									<code>* ex) 신고한 유저 이메일</code>
								</div>
							</div>
							
							
							<div class="form-group row">
								<label class="col-sm-4 col-form-label">피신고 회원번호</label>
								<div class="col-sm-8">
									<input type="text" id="memTelno" name="memTelno"
										class="form-control" />
								<code>* ex) 피신고자 번호</code>
								</div>
							</div>

							
							<div class="form-group row">
								<label class="col-sm-4 col-form-label">피신고 회원 이름</label>
								<div class="col-sm-8">
									<input type="text" id="memFirstName" name="memFirstName"
										class="form-control" />
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">피신고 회원 이메일</label>
								<div class="col-sm-8">
									<input type="text" id="memEmail" name="memEmail"
										class="form-control" />
								</div>
							</div>


							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고사유</label>
								<div class="col-sm-8">
									<input type="text" id="joinYmd" name="joinYmd"
										class="form-control" />
									<code>* ex) 부적절한 댓글입니다</code>
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고상세사유</label>
								<div class="col-sm-8">
									<input type="text" id="secsnYmd" name="secsnYmd"
										class="form-control" />
									<code>* ex) ...때문입니다</code>
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고조치</label>
								<div class="col-sm-8">
									<select class="form-select" aria-label="Default select example"
										name="memStatSecCodeNo">
										<option value="001">신고해지</option>
										<option value="002">활동정지(7일)</option>
									</select>
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">회원구분</label>
								<div class="col-sm-8">
									<select class="form-select" aria-label="Default select example"
										name="memSecCodeNo" onchange="checkMemSecCodeNo()">
										<option value="M01">일반회원</option>
										<option value="M02">아티스트</option>
									</select>
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고이미지</label>
								<div class="col-sm-8">
									<img src="/upload${reportmanageVO.pictureUrl}" />
	<!-- 								<input type="file" name="uploadFile" placeholder="상품이미지" /> -->
								</div>
							</div>
							
							<!-- 아티스트 정보 입력 폼  -->
							<div id="artistForm" style="display: none;">
								<input type="hidden" id="artNo" name="artNo" />
								<div class="form-group row">
									<label class="col-sm-4 col-form-label">활동명</label>
									<div class="col-sm-8">
										<input type="text" id="artActNm" name="artActNm"
											class="form-control" required />
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-4 col-form-label">아티스트 소개</label>
									<div class="col-sm-8">
										<input type="text" id="artExpln" name="artExpln"
											class="form-control" required />
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-4 col-form-label">아티스트 프로필 사진</label>
									<div class="col-sm-8">
										<div id="artImgPrev"></div>
										<input type="file" id="uploadFile" name="uploadFile"
											class="form-control" onChange="readFile(this)" required />
									</div>
								</div>
							</div>


						</div>

						<!-- Modal footer -->
						<div class="modal-footer">
							<button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
							<button type="button" class="btn btn-primary"
								data-dismiss="modal" onclick="editPost()">신고하기</button>
						</div>
					</div>
				</div>
			</div>
		</form>
					
					
				</div>
			</div>
		</div>
		
		<!-- 관리자 풋터 -->
		<%@ include file="../adminFooter.jsp"%>	
	</div>
	<script type="text/javascript">
	function updateReportmanageupdateReportmanage(memNo){
		fetch("/admin/member/memberEdit?memNo="+memNo).then(resp=>{
			
		}
	}
	</script>

</body>
<script type="text/javascript">
function editPost(){
	
	/* const editData = {
			"memNo" : editForm.memNo.value,
			"memLastName" : editForm.memLastName.value,
			"memFirstName" : editForm.memFirstName.value,
			"memEmail" : editForm.memEmail.value,
			"memTelno" : editForm.memTelno.value,
			"memBirth" : editForm.memBirth.value,
			"joinYmd" : editForm.joinYmd.value,
			"secsnYmd" : editForm.secsnYmd.value,
			"memStatSecCodeNo" : editForm.memStatSecCodeNo.value,
			"memSecCodeNo" : editForm.memSecCodeNo.value
			
	} */
	
	console.log("왔나용");
	for(let i=0; i< document.querySelector("#editForm").elements.length; i++){
		let elem = document.querySelector("#editForm").elements[i];
		console.log("name",elem.name, "value",elem.value);
	}

	//가상의 form : <form></form>
	let formData = new FormData(document.querySelector("#editForm"));  // encType 무조건 Multipart/form-data
	
	console.log("폼데이타"+ formData);
	
	let memSecCodeNo = $("select[name='memSecCodeNo']").val();
	//memSecCodeNo :  M02
	console.log("memSecCodeNo : ",memSecCodeNo);
	
	//회원구분이 아티스트일 경우 실행
	if(memSecCodeNo=="M02"){
		let files = $("#uploadFile")[0].files;
		
		formData.append("artistVO.artActNm",$("#artActNm").val());//활동명
		formData.append("artistVO.artExpln",$("#artExpln").val());//아티스트 소개
		formData.append("artistVO.fileGroupNo",$("#fileGroupNo").val());//아티스트 소개
		formData.append("artistVO.artNo",$("#artNo").val());
		formData.append("artistVO.fileGroupNo",$("#fileGroupNo").val());
		
		for(let i=0; i<files.length; i++){
			formData.append("artistVO.uploadFile",files[i]);//아티스트 프로필 사진
		}
	}
	
	fetch("/admin/member/memberEditPost", {
			method : "post",
			body : formData
			
	}).then(resp=>{
		console.log("resp :", resp);
		
		resp.json().then(data=>{
			console.log("회원정보업뎃 : ", data);
			alert("됐나");
			location.href = location.href;
			
		})
	})
}


function calculateTerminationDate(registrationDate) {
    // 등록일시를 Date 객체로 변환 (예: '2025-04-07')
    const regDate = new Date(registrationDate);

    // 오늘 날짜 가져오기
    const today = new Date();

    // 7일 뒤 날짜 계산
    const terminationDate = new Date(regDate);
    terminationDate.setDate(regDate.getDate() + 7); // 등록일에서 7일 더하기

    // 오늘 날짜와 해지일시의 차이 계산 (남은 일수)
    const diffTime = terminationDate - today;
    const remainingDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // 밀리초 -> 일수 변환

    if (remainingDays > 0) {
        // 남은 일수가 0 이상이면, 해지일시까지 남은 날 수를 출력
        return `${remainingDays}일 남음`;
    } else if (remainingDays === 0) {
        // 해지일시가 오늘이라면
        return "오늘 해지됨";
    } else {
        // 이미 해지일시가 지난 경우
        return "해지일시 지남";
    }
}

function updateReportmanage(memNo) {
    fetch("/admin/member/memberEdit?memNo=" + memNo)
        .then(resp => resp.json())
        .then(data => {
            // 등록일시를 받아서 해지일시 계산
            const reportRegDt = data.reportRegDt; // 예시로 '2025-04-07'
            const remainingDays = calculateTerminationDate(reportRegDt);

            // 해지일시를 표시하는 곳에 남은 일수 혹은 해지일시 지남 메시지 업데이트
            document.querySelector("#terminationStatus").innerText = remainingDays;

            // 필요하면 해지일시를 갱신하거나 다른 동작을 추가
        })
        .catch(error => console.error("Error fetching report details:", error));
}

</script>
</body>
</html>

