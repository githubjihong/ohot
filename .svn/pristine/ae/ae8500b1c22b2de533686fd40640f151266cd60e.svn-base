package com.ohot.shop.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ohot.home.community.vo.CommunityProfileVO;
import com.ohot.mapper.CommonCodeGroupMapper;
import com.ohot.service.MemberService;
import com.ohot.shop.service.ShopService;
import com.ohot.shop.service.TicketService;
import com.ohot.shop.vo.GoodsVO;
import com.ohot.util.UploadController;
import com.ohot.vo.ArtistGroupVO;
import com.ohot.vo.CommonCodeGroupVO;
import com.ohot.vo.CustomUser;
import com.ohot.vo.MemberVO;
import com.ohot.vo.UsersVO;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/shop")
public class ShopController {
	
	@Autowired
	ShopService shopService;
	
	@Autowired
	MemberService memberService;
	
	@Autowired
	CommonCodeGroupMapper commonCodeGroupMapper;
	
	@Autowired
	TicketService ticketService;
	
	// /shop 시리즈의 공통  model
	@ModelAttribute
	public void gongTong(Model model) {
		
		CommonCodeGroupVO commonCodeGroupVO = new CommonCodeGroupVO();
		commonCodeGroupVO.setCommCodeGrpNo("GD01");
		
		commonCodeGroupVO = this.commonCodeGroupMapper.commonCodeGroupList(commonCodeGroupVO);
		log.info("gongTong->commonCodeGroupVO : " + commonCodeGroupVO);
		
		//굿즈크기(GD01) : S/M/L
		model.addAttribute("commonCodeGroupVO", commonCodeGroupVO);
	}
	
	/* shop Main Home Page */
//	@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@GetMapping("/home")
	public String goodsForm(Model model, @AuthenticationPrincipal CustomUser customUser, @RequestParam(value = "tkCtgr", required = false) String tkCtgr) {
		
		UsersVO usersVO = null;
		
		if(customUser == null) {  //비회원이 홈페이지에 접속했을 경우
			model.addAttribute("title", "Recommended Artist");
			
			List<CommunityProfileVO> communityProfileVOList = shopService.communityProfileList(usersVO);
			log.info("communityProfileVOList : " + communityProfileVOList);
			
			//artistGroupVOList
			List<ArtistGroupVO> artistGroupVOList = shopService.artstGroupList(usersVO);
			log.info("artistGroupVOList : " + artistGroupVOList);
			
			model.addAttribute("communityProfileVOList", communityProfileVOList);
			model.addAttribute("artistGroupVOList", artistGroupVOList);
		}else {
			usersVO = customUser.getUsersVO();
			log.info("usersVO : "+ usersVO);
			
			model.addAttribute("title", "My Artist");
			
			List<CommunityProfileVO> communityProfileVOList = shopService.communityProfileList(usersVO);
			log.info("communityProfileVOList : " + communityProfileVOList);
			
			//artistGroupVOList
			List<ArtistGroupVO> artistGroupVOList = shopService.artstGroupList(usersVO);
			log.info("artistGroupVOList : " + artistGroupVOList);
			
			model.addAttribute("communityProfileVOList", communityProfileVOList);
			model.addAttribute("artistGroupVOList", artistGroupVOList);
			
			
		}
		List<GoodsVO> goodsVOList = this.ticketService.ticketList(tkCtgr);
		log.info("ticketList -> GoodsVO : "+goodsVOList);
		
		model.addAttribute("goodsVOList", goodsVOList);
		
		return "shop/home";
	}

	
	/* Goods Shop Detail */
	/* localhost:28080/shop/artistGroup/6/detail/24 */
	@GetMapping("/artistGroup/{artistGroup}/detail/{gdsNo}")
	public String goodsDetailForm(@PathVariable int artistGroup, @PathVariable int gdsNo, Model model) {
		
		// URL param 조회
		log.info("artistGroup : " + artistGroup);
		log.info("gdsNo : " + gdsNo);
		
		GoodsVO goodsVO = new GoodsVO();
		goodsVO.setArtGroupNo(artistGroup);
		goodsVO.setGdsNo(gdsNo);
		
		//Goods Shop artist
		goodsVO = shopService.goodsDetail(goodsVO);
		
		log.info("goodsVO : " + goodsVO);
		
		//goodsVO가 값이 없는 경우
		if(goodsVO == null ) {
			return "redirect:/shop/home";
		}else {
			model.addAttribute("goodsVO", goodsVO);
			return "shop/detail";
		}
	}
	
	/* Goods Shop orders*/
	@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@PostMapping("/ordersPost")
	public String goodsPostOrdersForm(ArtistGroupVO artistGroupVO, Model model, @AuthenticationPrincipal CustomUser customUser) {
		log.info("goodsPostOrdersForm->artistGroupVO : " + artistGroupVO);
		UsersVO usersVO = null;
		MemberVO memberVO = new MemberVO();
		
		//로그인 체크
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
		}else {
			usersVO = customUser.getUsersVO();
			memberVO.setMemNo((int)usersVO.getUserNo());
		}
		
		//Member 정보가져오기
		memberVO = memberService.memberDetail(memberVO);
		
		model.addAttribute("artistGroupVO", artistGroupVO);
		model.addAttribute("memberVO", memberVO);
		
		return "shop/orders";
	}
	
	/* ordersPostAjax: 미사용 코드(참조용) */
	@ResponseBody
	@PostMapping("/ordersPostAjax")
	public ArtistGroupVO goodsOrdersPost(@RequestBody ArtistGroupVO artistGroupVO) {
		log.info("artistGroupVO : "+ artistGroupVO);
		return artistGroupVO;
	}
	
	/* Goods Shop 등록 폼 */
	@GetMapping("/create")
	public String goodsCreateForm() {
		return "shop/create";
	}
	
	/* Goods Shop DB 저장 */
	@PostMapping("/createPost")
	public String goodsCreateFormPost(GoodsVO goodsVO) {
		
		log.info("goodsVO : " + goodsVO);
		
		int result = shopService.goodsShopInsert(goodsVO);
		
		return "shop/create";
	}
	

}