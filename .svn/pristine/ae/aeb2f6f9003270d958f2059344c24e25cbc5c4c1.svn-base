<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.mapper.MemberMapper">
	<!-- 회원가입 -->
	<insert id="signUp" parameterType="com.ohot.vo.MemberVO">
		<selectKey resultType="int" order="BEFORE" keyProperty="memNo">
			SELECT NVL(MAX(MEM_NO),0)+1 AS "신규 회원번호"
			FROM MEMBER
		</selectKey>
		INSERT INTO MEMBER ( MEM_NO, MEM_LAST_NAME, MEM_FIRST_NAME, MEM_EMAIL, MEM_PSWD)
		VALUES(#{memNo}, #{memLastName}, #{memFirstName}
				, #{memEmail}, #{memPswd})
	</insert>
	
	<!-- 기본으로 ROLD_MEM 권한 insert	-->
	<insert id="insertAuth" parameterType="com.ohot.vo.MemberVO">
		INSERT INTO AUTH(MEM_NO)
		VALUES (#{memNo})
	</insert>
	
	<select id="findByEmail" parameterType="string" resultMap="memberMap">
	    SELECT M.MEM_NO, M.MEM_LAST_NAME, M.MEM_FIRST_NAME, M.MEM_NICKNM
	            , M.MEM_EMAIL, M.MEM_TELNO, M.MEM_BIRTH, M.MEM_PSWD, M.JOIN_YMD
	            , M.SECSN_YMD, M.MEM_ACCESS_TOKEN, M.ENABLED
	            , M.MEM_STAT_SEC_CODE_NO, M.MEM_SEC_CODE_NO, M.MEM_DEL_YN
	            , A.MEM_NO, A.AUTH_NM
	    FROM MEMBER M, AUTH A
	    WHERE M.MEM_NO = A.MEM_NO
	    AND MEM_EMAIL = #{memEmail}
	    AND M.MEM_DEL_YN = 'N'
	</select>
	
	<resultMap type="com.ohot.vo.MemberVO" id="memberMap">
		<result property="rnum" column="RNUM"/>
		<result property="memNo" column="MEM_NO"/>
		<result property="memLastName" column="MEM_LAST_NAME"/>
		<result property="memFirstName" column="MEM_FIRST_NAME"/>
		<result property="memNicknm" column="MEM_NICKNM"/>
		<result property="memEmail" column="MEM_EMAIL"/>
		<result property="memTelno" column="MEM_TELNO"/>
		<result property="memBirth" column="MEM_BIRTH"/>
		<result property="memPswd" column="MEM_PSWD"/>
		<result property="joinYmd" column="JOIN_YMD"/>
		<result property="secsnYmd" column="SECSN_YMD"/>
		<result property="memAccessToken" column="MEM_ACCESS_TOKEN"/>
		<result property="enabled" column="ENABLED"/>
		<result property="memStatSecCodeNo" column="MEM_STAT_SEC_CODE_NO"/>
		<result property="memSecCodeNo" column="MEM_SEC_CODE_NO"/>
		<result property="memDelYn" column="MEM_DEL_YN"/>
		<result property="authNm" column="AUTH_NM"/>
		<association property="artistVO" resultMap="artistMap"></association>
		<collection property="authVOList" resultMap="authMap"></collection>
	</resultMap>
	
	<resultMap type="com.ohot.vo.ArtistVO" id="artistMap">
		<result property="artNo" column="ART_NO"/>
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artActNm" column="ART_ACT_NM"/>
		<result property="artExpln" column="ART_EXPLN"/>
		<result property="artRegYmd" column="ART_REG_YMD"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="memNo" column="MEM_NO"/>
		<result property="artDelYn" column="ART_DEL_YN"/>
		<association property="fileGroupVO" resultMap="fileGroupMap"></association>
	</resultMap>
	
	<resultMap type="com.ohot.vo.FileGroupVO" id="fileGroupMap">
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileRegdate" column="FILE_REGDATE"/>
		<collection property="fileDetailVOList" resultMap="fileDetailMap"></collection>
	</resultMap>
	
	<resultMap type="com.ohot.vo.FileDetailVO" id="fileDetailMap">
		<result property="fileSn" column="FILE_SN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
		<result property="fileSaveName" column="FILE_SAVE_NAME"/>
		<result property="fileSaveLocate" column="FILE_SAVE_LOCATE"/>
		<result property="fileSize" column="FILE_SIZE"/>
		<result property="fileExt" column="FILE_EXT"/>
		<result property="fileMime" column="FILE_MIME"/>
		<result property="fileFancysize" column="FILE_FANCYSIZE"/>
		<result property="fileSaveDate" column="FILE_SAVE_DATE"/>
		<result property="fileDowncount" column="FILE_DOWNCOUNT"/>
	</resultMap>
	
	<resultMap type="com.ohot.vo.AuthVO" id="authMap">
		<result property="memNo" column="MEM_NO"/>
		<result property="authNm" column="AUTH_NM"/>
	</resultMap>
	
	<!-- 회원 조회 -->
	<select id="memberList" resultType="com.ohot.vo.MemberVO">
		SELECT MEM_NO, MEM_LAST_NAME, MEM_FIRST_NAME, MEM_NICKNM, MEM_EMAIL, REGEXP_REPLACE(MEM_TELNO, '(.{3})(.{4})(.{4})', '\1-\2-\3') AS MEM_TELNO
			  , REGEXP_REPLACE(MEM_BIRTH, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS MEM_BIRTH, MEM_PSWD
			  , REGEXP_REPLACE(JOIN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS JOIN_YMD
			  , REGEXP_REPLACE(SECSN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS SECSN_YMD
			  , MEM_ACCESS_TOKEN, ENABLED, MEM_STAT_SEC_CODE_NO, MEM_SEC_CODE_NO, MEM_DEL_YN
		FROM MEMBER
		AND MEM_DEL_YN = 'N'
	</select>
	
	<!-- 회원 검색 조회 -->
	<select id="memberSearchList" resultMap="memberMap" parameterType="hashMap">
		SELECT S.*
		FROM
		(
			SELECT ROW_NUMBER() OVER(ORDER BY T.RNUM DESC) RRNUM, T.*
			FROM
			(
			    SELECT ROW_NUMBER() OVER(ORDER BY MEM_NO ASC) AS RNUM, MEM_NO, MEM_LAST_NAME, MEM_FIRST_NAME, MEM_NICKNM, MEM_EMAIL
	                  , REGEXP_REPLACE(MEM_TELNO, '(.{3})(.{4})(.{4})', '\1-\2-\3') AS MEM_TELNO
	                  , REGEXP_REPLACE(MEM_BIRTH, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS MEM_BIRTH, MEM_PSWD
	                  , REGEXP_REPLACE(JOIN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS JOIN_YMD
	                  , REGEXP_REPLACE(SECSN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS SECSN_YMD
	                  , MEM_ACCESS_TOKEN, ENABLED
	                  , FN_CODE_NO_TO_CODE_NM(MEM_STAT_SEC_CODE_NO) AS MEM_STAT_SEC_CODE_NO
	                  , FN_CODE_NO_TO_CODE_NM(MEM_SEC_CODE_NO) AS  MEM_SEC_CODE_NO
	                  , MEM_DEL_YN
	            FROM MEMBER
				WHERE 1 = 1
				AND MEM_DEL_YN = 'N'
				<include refid="where"></include>
			)T
		 )S
		WHERE S.RRNUM BETWEEN (#{currentPage} * #{size}) - (#{size} - 1) AND (#{currentPage} * #{size})
	</select>
	
	<sql id="where">
		<if test="keyword!=null and keyword!=''">
			AND (
			 	<choose>
			 		<when test="mode=='memEmail'">
			 			 MEM_EMAIL LIKE '%' || #{keyword} || '%'
			 		</when>
			 		<when test="mode=='memBirth'">
			 			 MEM_BIRTH LIKE '%' || #{keyword} || '%'
			 		</when>
			 		<otherwise>
			 			(MEM_EMAIL LIKE '%' || #{keyword} || '%' OR MEM_BIRTH LIKE '%' || #{keyword} || '%')
			 		</otherwise>
			 	</choose>
		 	)
		</if>		
	</sql>
	
	<select id="memberDetail" parameterType="com.ohot.vo.MemberVO">
		SELECT MEM_NO, MEM_LAST_NAME, MEM_FIRST_NAME, MEM_NICKNM, MEM_EMAIL, REGEXP_REPLACE(MEM_TELNO, '(.{3})(.{4})(.{4})', '\1-\2-\3') AS MEM_TELNO
			  , REGEXP_REPLACE(MEM_BIRTH, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS MEM_BIRTH, MEM_PSWD
			  , REGEXP_REPLACE(JOIN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS JOIN_YMD
			  , REGEXP_REPLACE(SECSN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS SECSN_YMD
			  , MEM_ACCESS_TOKEN, ENABLED, MEM_STAT_SEC_CODE_NO, MEM_SEC_CODE_NO
			  , MEM_DEL_YN
		FROM MEMBER
		WHERE MEM_NO = #{memNo}
		AND MEM_DEL_YN = 'N'
	</select>
	
	
	<update id="memberUpdate" parameterType="com.ohot.vo.MemberVO">
		UPDATE MEMBER
		SET	MEM_LAST_NAME = #{memLastName}, MEM_FIRST_NAME = #{memFirstName}, MEM_NICKNM = #{memNicknm}, MEM_EMAIL = #{memEmail}, MEM_TELNO = #{memTelno}
			  , MEM_BIRTH = #{memBirth}, JOIN_YMD = #{joinYmd}, SECSN_YMD= #{secsnYmd}, MEM_STAT_SEC_CODE_NO = #{memStatSecCodeNo}
			  , MEM_SEC_CODE_NO = #{memSecCodeNo}
		WHERE MEM_NO = #{memNo}
	</update>
	
	<select id="getTotalMember" parameterType="hashMap" resultType="int">
		SELECT COUNT(*)
		FROM MEMBER
		WHERE 1 = 1
		AND MEM_DEL_YN = 'N'
		<include refid="where"></include>
	</select>
	
	<update id="memberDelete" parameterType="int">
		UPDATE MEMBER
		SET MEM_DEL_YN = 'Y'
		WHERE MEM_NO = #{memNo}
	</update>
	
	<update id="authUpdate" parameterType="com.ohot.vo.MemberVO">
		UPDATE AUTH
		SET AUTH_NM = #{authNm}
	</update>
	
	<!-- 멤버테이블 정보도 가지고 있는 아티스트 회원 상세조회 모달에 뿌려줄 것  -->
	<select id="modalDetailInfo" resultMap="memberMap" >
		SELECT  M.MEM_NO, M.MEM_LAST_NAME, M.MEM_FIRST_NAME, M.MEM_NICKNM, M.MEM_EMAIL, M.MEM_TELNO
		, REGEXP_REPLACE(M.MEM_BIRTH, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS MEM_BIRTH
        , REGEXP_REPLACE(M.JOIN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS JOIN_YMD
        , REGEXP_REPLACE(M.SECSN_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS SECSN_YMD, M.MEM_STAT_SEC_CODE_NO, M.MEM_SEC_CODE_NO, M.MEM_DEL_YN
        , A.ART_NO, A.ART_GROUP_NO, A.ART_ACT_NM, A.ART_EXPLN, REGEXP_REPLACE(A.ART_REG_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS ART_REG_YMD 
        , A.FILE_GROUP_NO, A.ART_DEL_YN
        , FG.FILE_GROUP_NO, FG.FILE_REGDATE
        , FD.FILE_SN, FD.FILE_ORIGINAL_NAME, FD.FILE_SAVE_NAME, FD.FILE_SAVE_LOCATE, FD.FILE_SIZE, FD.FILE_EXT
        , FD.FILE_MIME, FD.FILE_FANCYSIZE, FD.FILE_SAVE_DATE, FD.FILE_DOWNCOUNT
		FROM MEMBER M 
		    LEFT OUTER JOIN ARTIST A ON(M.MEM_NO = A.MEM_NO)
		    LEFT OUTER JOIN FILE_GROUP FG ON(A.FILE_GROUP_NO = FG.FILE_GROUP_NO)
		    LEFT OUTER JOIN (
		         SELECT FILE_SN, FILE_GROUP_NO, FILE_ORIGINAL_NAME, FILE_SAVE_NAME
		                , FILE_SAVE_LOCATE, FILE_SIZE, FILE_EXT, FILE_MIME, FILE_FANCYSIZE
		                , FILE_SAVE_DATE, FILE_DOWNCOUNT, ROW_NUMBER() OVER (PARTITION BY FILE_GROUP_NO ORDER BY FILE_SN DESC) AS RN
		         FROM FILE_DETAIL
		    ) FD ON FG.FILE_GROUP_NO = FD.FILE_GROUP_NO AND FD.RN = 1
		WHERE A.ART_NO = #{artNo}
		ORDER BY ART_NO DESC
	</select>
	
</mapper>