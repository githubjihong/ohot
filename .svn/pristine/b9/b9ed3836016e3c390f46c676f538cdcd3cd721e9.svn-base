package com.ohot.controller;

import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ohot.service.MemberService;
import com.ohot.service.UsersService;
import com.ohot.vo.CustomUser;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/oho/mypage")
public class MyPageController {

	@Autowired
	UsersService usersService;

	@Autowired
	MemberService memberService;
	
	@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@GetMapping("")
	public String mypage(@AuthenticationPrincipal CustomUser customUser) {

		if (customUser != null) {
			return "mypage/inquiries";
		} else {
			return "redirect:login?error";
		}

	}

	@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@ResponseBody
	@PutMapping("/editInfo")
	public String editInfo(@RequestBody Map<String, Object> param, @AuthenticationPrincipal CustomUser customUser) {
		log.info("param : " + param);
		log.info("editInfo -> cutomUser : " + customUser);

		if (customUser != null) {
			int memNo = (int) customUser.getUsersVO().getUserNo();
			
			Map<String, Object> map = new HashMap<>();
			map.put("memNo", memNo);

			if (param.get("type").equals("memNicknm")) {
				String memNicknm = (String) param.get("info1");
				map.put("memNicknm", memNicknm);

				int result = this.memberService.editInfo(map);
				if (result > 0) {
					return "success";
				} else {
					return "fail";
				}
			}

			if (param.get("type").equals("memTelno")) {
				String memTelno = (String) param.get("info1");
				map.put("memTelno", memTelno);
				int result = this.memberService.editInfo(map);
				if (result > 0) {
					return "success";
				} else {
					return "fail";
				}
			}

			if (param.get("type").equals("memPswd")) {
				String memPswd = (String) param.get("info1");
				map.put("memPswd", memPswd);
				int result = this.memberService.editInfo(map);
				if (result > 0) {
					return "success";
				} else {
					return "fail";
				}
			}

			if (param.get("type").equals("name")) {
				String memLastName = (String) param.get("info1");
				String memFirstName = (String) param.get("info2");
				map.put("memLastName", memLastName);
				map.put("memFirstName", memFirstName);

				int result = this.memberService.editInfo(map);
				if (result > 0) {
					return "success";
				} else {
					return "fail";
				}
			}
		} 
		return "unMember";
	}

}
