<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/adminlte/dist/css/adminlte.min.css" />
<link rel="stylesheet" href="/shop/main.css" />
<!-- https://github.com/SortableJS/jquery-sortablejs -->

</head>
<body class="sidebar-mini layout-fixed" style="height: auto;">
  <div class="wrapper">	
  <!-- 관리자 헤더네비바  -->
  <%@ include file="../adminHeader.jsp"%>
	
  <!-- 관리자 사이드바 -->
  <%@ include file="../adminSidebar.jsp"%>
	
	<!-- sec 영역 -->
    <sec:authorize access="isAuthenticated()">
      <sec:authentication property="principal.usersVO" var="userVO" />
    </sec:authorize>
	
    <div class="content-wrapper">
	  <!-- 상품 등록 페이지 메인 컨테이너 -->
	  <div class="d-flex justify-content-left m-3">
	    <!-- form 영역 -->
	    <form action="/admin/shop/adGoodsCreatePost" id="goodsForm" method="post" enctype="multipart/form-data" onsubmit="fetchAjax()">
	    <div class="row">
	      <!-- [좌측] 상품 이미지 대표 영역 -->
	      <div class="col-12 col-sm-6" style="border-radius: 10px; width: 1000px; height: 650px;" id="thumbnailImg">
	        <img src="/images/imageAppend.png" 
	          class="product-image" style="border-radius: 10px;" alt="Product Thumbnail">
	        
	        <div class="col-12 product-image-thumbs justify-content-center" style="margin-top: 20px;" id="thumbImg">
	          
	          <div class="product-image-thumb" style="margin-right: 0px;">
		        <img src="/images/imageAppend.png" 
	          class="product-image" alt="Product Thumbnail">
 		      </div>
	        </div>  
	      </div>
	      
	      <!-- [우측] 상품 등록 Form 영역 -->
	      <div class="col-12 col-sm-6">
	        <div class="p-4 bg-light rounded border ms-3" style="min-height: 730px;">
	          <h5 class="fw-bold mb-4">상품 정보 입력</h5>
	          
	          
	          	<!-- input -->
	          	<input type="hidden" name="gdsNo" id="gdsNo" value="0">
	          	
	            <!-- 상품명 -->
    		    <div class="mb-3">
      		      <label for="gdsNm" class="form-label">상품명</label>
      			  <input type="text" class="form-control" id="gdsNm" name="gdsNm" placeholder="예: 핑크 토끼 인형">
    		    </div>
    		    
    		    <!-- 상품유형 -->
    		    <div class="mb-3">
      		      <label for="gdsType" class="form-label">상품유형</label>
      		      <select class="form-select" name="gdsType" id="gdsType">
      		        <c:forEach var="commonDetailCodeVO" items="${commonCodeGroupVOGdsType.commonDetailCodeVOList}">
      		          <option value="${commonDetailCodeVO.commDetCodeNm}" 
      		            <c:if test="${commonDetailCodeVO.commDetCodeNm == 'G' ? 'selected=selected' : ''}"></c:if>>
      		            ${commonDetailCodeVO.commDetCodeNm}</option>
      		        </c:forEach>
      		      </select>
      		    </div>
      		    
      		    <!-- 그룹명 -->
    		    <div class="mb-3">
      		      <label for="artGroupNo" class="form-label">그룹명</label>
      		      <select class="form-select" name="artGroupNo" id="artGroupNo">
      		        <c:forEach var="artistGroupVO" items="${artistGroupVOList}">
      		            <option value="${artistGroupVO.artGroupNo}">
      		           	  ${artistGroupVO.artGroupNm}</option>
      		        </c:forEach>
      		      </select>
      		    </div>
      		    
      		    <div class="mb-3">
      		      <label for="unitPrice" class="form-label">가격</label>
      		      <input type="text" class="form-control" id="unitPrice" name="unitPrice" placeholder="예: 핑크 토끼 인형">
    		    </div>
    		    <div class="mb-3">
      		      <label for="expln" class="form-label">설명</label>
      		      <input type="text" class="form-control" id="expln" name="expln" placeholder="예: 핑크 토끼 인형">
    		    </div>
    		    <div class="mb-3">
      		      <label for="pic" class="form-label">담당자</label>
      		      <input type="text" class="form-control" id="pic" name="pic" readonly value="${userVO.employeeVO.empNm}" placeholder="예: 핑크 토끼 인형">
    		    </div>
    		    
    		    <div class="mb-3">
				  <label for="uploadFile" class="form-label fw-semibold">파일 첨부</label>
				  <input class="form-control" type="file" id="uploadFile" name="uploadFile" multiple>
				  <div class="form-text">여러 파일을 선택할 수 있어요.</div>
				</div>
    		    
    		    <div class="mb-3">
      		      <button class="btnForm" name="CreatePost" type="submit">저장하기</button>
      		      <button class="btnForm" name="" type="button">목록보기</button>
      		      <button class="btnForm" name="UpdatePost" type="submit">수정하기</button>
      		      <button class="btnForm" name="DeletePost" type="submit">삭제하기</button>
    		    </div>
	        </div>
	  	  </div>
	    </div>
	    </form>
	  </div>
    </div>
  </div>
  
  <!-- 관리자 풋터 -->
  <%@ include file="../adminFooter.jsp"%>
</body>

<script type="text/javascript">
$(function(){
	//file이 등록되었을 때 이미지를 읽어들이기
	$("input[name='uploadFile']").on("change", fn_handleImgFileSelect);
	
	//?gdsNo가 있는지 체크..?
	fn_init();
	
	$(".product-image-thumbs").sortable({
		//정렬이 완료되었을 경우.. 
		stop: function( event, ui){
			console.log("정렬 완료!")
			img_fnSetting();
			
		}
	});
})

//순서 정렬이 완료된 후 이미지 fn를 새롭게 설정
function img_fnSetting(){
	//img fn 값 설정
	
	//값 찾아오기
	let name = document.getElementById("thumbImg").getElementsByClassName("fileSn");
	
	let fnList = Array.from(name)
	
	fnList.forEach( (item, idx) => {
		
		 let name = $(item).prop('name', `fileGroupVO.fileDetailVOList[\${idx}].fileSn`);
		 console.log(item);
		
		//item.val(idx+1);
	})
}


function fn_init(){
	//?
	let fullPath = $(location).attr('search');
	
	//?gdsNo=79
	console.log(fullPath);
	
	//form data 가져오기
	const formData = new FormData($("#goodsForm")[0]);
	
	if(fullPath){
		let goodsVO = ${jsonStr};
		console.log(goodsVO);
		for(const key of formData.keys()){
			$("#" + key).val(goodsVO[key]);
		}
		
		//이미지 가져오기
		let fileDetailVOList = goodsVO.fileGroupVO.fileDetailVOList;
		
		$("#thumbnailImg > img").remove();	//직계자식 찾아서 요소를 비움
		$("#thumbImg > div").remove();
		fileDetailVOList.forEach((item, idx)=> {
			if(idx == 0){
				$("#thumbnailImg").prepend( `<img src="/upload/\${item.fileSaveLocate}"
				  class="product-image" alt="Product Thumbnail" style="border-radius: 10px; width: 1000px; height: 650px;" />`);
			}
			
			$("#thumbImg").append(`<div class="product-image-thumb" style="margin-right: 0px;"> <img src="/upload/\${item.fileSaveLocate}" 
      	  	  class="product-image" alt="Product Thumbnail" /> 
			<input type='hidden' class="fileSn" name='fileGroupVO.fileDetailVOList[\${idx}].fileSn' value='\${item.fileSn}'/>
				<input type='hidden' name='fileGroupVO.fileDetailVOList[\${idx}].fileGroupNo' value='\${item.fileGroupNo}'/> </div> `);
		})
	}
}

/* sample Code: https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL */
function fn_handleImgFileSelect(e) {
	let files = e.target.files;
	
	function readAndPreView(file, idx){
		
		//match 정규표현식과 일치하는 결과리턴
		//f,type: MIME 표현형식("image/png", "image.jpeg")
		if(file.type.match("image.*")){
			//파일 읽어오기
			const reader = new FileReader();
			
			reader.onload = function(e){
				console.log(e);
				
				if(idx == 0){
					$("#thumbnailImg > img").remove();	//직계자식 찾아서 요소를 비움
					$("#thumbnailImg").prepend( `<img src="\${e.target.result}" 
			            	  					class="product-image" alt="Product Thumbnail" style="border-radius: 10px; width: 1000px; height: 650px;" />`);
				
					$("#thumbImg > div").remove();
					$("#thumbImg").append(`<div class="product-image-thumb" style="margin-right: 0px;"> <img src="\${e.target.result}" 
	            	  class="product-image" alt="Product Thumbnail" /> </div>`);
				}else{
					$("#thumbImg").append(`<div class="product-image-thumb" style="margin-right: 0px;"> <img src="\${e.target.result}" 
	            	  class="product-image" alt="Product Thumbnail" /> </div>`);
				}
			}
			
			reader.readAsDataURL(file);
		}
	}
	
	if(files){
		Array.prototype.forEach.call(files, readAndPreView);
	}else {	//이미지 파일이 아닐 때 끝내기
		return;	
	}
}

//클릭한 버튼에 따라 Form action 값 변경 메소드
$(".btnForm").on('click', function(){
	console.log("클릭한 버튼의 이름 값은 : " + $(this).attr("name"));
	
	let urlLink = $(this).attr("name");
	
	$("#goodsForm").prop("action" , "/admin/shop/adGoods" + urlLink);
	
})

/* form  */
function fetchAjax() {
	console.log("dsfasdfasdfasdfas");
	event.preventDefault();
	
	const formData = new FormData(event.currentTarget);
	let actionLink = $("#goodsForm").attr("action");

	fetch(actionLink, {
	    method: "post",
	    body: formData
	  }).then(resp => {
		console.log(resp);		  
	})
}

</script>
<script src="/js/sortable/jquery-ui.min.js"></script>
<!-- https://www.tutorialspoint.com/jqueryui/jqueryui_sortable.htm -->
<!-- https://api.jqueryui.com/sortable/#event-activate -->
<!-- https://github.com/SortableJS/jquery-sortablejs -->
<script src="/js/sortable/Sortable.js"></script>
</html>