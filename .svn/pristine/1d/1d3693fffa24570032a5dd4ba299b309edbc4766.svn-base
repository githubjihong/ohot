<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <%@include file="../header.jsp" %>
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <title>${communityProfileVO.comNm} - 프로필</title>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .profile-container {
            max-width: 600px;
            background: white;
            border-radius: 50px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: auto;
            margin-top: 50px;
        }
        .profile-img {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            margin: 0 auto;
            border: 3px solid #ddd;
            cursor: pointer;
            
        }
        .profile-img2 {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
            margin: 0 auto;
            border: 3px solid #ddd;
            cursor: pointer;
            
        }
        .follow-btn {
            background-color: #1c1c1c;
            color: white;
            width: 20%;
        }
        .follow-btn:hover {
            background-color: #333;
        }
        .count-box {
            text-align: center;
        }
        .count-box h4 {
            margin-bottom: 0;
        }
        .post-card {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .upload-btn {
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }
        .form-control {
            font-size: 16px;
        }
        .btn-custom {
            background-color: #1c1c1c;
            color: white;
            width: 100%;
            font-size: 16px;
        }
        .btn-custom:hover {
            background-color: #333;
        }
    </style>
</head>
<body>

<sec:authorize access="isAuthenticated()">
   <sec:authentication property="principal.usersVO" var="userVO"/>
</sec:authorize>
${userVO}
<form id="userInfo" name="userInfo" >
<input type="hidden" id="userNo" name="userNo" value="${userVO.userNo }">
</form>
<div class="profile-container">
    <div>
        <button type="button"  style="display: inline-block;" class="btn btn-secondary w-20 mt-2" onclick="fn_move_list();">게시글 목록</button>
    </div>
    <div class="text-center">
    <c:choose>
        <c:when test="${not empty communityProfileVO.fileGroupVO.fileDetailVOList}">
            <c:forEach var="fileDetailVO" items="${communityProfileVO.fileGroupVO.fileDetailVOList}">
                <img src="/upload${fileDetailVO.fileSaveLocate}" class="profile-img" onclick="openImageModal(this.src)">
            </c:forEach>
        </c:when>
    <c:otherwise>       	
            <img src="/images/default-profile.png" class="profile-img" onclick="openImageModal(this.src)">
    </c:otherwise>
    </c:choose>
	</div>
<!-- 팔로잉 리스트 모달 -->
<div class="modal fade" id="followingModal" tabindex="-1" aria-labelledby="followingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0 text-center d-block">
        <h5 class="modal-title fw-bold" id="followingModalLabel">${communityProfileVO.comNm}님의 팔로잉</h5>
      </div>


		<!-- 리스트 추가되는 곳 -->
	  <div id="followingList"></div>
	  
	  
      <div class="modal-footer border-0 d-flex justify-content-center">
        <button type="button" class="btn btn-secondary w-100 rounded-pill" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
	<div class="text-center">
	<label class="form-label fw-bold">${communityProfileVO.comNm}님의 프로필</label>
	</div>
    <div class="row mt-4">
    	<div class="col count-box">
            <h4 class="fw-bold">${followerCnt}</h4>
            <p class="text-muted">팔로워</p>
        </div>
        <div class="col count-box">
        <c:if test="${userVO.userNo == communityProfileVO.memNo }">
            <h4 class="fw-bold">${followingCnt}</h4>
            <!-- 세션 넘버와 communityProfileNo 와 같으면 보여줌 아마 모달? -->
            
            <a href="/oho/community/followingList?comProfileNo=${communityProfileVO.comProfileNo }" class="text-muted" onclick="openFollowingModal(); return false;">팔로잉</a>
            </c:if>
        </div>

    </div>
    ${communityProfileVO }
    <c:if test="${userVO.userNo == communityProfileVO.memNo }">
    <div class="mt-4">
       <button type="submit" class="btn btn-custom" onclick="fn_edit_profile()" style="background-color: rgb(71, 223, 172);">프로필 수정</button>
    </div>
    </c:if>
</div>
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid">
      </div>
    </div>
  </div>
</div>
<!-- 탭 메뉴 -->
<div class="container mt-4">
    <ul class="nav nav-tabs" id="profileTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#posts">게시물</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#media">미디어</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#about">소개</button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="posts">
            <div class="row">
                <c:forEach var="post" items="${communityPostVO}">
                    <div class="col-md-6 offset-md-3 mb-4">
                        <div class="card post-card">
                            <div class="card-header bg-white d-flex align-items-center">
                                <img src="${post.profileImage}" class="rounded-circle me-2" width="40" height="40" onclick="openImageModal(this.src)">
                                <a href="/profile?comProfileNo=${post.comProfileNo}" class="text-dark text-decoration-none fw-bold">${post.comNm}</a>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title fw-bold">${post.boardTitle}</h5>
                                <img src="${post.postImage}" class="img-fluid rounded mb-3" onclick="openImageModal(this.src)">
                                <p class="card-text">${post.boardContent}</p>
                            </div>
                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                <button class="btn btn-light" onclick="fn_board_likeYn(${post.boardNo})">
                                    ❤️ <span id="boardLikeCnt${post.boardNo}">${post.boardLikeCnt}</span>
                                </button>
                                <button class="btn btn-light" onclick="fn_load_replies(${post.boardNo})">
                                    💬 댓글 <span id="repCnt${post.boardNo}">(${post.replyList.size()})</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </c:forEach>
            </div>
        </div>
        <div class="tab-pane fade" id="media">
            <p>미디어 콘텐츠</p>
        </div>
        <div class="tab-pane fade" id="about">
            <p>소개 내용</p>
        </div>
    </div>
</div>

<%@ include file="../footer.jsp" %>
</body>
<script type="text/javascript">
<!-- 팔로잉 버튼 클릭 시 모달 열기 -->
let userNo =  $("form[name='userInfo']").find('#userNo').val();
//사진 클릭 시 크게 보이게하는 기능
function openImageModal(src) {
    document.getElementById("modalImage").src = src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
  }

function openFollowingModal() {
    $.ajax({
      url: "/oho/community/followingList",
      contentType:"application/json; charset=utf-8",
      type: "GET",
      data: { "comProfileNo": ${communityProfileVO.comProfileNo} },
      success: function(data) {
        let followingList = "";
        data.forEach(communityProfile => {
          followingList += `
              <div class="modal-body p-4" style="max-height: 400px; overflow-y: auto;">
              <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
		                <c:choose>
		                <c:when test="\${not empty communityProfile.fileGroupVO.fileDetailVOList}">
		                      <c:forEach var="fileDetailVO" items="\${communityProfile.fileGroupVO.fileDetailVOList}">
		                            <img src="/upload\${communityProfile.fileSaveLocate}" class="profile-img2" onclick="openImageModal(this.src)">
		                      </c:forEach>
		                </c:when>
		                <c:otherwise>
		                        <img src="/images/default-profile.png" class="profile-img2" onclick="openImageModal(this.src)">
		                </c:otherwise>
		                </c:choose>
                      <span class="ms-3 fw-bold">\${communityProfile.comNm}</span>
                    </div>
                    
                    <button class="btn btn-outline-secondary btn-sm" >팔로잉</button>
                   
                  </li>
              </ul>
            </div>`;
        });
        $("#followingList").html(followingList);
        var modal = new bootstrap.Modal(document.getElementById('followingModal'));
        modal.show();
      },
      error: function() {
        alert("팔로잉 목록을 불러오는데 실패했습니다.");
      }
    });
  }

  function fn_edit_profile(){
      location.href="/oho/community/editProfile?comProfileNo="+${communityProfileVO.comProfileNo};
  }
  function fn_move_list(){
	  location.href="/oho/community/fanBoardList?comProfileNo="+${communityProfileVO.comProfileNo};
  }
</script>



</html>
