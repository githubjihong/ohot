<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
<!-- <script src="https://cdn.ckeditor.com/ckeditor5/45.0.0/ckeditor5.umd.js"></script> -->
</head>
<body>
	<%@ include file="/WEB-INF/views/header.jsp"%>

	<sec:authorize access="isAuthenticated()">
		<sec:authentication property="principal.usersVO" var="userVO" />
	</sec:authorize>
	<c:set var="memberVO" value="${userVO.memberVO}" />
	<p>유저 정보</p>
	${userVO}
	<p>유저 상세 정보</p>
	${memberVO}
	<p>수정될 글 정보</p>
	${boardPostVO}

	<!-- 본문 시작 -->
	<div class="container py-5">
		<h2>게시글 작성</h2>
		<h6>비회원은 글을 수정 또는 삭제할 수 없습니다.</h6>
		<br>
		<!-- 게시글 수정일 경우 -->
		<c:if test="${boardPostVO != null }">
			<form action="/oho/inquiryPost/editPost" id="frmEditSubmit"
				method="post">
				<input type="hidden" name="bbsPostNo"
					value="${boardPostVO.bbsPostNo}" /> <label for="bbsType">문의유형</label>
				<select name="inqTypeNo">
					<c:forEach var="inqType" items="${inqTypeVOList}">
						<option value="${inqType.inqTypeNo}">${inqType.inqTypeNm}</option>
					</c:forEach>
				</select> <br> <label for="bbsTitle">제목:</label><br> <input
					name="bbsTitle" value="${boardPostVO.bbsTitle}" required><br>
				<label>작성자:</label><br> <input
					value="${boardPostVO.inquiryPostVO.inqWriter}" disabled><br>
				<br> <label for="inqPswd">비밀번호 (숫자4자리)</label><br> <input
					name="inqPswd" value="${boardPostVO.inquiryPostVO.inqPswd}"
					maxlength="4"
					oninput="this.value = this.value.replace(/[^0-9]/g, '')"><br>

				<textarea name="bbsHtmlCn" id="editor1" rows="10" cols="80">
			        	${boardPostVO.bbsHtmlCn}
			        </textarea>
				<br>
				<br>
				<!-- plain text 저장을 위한 hidden input -->
				<input type="hidden" id="plainText" name="bbsCn"> <input
					type="button" id="saveBtn" value="저장"> <input type="button"
					id="cancelBtn" value="취소">
			</form>
		</c:if>

		<!-- 새로운 게시글 등록일 경우 -->
		<c:if test="${boardPostVO == null }">
			<form action="/oho/inquiryPost/createPost" id="frmSubmit"
				method="post">
				<input type="hidden" name="bbsPostNo" value="${boardNo}" /> <label
					for="bbsType">문의유형</label> <select name="inqTypeNo">
					<c:forEach var="inqType" items="${inqTypeVOList}">
						<option value="${inqType.inqTypeNo}">${inqType.inqTypeNm}</option>
					</c:forEach>
				</select> <br> <label for="bbsTitle">제목:</label><br> <input
					name="bbsTitle" required><br>
				<c:choose>
					<c:when test="${userVO != null}">
						<label>작성자:</label>
						<br>
						<input value="${userVO.userMail}" disabled>
						<br>
						<br>
					</c:when>
					<c:otherwise>
						<label for="writer">작성자:</label>
						<br>
						<input name="writer" required>
						<br>
						<br>
					</c:otherwise>
				</c:choose>
				<label for="inqPswd">비밀번호 (숫자4자리)</label><br> <input
					name="inqPswd" maxlength="4"
					oninput="this.value = this.value.replace(/[^0-9]/g, '')"><br>

				<textarea name="bbsHtmlCn" id="editor1" rows="10" cols="80"></textarea>
				<br>
				<br>
				<!-- plain text 저장을 위한 hidden input -->
				<input type="hidden" id="plainText" name="bbsCn"> <input
					type="button" id="submitBtn" value="등록"> <input
					type="button" id="cancelBtn" value="취소">
			</form>
		</c:if>
	</div>
	<!-- 본문 끝 -->

	<!--  CKEitor 적용 -->
	<script>
        // CKEditor 적용
        CKEDITOR.replace("editor1");

        
        const submitBtn = document.getElementById("submitBtn");
        if (submitBtn) {
            submitBtn.addEventListener("click", () => {
            	 const htmlContent = CKEDITOR.instances.editor1.getData();
                 console.log("htmlContent : ", htmlContent);
                 
                 // HTML을 임시 div에 넣고 textContent만 추출
                 const tempDiv = document.createElement("div");
                 tempDiv.innerHTML = htmlContent;
                 const plainText = tempDiv.textContent || tempDiv.innerText || "";
                 console.log("plainText : ", plainText);
                 
                 // hidden input에 plain text 저장
                 document.getElementById("plainText").value = plainText;
                 
                 const form = document.querySelector("#frmSubmit");
                 
              // required 검사
                 if (form.checkValidity()) {
                     form.submit(); // 통과하면 제출
                 }else {
                     form.reportValidity(); // 실패 시 오류 메시지 표시
                 }
            });
        }
        
        const saveBtn = document.getElementById("saveBtn");
        if (saveBtn) {
            saveBtn.addEventListener("click", () => {
            	const htmlContent = CKEDITOR.instances.editor1.getData();
	            console.log("htmlContent : ", htmlContent);
	            
	            // HTML을 임시 div에 넣고 textContent만 추출
	            const tempDiv = document.createElement("div");
	            tempDiv.innerHTML = htmlContent;
	            const plainText = tempDiv.textContent || tempDiv.innerText || "";
	            console.log("plainText : ", plainText);
	            
	            // hidden input에 plain text 저장
	            document.getElementById("plainText").value = plainText;
	            
	            document.querySelector("#frmEditSubmit").submit();
        	})
    	}
        
        const cancelBtn = document.getElementById("cancelBtn");
        if(cancelBtn) {
        	cancelBtn.addEventListener("click", () => {
        		location.href="/oho/inquiryPost"
        	})
        }
    </script>
	<%@ include file="/WEB-INF/views/footer.jsp"%>
</body>
</html>