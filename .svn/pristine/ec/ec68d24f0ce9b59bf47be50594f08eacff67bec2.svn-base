package com.ohot.shop.controller;

import java.util.List;
import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ohot.home.community.vo.CommunityProfileVO;
import com.ohot.mapper.CommonCodeGroupMapper;
import com.ohot.mapper.SeqGeneratorMapper;
import com.ohot.service.BannerFileService;
import com.ohot.service.MemberService;
import com.ohot.shop.service.ShopService;
import com.ohot.shop.service.TicketService;
import com.ohot.shop.vo.GoodsVO;
import com.ohot.vo.ArtistGroupVO;
import com.ohot.vo.BannerFileVO;
import com.ohot.vo.CommonCodeGroupVO;
import com.ohot.vo.CustomUser;
import com.ohot.vo.MemberVO;
import com.ohot.vo.SeqGeneratorVO;
import com.ohot.vo.UsersVO;

import jakarta.servlet.http.HttpSession;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/shop")
public class ShopController {
	
	@Autowired
	ShopService shopService;
	
	@Autowired
	MemberService memberService;
	
	@Autowired
	CommonCodeGroupMapper commonCodeGroupMapper;
	
	@Autowired
	SeqGeneratorMapper seqGeneratorMapper;
	
	@Autowired
	TicketService ticketService;
	
	@Autowired
	BannerFileService bannerFileService;
	
	// /shop 시리즈의 공통  model
	@ModelAttribute
	public void gongTong(Model model) {
		
		CommonCodeGroupVO commonCodeGroupVO = new CommonCodeGroupVO();
		commonCodeGroupVO.setCommCodeGrpNo("GD01");
		
		commonCodeGroupVO = this.commonCodeGroupMapper.commonCodeGroupList(commonCodeGroupVO);
		log.info("gongTong->commonCodeGroupVO : " + commonCodeGroupVO);
		
		//굿즈크기(GD01) : S/M/L
		model.addAttribute("commonCodeGroupVO", commonCodeGroupVO);
	}
	
	/* shop Main Home Page */
	@GetMapping("/home")
	public String goodsForm(Model model, @AuthenticationPrincipal CustomUser customUser, @RequestParam(value = "tkCtgr", required = false) String tkCtgr) {
		
		UsersVO usersVO = null;
		
		if(customUser == null) {  //비회원이 홈페이지에 접속했을 경우
			model.addAttribute("title", "Recommended Artist");
			
			List<CommunityProfileVO> communityProfileVOList = shopService.communityProfileList(usersVO);
			log.info("communityProfileVOList : " + communityProfileVOList);
			
			//artistGroupVOList
			List<ArtistGroupVO> artistGroupVOList = shopService.artstGroupList(usersVO);
			log.info("artistGroupVOList : " + artistGroupVOList);
			
			model.addAttribute("communityProfileVOList", communityProfileVOList);
			model.addAttribute("artistGroupVOList", artistGroupVOList);
		}else {	//회원 접속
			usersVO = customUser.getUsersVO();
			log.info("usersVO : "+ usersVO);
			
			model.addAttribute("title", "My Artist");
			
			List<CommunityProfileVO> communityProfileVOList = shopService.communityProfileList(usersVO);
			log.info("communityProfileVOList : " + communityProfileVOList);
			
			//artistGroupVOList
			List<ArtistGroupVO> artistGroupVOList = shopService.artstGroupList(usersVO);
			log.info("artistGroupVOList : " + artistGroupVOList);
			
			model.addAttribute("communityProfileVOList", communityProfileVOList);
			model.addAttribute("artistGroupVOList", artistGroupVOList);
		}
		
		//BannerList
		//TASK_SE_NM(업무구분명으로 조회)
		String taskSeNm = "shop";
		List<BannerFileVO> bannerFileVOList = bannerFileService.bannerFileList(taskSeNm);
		log.info("bannerFileVOList : " + bannerFileVOList);
		
		//artist 그룹목록 가져오기
		int limit = 3;
		List<ArtistGroupVO> topArtistsList = shopService.topArtistsList(limit);
		log.info("topArtistsList : " + topArtistsList);
		
		//artist 최상위그룹(1번)에 대한 굿즈 목록 가져오기
		ArtistGroupVO artistGroupVO = topArtistsList.get(0);
		List<ArtistGroupVO> topArtist = shopService.topArtistGoodsList(artistGroupVO); 
		log.info("topArtist : " + topArtist);
		
		//티켓 리스트 목록 가져오기
		List<GoodsVO> goodsVOList = this.ticketService.ticketList(tkCtgr);
		log.info("ticketList -> GoodsVO : "+goodsVOList);
		
		
		
		model.addAttribute("topArtist", topArtist);
		model.addAttribute("bannerFileVOList", bannerFileVOList);
		model.addAttribute("goodsVOList", goodsVOList);
		
		return "shop/home";
	}
	
	/* Goods Shop Detail */
	/* localhost:28080/shop/artistGroup/6/detail/24 */
	@GetMapping("/artistGroup/{artistGroup}/detail/{gdsNo}")
	public String goodsDetailForm(@PathVariable int artistGroup, @PathVariable int gdsNo, Model model) {
		
		// URL 파라미터로 받은 artistGroup과 gdsNo 값 로깅
		log.info("artistGroup : " + artistGroup);
		log.info("gdsNo : " + gdsNo);
		
		// GoodsVO 객체 생성하여 artistGroup과 gdsNo 값 설정
		GoodsVO goodsVO = new GoodsVO();
		goodsVO.setArtGroupNo(artistGroup);
		goodsVO.setGdsNo(gdsNo);
		
		// shopService를 사용하여 해당 상품에 대한 상세 정보를 가져옴
		goodsVO = shopService.goodsDetail(goodsVO);
		
		log.info("goodsVO : " + goodsVO);
		
		// goodsVO가 null인 경우, 상품 정보를 찾을 수 없으므로 홈 페이지로 리다이렉트
		if(goodsVO == null ) {
			return "redirect:/shop/home";
		}else {
			model.addAttribute("goodsVO", goodsVO);
			return "shop/detail";
		}
	}
	
	/* Goods Shop orders*/
	@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@PostMapping("/ordersPost")
	public String goodsPostOrdersForm(ArtistGroupVO artistGroupVO, Model model, 
									  @AuthenticationPrincipal CustomUser customUser,
									  HttpSession session) {
		
		log.info("goodsPostOrdersForm->artistGroupVO : " + artistGroupVO);
		UsersVO usersVO = null;
		MemberVO memberVO = new MemberVO();
		
		// seqGenerator에서 관리하는 시퀀스 정보를 가져와서, orders 테이블의 기본키 값을 삽입하기 위한 코드
		SeqGeneratorVO seqGeneratorVO = new SeqGeneratorVO();
		
		//로그인 체크
		if(customUser == null) {
			//비정상적인 접근으로 로그인 페이지로 이동시켜야함.
		}else {
			usersVO = customUser.getUsersVO();
			memberVO.setMemNo((int)usersVO.getUserNo());
			
			// artistGroupVO 객체에서 상품 정보를 가져와 세션에 저장
			List<GoodsVO> goodsVOList = artistGroupVO.getGoodsVOList();
			session.setAttribute("goodsVOList", goodsVOList);
			
			// seqGeneratorVO에 업무 유형("order") 값을 설정하고, seqGenerator에서 해당 시퀀스 값을 조회하여 가져옴
			seqGeneratorVO.setTaskSeNm("order");
			
			// NULL or seqGeneratorVO return;
			seqGeneratorVO = seqGeneratorMapper.findSeqGenerator(seqGeneratorVO);
			//seqGenerator 값이 null인 경우
			if(seqGeneratorVO == null) {
				seqGeneratorVO = new SeqGeneratorVO();
				seqGeneratorVO.setTaskSeNm("order");
				seqGeneratorMapper.updateSeqGeneratorDate(seqGeneratorVO);
				seqGeneratorVO = seqGeneratorMapper.findSeqGenerator(seqGeneratorVO);
				log.info("seqGeneratorVO : " + seqGeneratorVO);
			}
			
			//Payment param에 사용하는 OrderesId 생성코드
			seqGeneratorVO.setUuid(UUID.randomUUID());
			
			session.setAttribute("seqGeneratorVO", seqGeneratorVO);
			
			//Member 정보가져오기
			memberVO = memberService.memberDetail(memberVO);
			
			model.addAttribute("artistGroupVO", artistGroupVO);
			model.addAttribute("memberVO", memberVO);
		}
		
		return "shop/orders";
	}
	
	/* Goods Shop 등록 폼 */
	@GetMapping("/create")
	public String goodsCreateForm() {
		return "shop/create";
	}
	
	/* Goods Shop DB 저장 */
	@PostMapping("/createPost")
	public String goodsCreateFormPost(GoodsVO goodsVO) {
		
		log.info("goodsVO : " + goodsVO);
		
		int result = shopService.goodsShopInsert(goodsVO);
		
		return "shop/create";
	}
	
	/* ordersPostAjax: 미사용 코드(참조용) */
	@ResponseBody
	@PostMapping("/ordersPostAjax")
	public ArtistGroupVO goodsOrdersPost(@RequestBody ArtistGroupVO artistGroupVO) {
		log.info("artistGroupVO : "+ artistGroupVO);
		return artistGroupVO;
	}
}