<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html>
<head>
<title>oHoT Admin</title>
<link rel="stylesheet" href="/adminlte/plugins/bootstrap/css/bootstrap.min.css"/>
<link rel="stylesheet" href="/adminlte/plugins/fontawesome-free/css/all.min.css"/>
<link rel="stylesheet" href="/adminlte/dist/css/adminlte.min.css"/>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- <script type="text/javascript" src="/ckeditor5/ckeditor.js"></script>   -->
<!-- <script src='fullcalendar/dist/index.global.js'></script>  -->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript">

document.addEventListener('DOMContentLoaded', function() {
	var calendarEl = document.getElementById('calendar');
	var calendar = new FullCalendar.Calendar(calendarEl, {
 		initialView : 'dayGridMonth',
 		timeZone:'local',
		headerToolbar : {
			left:'prev',
			center:'title',
			right:'next'
		},
		height : "auto",
		events : [],
		selectable : true,
		selectMirror : true,
		selectConstraint:{
			start: new Date(),
			end: '9999-12-31'
		},
		select: function(info){
			console.log(info.startStr+"~"+info.endStr);
			$('#startDate').val(info.startStr);
			$('#eventModal').show();
		},
		windowResize : true,
		/* dateClick : function(info) {
			console.log("클릭한 날짜"+info.dateStr)
			calendar.addEvent({title:"glgl", start: info.dateStr})
		}  */
	
	})
	calendar.render();

	window.addEvent = ()=> {
		var start = $('#startDate').val();
		var time = $('#startTime').val();
		var min = $('#startTime').val()+":"+$('#min').val();
		var gdsNm = $('#gdsNm').val();
		console.log(min);

		if (time) {
			calendar.addEvent({
				title: min+" 공연",
				start: start,
				extendedProps: {
					tkYmd: start.split('-').join(''),
					tkRound : time,
					gdsNm: gdsNm
				}
			});
			console.log("잘려라"+start.split('-').join(''));
			
		}
			console.log("✅ 현재 캘린더에 추가된 이벤트 목록:"+ JSON.stringify(calendar.getEvents().forEach(event => console.log(event.extendedProps))));
			const titles = JSON.stringify(calendar.getEvents().map(event => event.extendedProps));
			console.log(titles+"extendedProps");
		$('#eventModal').hide();
		
	}
	window.closeModal = function () {
		$('#eventModal').hide();
	}
	
	$(document).ready(function () {
	    $('#saveBtn').click(function (event) {
	    	event.preventDefault();
	    	const eventList = calendar.getEvents();
	    	
	    	alert("✅ 현재 캘린더에 추가된 이벤트 목록:"+ JSON.stringify(calendar.getEvents()));
	    	
	    	const formData=new FormData(document.querySelector('#saveForm'));
	    	console.log(formData);
	    	axios.post('/admin/goods/ticketCreatePost',formData, {
	    		 headers: { "Content-Type":  "multipart/form-data" }
	    	}).then(response=>{
	    		console.log(response.data);
	    		
	    		axios.post('/admin/goods/ticketEventPost',eventList)
	    		.then(resp=>{
	    			console.log(resp.data)
	    		})
	    	})
	    	
	    });
	});

});

function toggleGdsType() {
    var gdsType = document.getElementById("gdsType").value;
	console.log("옴"+gdsType);
    var artGroupNo = document.getElementById("artGroupNo");
    var artNo = document.getElementById("artNo");

    if (gdsType === "G") {
        artGroupNo.style.display = "block";  
        artNo.style.display = "none";  
        
    } else {
    	artNo.style.display = "block";   
    	artGroupNo.style.display = "none";   
    }
}


function posterImg(){
	let fileInput = document.getElementById("uploadFilePoster");
	
	let formData = new FormData();
    formData.append("uploadFile", fileInput.files[0]); // 'uploadFile'은 서버에서 받을 변수명과 일치해야 함

	$.ajax({
		url:"/admin/goods/ticketPosterPost",
		type:"POST",
		data: formData,
		processData: false,  // 파일 업로드 시 필수 설정
        contentType: false,  // 파일 업로드 시 필수 설정
        success: function (response) {
        	console.log(response);
//         	const fileGroupNo = response;
            //alert("포스터등록 성공!");
            
            if(document.querySelector('#posterFile')){
            	document.querySelector('#posterFile').remove();
            }
	            var img = document.createElement('img');
	            img.setAttribute("src", "/upload/"+response.fileSaveLocate );
	            img.setAttribute("style","width: 200px; height: 300px;");
	            img.setAttribute("id","posterFile");
	            img.setAttribute("name","ticketVO.posterFile");
	            img.setAttribute("value",response.fileGroupNo);
	            document.querySelector('#poster').appendChild(img);
	            
	            var btn = document.getElementById('addPoster');
	            btn.innerText="포스터 이미지 수정";
            	
            
            /* var btn = document.getElementById('#addPoster');
            btn.setAttribute("display","none"); */
            
            /* $.ajax({
        		 url:"/admin/goods/ticketPosterImgPost",
        		type:"POST",
        		data: {"fileGroupNo":response},
                success: function (resp) {
                	console.log(resp);
                    alert("이미지가져오기 성공!");
                },
                error: function (xhr, status, error) {
                    alert("이미지가져오기 실패: " + error);
                } 
        	}) */
            
        },
        error: function (xhr, status, error) {
            alert("파일 업로드 실패: " + error);
        }
	})
}
</script>
</head>
<body class="sidebar-mini layout-fixed" style="height: auto;">
<div class="wrapper">	
	<!-- 관리자 헤더네비바  -->
	<jsp:include page="/WEB-INF/views/admin/adminHeader.jsp"></jsp:include>
	
	<!-- 관리자 사이드바 -->
	<jsp:include page="/WEB-INF/views/admin/adminSidebar.jsp"></jsp:include>


	<!-- 메인페이지 컨텐츠-->
<div class="content-wrapper">
	<form name="saveForm" id="saveForm" enctype="multipart/form-data">
	<div class="form-group " style="padding: 30px;">
		<div class="row">
			<div class="col-sm-2" style="text-align: center">
				<div>
					<input type="text" name="pic"  class="form-control" readonly value="담당자">
				</div>
				<div id="poster" >
				</div>
				<br>
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#posterModal" id="addPoster" > 포스터이미지 등록 </button>
			</div>
			<div class="col-sm-6 ">
				<div class=row>
					<div class="col-sm-4">
						<select name="gdsType" id="gdsType" required onchange="toggleGdsType()" class=" btn btn-secondary dropdown-toggle">
							<option>상품타입</option>
							<option value="G" class="dropdown-item" >그룹상품</option>					
							<option value="I" class="dropdown-item" >아티스트상품</option>					
						</select>
					</div>
					<div class="col-sm-4">
						<select name="artGroupNo" id="artGroupNo" required style="display: none;" class=" btn btn-secondary dropdown-toggle" > 
							<option value="0">그룹 선택</option>
							<c:forEach items="${artistGroupVOList }" var="artist">
								<option value="${artist.artGroupNo }" required >${artist.artGroupNm }</option>					
							</c:forEach>
						</select>
						<select name="artNo" id="artNo" required style="display: none;" class=" btn btn-secondary dropdown-toggle" >
							<option value="0" >아티스트 선택</option>
							<c:forEach items="${artistVOList }" var="artist">
								<option value="${artist.artNo }" required>${artist.artActNm }</option>					
							</c:forEach>
						</select>
					</div>
					<div class="col-sm-4">
						<select name="ticketVO.tkCtgr" id="tkCtgr" required class=" btn btn-secondary dropdown-toggle"  required>
							<option >공연분류</option>
							<option value="콘서트" >콘서트</option>
							<option value="팬미팅" >팬미팅</option>
							<option value="기타" >기타</option>
						</select>
					</div>
					
					
					<div class="col-sm-12 ">
						<b>공연명</b> <input type="text" id="gdsNm" name="gdsNm" class="form-control" required />
					</div>
					<br/>
					<div class=" col-sm-12">
					 	<b>공연가격</b>
						<div class="row">
						<div class="col-sm-4">VIP석<input type="text" id="tkVprice" name="ticketVO.tkVprice" class="form-control " /></div>
						<div class="col-sm-4">R석<input type="text" id="tkRprice" name="ticketVO.tkRprice" class="form-control" /></div>
						<div class="col-sm-4">S석<input type="text" id="tkSprice" name="ticketVO.tkSprice" class="form-control" /></div>
						</div> 
					</div>
					<br/>
					<div class="col-sm-12">
						공연장소-카카오api <input type="text" id="tkLctn" name="tkLctn" class="form-control" />
					</div>
					<div class="col-sm-12" id="ckExplan">
						<b>상품설명</b> <textarea cols="50" rows="10" id="expln" name="expln" class="form-control" ></textarea>
						<b>상품설명이미지등록</b> <input type="file" id="uploadFile" name="uploadFile"  class="form-control" multiple/>
					</div>
				</div>
			</div>
			
			<div class="col-sm-4">
				<div id="calendar" >
					<!-- 캘린더 영역 -->
				</div>
			</div>
		</div>
		<div>
			<button class="btn btn-danger">취소</button>
			<button type="button" class="btn btn-primary" id="saveBtn" >저장</button>
		</div>
	</div>
	</form>
</div>
	
<!-- The Modal -->
	<div class="modal" id="posterModal">
	<div class="modal-dialog">
		<div class="modal-content">
		
		<!-- Modal Header -->
		<div class="modal-header">
			<h4 class="modal-title">포스터등록</h4>
			<button type="button" class="close" data-dismiss="modal">&times;</button>
		</div>
		
		<!-- Modal body -->
		<div class="modal-body">
			<input type="file" id="uploadFilePoster" name="uploadFilePoster"  class="form-control" />
		</div>
		
		<!-- Modal footer -->
		<div class="modal-footer">
			<button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
			<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="posterImg()">저장</button>
		</div>
		
		</div>
	</div>
	</div>
	
<!-- The Modal -->
	<div class="modal" id="eventModal">
	<div class="modal-dialog">
		<div class="modal-content">
		
		<!-- Modal Header -->
		<div class="modal-header">
			<h4 class="modal-title">공연일정등록</h4>
			<button type="button" class="close" data-dismiss="modal" onclick="closeModal()">&times;</button>
		</div>
		
		<!-- Modal body -->
		<div class="modal-body">
			공연날짜 <input type="date" id="startDate" required>
			공연시간 <select id="startTime" ></select> : <select id="min"><option value="00">00</option><option value="30">30</option></select>
		</div>
		
		<!-- Modal footer -->
		<div class="modal-footer">
			<button type="button" class="btn btn-danger" data-dismiss="modal" onclick="closeModal()">취소</button>
			<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="addEvent()">저장</button>
		</div>
		
		</div>
	</div>
	</div>


	<!-- 관리자 풋터 -->
	<jsp:include page="/WEB-INF/views/admin/adminFooter.jsp"></jsp:include>
	
</div>

<script>
  const select = document.getElementById("startTime");
  [...Array(24)].forEach(
		(_, i) => select.innerHTML += `<option value="\${i+1}">\${i+1}</option>`
   );
</script>
<!-- 공통템플릿 js -->
	<!-- jQuery -->
<script src="/adminlte/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="/adminlte/dist/js/adminlte.min.js"></script>
</body>
</html>