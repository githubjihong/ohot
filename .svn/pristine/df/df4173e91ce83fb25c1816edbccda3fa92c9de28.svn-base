<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.mapper.UsersMapper">

	<resultMap type="com.ohot.vo.UsersVO" id="usersMap">
		<result property="userMail" column="USER_MAIL"/>
		<result property="userPswd" column="USER_PSWD"/>
		<result property="userNo" column="USER_NO"/>
		<result property="enabled" column="ENABLED"/>
		<collection property="userAuthList" resultMap="userAuthMap"></collection>
	</resultMap>
	<resultMap type="com.ohot.vo.UserAuthVO" id="userAuthMap">
		<result property="userNo" column="USER_NO"/>
		<result property="authNm" column="AUTH_NM"/>
	</resultMap>
	
	<resultMap type="com.ohot.shop.vo.GoodsVO" id="joinGroupGoodsMap">
		<result property="qty" column="QTY"/>
		<result property="gdsDelYn" column="GDS_DEL_YN"/>
		<result property="gdsNo" column="GDS_NO"/>
		<result property="gdsType" column="GDS_TYPE"/>
		<result property="gdsNm" column="GDS_NM"/>
		<result property="unitPrice" column="UNIT_PRICE"/>
		<result property="expln" column="EXPLN"/>
		<result property="pic" column="PIC"/>
		<result property="regDt" column="REG_DT"/>
		<result property="commCodeGrpNo" column="COMM_CODE_GRP_NO"/>
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artNo" column="ART_NO"/>
		<result property="artGroupNm" column="ART_GROUP_NM"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<association property="fileGroupVO" resultMap="fileGroupMap"></association>
	</resultMap>
	<resultMap type="com.ohot.vo.FileGroupVO" id="fileGroupMap">
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileRegdate" column="FILE_REGDATE"/>
		<collection property="fileDetailVOList" resultMap="fileDetailMap"></collection>
	</resultMap>
	<resultMap type="com.ohot.vo.FileDetailVO" id="fileDetailMap">
		<result property="fileSn" column="FILE_SN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
		<result property="fileSaveName" column="FILE_SAVE_NAME"/>
		<result property="fileSaveLocate" column="FILE_SAVE_LOCATE"/>
		<result property="fileSize" column="FILE_SIZE"/>
		<result property="fileExt" column="FILE_EXT"/>
		<result property="fileMime" column="FILE_MIME"/>
		<result property="fileFancysize" column="FILE_FANCYSIZE"/>
		<result property="fileSaveDate" column="FILE_SAVE_DATE"/>
		<result property="fileDowncount" column="FILE_DOWNCOUNT"/>
	</resultMap>
	
		<resultMap type="com.ohot.vo.ArtistGroupVO" id="artistGroupMap">
		<result property="rnum" column="RNUM"/>
		<result property="artGroupNo" column="ART_GROUP_NO"/>
		<result property="artGroupDebutYmd" column="ART_GROUP_DEBUT_YMD"/>
		<result property="artGroupNm" column="ART_GROUP_NM"/>
		<result property="artGroupExpln" column="ART_GROUP_EXPLN"/>
		<result property="artGroupRegYmd" column="ART_GROUP_REG_YMD"/>
		<result property="artGroupDelYn" column="ART_GROUP_DEL_YN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<association property="fileGroupVO" resultMap="fileGroupMap"></association>
	</resultMap>
	
	<!-- 이메일로 사용자 찾기 -->
	<select id="findByEmail" parameterType="string" resultMap="usersMap">
	    SELECT  U.USER_NO, U.USER_MAIL, USER_PSWD, A.AUTH_NM
		FROM USERS U, USER_AUTH A
		WHERE U.USER_NO = A.USER_NO
		AND USER_MAIL = #{userMail}
	</select>
	
	<!-- 가입한 그룹의 굿즈 리스트 -->
	<select id="joinGroupGoodsList" parameterType="int" resultMap="joinGroupGoodsMap">
		SELECT JG.ART_GROUP_NO, JG.ART_GROUP_NM
		        , G.GDS_NO, G.GDS_TYPE, G.GDS_NM, G.UNIT_PRICE, G.EXPLN
		        , G.PIC, G.REG_DT, G.COMM_CODE_GRP_NO, G.ART_NO, G.FILE_GROUP_NO
		        , G.QTY, G.GDS_DEL_YN
		        , FG.FILE_REGDATE
		        , FD.FILE_SN, FD.FILE_GROUP_NO, FD.FILE_ORIGINAL_NAME, FD.FILE_SAVE_NAME
		        , FD.FILE_SAVE_LOCATE, FD.FILE_SIZE, FD.FILE_EXT, FD.FILE_MIME
		        , FD.FILE_FANCYSIZE, FD.FILE_SAVE_DATE, FD.FILE_DOWNCOUNT
		FROM (SELECT AG.ART_GROUP_NO, AG.ART_GROUP_NM
		        FROM ARTIST_GROUP AG
		        WHERE ART_GROUP_NO IN (SELECT ART_GROUP_NO
		            FROM COMMUNITY_PROFILE
		            WHERE MEM_NO = #{memNo})) JG
		                LEFT OUTER JOIN GOODS G ON(JG.ART_GROUP_NO = G.ART_GROUP_NO)
		                LEFT OUTER JOIN FILE_GROUP FG ON (G.FILE_GROUP_NO = FG.FILE_GROUP_NO)
		                LEFT OUTER JOIN FILE_DETAIL FD ON (FG.FILE_GROUP_NO = FD.FILE_GROUP_NO)
	</select>
	
<!-- 	<select id="allArtistGroupList" parameterType="int" resultMap="artistGroupMap"> -->
<!-- 		SELECT AG.ART_GROUP_NO, AG.ART_GROUP_DEBUT_YMD, AG.ART_GROUP_NM, AG.ART_GROUP_EXPLN -->
<!-- 		    , REGEXP_REPLACE(AG.ART_GROUP_REG_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS ART_GROUP_REG_YMD -->
<!-- 		    , AG.ART_GROUP_DEL_YN, FG.FILE_GROUP_NO, FG.FILE_REGDATE -->
<!-- 		        , FD.FILE_SN, FD.FILE_ORIGINAL_NAME, FD.FILE_SAVE_NAME, FD.FILE_SAVE_LOCATE, FD.FILE_SIZE, FD.FILE_EXT -->
<!-- 		        , FD.FILE_MIME, FD.FILE_FANCYSIZE, FD.FILE_SAVE_DATE, FD.FILE_DOWNCOUNT -->
<!-- 		FROM ARTIST_GROUP AG  -->
<!-- 		LEFT OUTER JOIN FILE_GROUP FG ON(AG.FILE_GROUP_NO = FG.FILE_GROUP_NO) -->
<!-- 		LEFT OUTER JOIN ( -->
<!-- 		      SELECT FILE_SN, FILE_GROUP_NO, FILE_ORIGINAL_NAME, FILE_SAVE_NAME -->
<!-- 		             , FILE_SAVE_LOCATE, FILE_SIZE, FILE_EXT, FILE_MIME, FILE_FANCYSIZE -->
<!-- 		             , FILE_SAVE_DATE, FILE_DOWNCOUNT, ROW_NUMBER() OVER (PARTITION BY FILE_GROUP_NO ORDER BY FILE_SN DESC) AS RN -->
<!-- 		    FROM FILE_DETAIL -->
<!-- 		) FD ON FG.FILE_GROUP_NO = FD.FILE_GROUP_NO AND FD.RN = 1 -->
<!-- 		WHERE 1 = 1 -->
<!-- 		ORDER BY ART_GROUP_NM -->
<!-- 	</select> -->
	
<!-- 	<select id="joinArtistGroupList" parameterType="int" resultMap="artistGroupMap"> -->
<!-- 		SELECT AG.ART_GROUP_NO, AG.ART_GROUP_DEBUT_YMD, AG.ART_GROUP_NM, AG.ART_GROUP_EXPLN -->
<!-- 		    , REGEXP_REPLACE(AG.ART_GROUP_REG_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS ART_GROUP_REG_YMD -->
<!-- 		    , AG.ART_GROUP_DEL_YN, FG.FILE_GROUP_NO, FG.FILE_REGDATE -->
<!-- 		        , FD.FILE_SN, FD.FILE_ORIGINAL_NAME, FD.FILE_SAVE_NAME, FD.FILE_SAVE_LOCATE, FD.FILE_SIZE, FD.FILE_EXT -->
<!-- 		        , FD.FILE_MIME, FD.FILE_FANCYSIZE, FD.FILE_SAVE_DATE, FD.FILE_DOWNCOUNT -->
<!-- 		FROM ARTIST_GROUP AG  -->
<!-- 		LEFT OUTER JOIN FILE_GROUP FG ON(AG.FILE_GROUP_NO = FG.FILE_GROUP_NO) -->
<!-- 		LEFT OUTER JOIN ( -->
<!-- 		      SELECT FILE_SN, FILE_GROUP_NO, FILE_ORIGINAL_NAME, FILE_SAVE_NAME -->
<!-- 		             , FILE_SAVE_LOCATE, FILE_SIZE, FILE_EXT, FILE_MIME, FILE_FANCYSIZE -->
<!-- 		             , FILE_SAVE_DATE, FILE_DOWNCOUNT, ROW_NUMBER() OVER (PARTITION BY FILE_GROUP_NO ORDER BY FILE_SN DESC) AS RN -->
<!-- 		    FROM FILE_DETAIL -->
<!-- 		) FD ON FG.FILE_GROUP_NO = FD.FILE_GROUP_NO AND FD.RN = 1 -->
<!-- 		WHERE 1 = 1 -->
<!-- 		<if test=""> -->
<!-- 		AND ART_GROUP_NO IN (SELECT ART_GROUP_NO -->
<!-- 		            FROM COMMUNITY_PROFILE -->
<!-- 		            WHERE MEM_NO = #{memNo}) -->
<!-- 		</if> -->
<!-- 		ORDER BY ART_GROUP_NM -->
<!-- 	</select> -->
	
	<select id="artistGroupList" parameterType="hashmap" resultMap="artistGroupMap">
		SELECT AG.ART_GROUP_NO, AG.ART_GROUP_DEBUT_YMD, AG.ART_GROUP_NM, AG.ART_GROUP_EXPLN
		    , REGEXP_REPLACE(AG.ART_GROUP_REG_YMD, '(.{4})(.{2})(.{2})', '\1-\2-\3') AS ART_GROUP_REG_YMD
		    , AG.ART_GROUP_DEL_YN, FG.FILE_GROUP_NO, FG.FILE_REGDATE
		        , FD.FILE_SN, FD.FILE_ORIGINAL_NAME, FD.FILE_SAVE_NAME, FD.FILE_SAVE_LOCATE, FD.FILE_SIZE, FD.FILE_EXT
		        , FD.FILE_MIME, FD.FILE_FANCYSIZE, FD.FILE_SAVE_DATE, FD.FILE_DOWNCOUNT
		FROM ARTIST_GROUP AG 
		LEFT OUTER JOIN FILE_GROUP FG ON(AG.FILE_GROUP_NO = FG.FILE_GROUP_NO)
		LEFT OUTER JOIN (
		      SELECT FILE_SN, FILE_GROUP_NO, FILE_ORIGINAL_NAME, FILE_SAVE_NAME
		             , FILE_SAVE_LOCATE, FILE_SIZE, FILE_EXT, FILE_MIME, FILE_FANCYSIZE
		             , FILE_SAVE_DATE, FILE_DOWNCOUNT, ROW_NUMBER() OVER (PARTITION BY FILE_GROUP_NO ORDER BY FILE_SN DESC) AS RN
		    FROM FILE_DETAIL
		) FD ON FG.FILE_GROUP_NO = FD.FILE_GROUP_NO AND FD.RN = 1
		WHERE 1 = 1
		<if test="join != null">
			<if test="join.equals('yes') and memNo != null"> <!-- 가입한 그룹 리스트 조건 -->
			AND ART_GROUP_NO IN (SELECT ART_GROUP_NO
	                        FROM COMMUNITY_PROFILE
	                        WHERE MEM_NO = #{memNo})
			</if>
			<if test="join.equals('no') and memNo != null"> <!-- 가입하지 않은 그룹 리스트 조건 -->
			AND ART_GROUP_NO NOT IN (SELECT ART_GROUP_NO
	                        FROM COMMUNITY_PROFILE
	                        WHERE MEM_NO = 8)
			</if>
		</if>
		ORDER BY ART_GROUP_NM
	</select>
</mapper>