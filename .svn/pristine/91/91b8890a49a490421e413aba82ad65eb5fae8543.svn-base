/**
 * 
 */

// 만 12세 이상 가입 처리
		const birthInput = document.getElementById("memBirth");
		const today = new Date();
		const ageLimit = new Date(today.getFullYear() - 12, today.getMonth(),
				today.getDate());

		const maxDate = ageLimit.toISOString().split('T')[0];
		console.log("maxDate : ", maxDate);
		birthInput.max = maxDate;
		
		// 핸드폰 자동으로 "-"" 입력 / 중복검사 활성화
		const phoneInput = document.getElementById("memTelno");
		

		phoneInput.addEventListener("input", function (e) {
			let value = e.target.value.replace(/[^0-9]/g, ""); // 숫자만 추출

			// 자동 하이픈 처리
			if (value.length < 4) {
			e.target.value = value;
			} else if (value.length < 8) {
			e.target.value = value.slice(0, 3) + "-" + value.slice(3);
			} else {
			e.target.value = value.slice(0, 3) + "-" + value.slice(3, 7) + "-" + value.slice(7, 11);
			}

		});

		// 핸드폰 중복 검사
		function phoneDuplCheck() {
			const checkPhoneBtn = document.getElementById("checkPhoneBtn");

			// 1. 입력값 형식 검사
			const phonePattern = /^010-\d{4}-\d{4}$/;

			console.log("document", phoneInput.value)

			// 1-1. 형식에 일치 할 경우
			if (phonePattern.test(phoneInput.value)) {
				console.log("phoneInput ", phoneInput.value.replace(/-/g, ""));

				axios.post("/phoneDuplCheck", { memTelno : phoneInput.value.replace(/-/g, "") }).then(resp => {
					console.log("phoneDuplCheck", resp.data);
					
					if(resp.data == "duplicate") { // 중복됨
						duplicated("핸드폰 번호");
					} else if(resp.data == "fail") { // 실패
						duplFail("핸드폰 번호");
					} else { // 성공!
						duplSuccess("핸드폰 번호");
					
					}
				})
			} else { //1-2. 형식에 불일치할 경우
				valiFail("핸드폰 번호");
			}
		}

		// 닉네임 중복 검사
		function nickDuplCheck() {
			const checkNickBtn = document.getElementById("checkNickBtn");

			// 1. 입력값 형식 검사
			const memNicknm = document.getElementById("memNicknm");

			// 1-1. 형식에 일치 할 경우
			if (memNicknm.value.length > 0 && memNicknm.value.length <= 20) {

				axios.post("/nickDuplCheck", { memNicknm : memNicknm.value }).then(resp => {
					console.log("nickDuplCheck : ",resp.data);
					
					if(resp.data == "duplicate") { // 중복됨
						duplicated("닉네임");
					} else if(resp.data == "fail") { // 실패
						duplFail();
					} else { // 성공!
						duplSuccess("닉네임");
					}
				})
			} else { //1-2. 형식에 불일치할 경우
				valiFail("닉네임");
			}
		}
		
		// 이름 입력 + 생년월일 입력 + 중복검사 2개 완료 후 가입 완료 버튼 보이기
		let lastNmEntered = false;
		let firstNmEntered = false;
		let birthEntered = false;
		let phoneChecked = false;
		let nickChecked = false;
		
		const joinBtn = document.getElementById("joinBtn");
		
		// 성 입력 감지
		document.querySelector("input[name='memLastName']").addEventListener("input", function(e) {
			lastNmEntered = e.target.value.trim().length > 0;
		    updateJoinButton();
		});
		// 이름 입력 감지
		document.querySelector("input[name='memFirstName']").addEventListener("input", function(e) {
			firstNmEntered = e.target.value.trim().length > 0;
		    updateJoinButton();
		});

		// 생년월일 입력 감지
		document.querySelector("input[name='memBirth']").addEventListener("change", function(e) {
		    birthEntered = !!e.target.value;
		    updateJoinButton();
		});

		
		// alert 모음
		function valiFail(type) {
			Swal.fire({
				icon: 'warning',
				title: '올바르지 않은 '+type+'입니다.',
				text: '형식에 맞게 입력해 주세요',
				confirmButtonText: '확인'
			});
		}
		function duplicated(type) {
			console.log("type : ", type);
			Swal.fire({
				icon: 'warning',
				title: '이미 사용 중인 ' + type + '입니다.',
				text: '다른' + type + '을(를) 사용해 주세요.',
				confirmButtonText: '확인'
			});
		}
		function duplFail() {
			Swal.fire({
				icon: 'error',
				title: '실패했습니다.',
				text: '잠시 후에 다시 시도해 주세요.',
				confirmButtonText: '확인'
			});
		}
		function duplSuccess(type) {
			console.log("type : ", type);
			Swal.fire({
				icon: 'success',
				title: '사용 가능한 ' + type + '입니다!',
				confirmButtonText: '확인'
			});
			
			if (type === "핸드폰 번호") {
		        phoneChecked = true;
		    } else if (type === "닉네임") {
		        nickChecked = true;
		    }
			
			updateJoinButton();
			
		}
		
		// 버튼 보여줄 조건 확인 함수
		function updateJoinButton() {
		    if (lastNmEntered && firstNmEntered && birthEntered && phoneChecked && nickChecked) {
		        joinBtn.style.visibility = "visible";
		        phoneInput.value = phoneInput.value.replace(/-/g, "")
		    } else {
		        joinBtn.style.visibility = "hidden";
		    }
		}