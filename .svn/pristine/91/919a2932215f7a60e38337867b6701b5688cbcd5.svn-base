package com.ohot.shop.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.ohot.home.community.vo.CommunityProfileVO;
import com.ohot.shop.service.ShopService;
import com.ohot.shop.vo.GoodsVO;
import com.ohot.vo.ArtistGroupVO;
import com.ohot.vo.UsersVO;

import jakarta.servlet.http.HttpSession;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
@RequestMapping("/shop")
public class ShopController {
	
	@Autowired
	ShopService shopService;
	
	/* shop Main Home Page */
//	@PreAuthorize("hasAnyRole('MEM', 'ART')")
	@GetMapping("/home")
	public String goodsForm(Model model, HttpSession session) {
		
		UsersVO usersVO = (UsersVO)session.getAttribute("usersVO");
		log.info("usersVO : "+ usersVO);
		
		//login 여부 체크
		if(usersVO == null) {
			model.addAttribute("title", "Recommended Artist");
			
			List<CommunityProfileVO> communityProfileVOList = shopService.communityProfileList(usersVO);
			log.info("communityProfileVOList : " + communityProfileVOList);
			
			//artistGroupVOList
			List<ArtistGroupVO> artistGroupVOList = shopService.artstGroupList(usersVO);
			log.info("artistGroupVOList : " + artistGroupVOList);
			
			model.addAttribute("communityProfileVOList", communityProfileVOList);
			model.addAttribute("artistGroupVOList", artistGroupVOList);
			
		}else {
			model.addAttribute("title", "My Artist");
			
			List<CommunityProfileVO> communityProfileVOList = shopService.communityProfileList(usersVO);
			log.info("communityProfileVOList : " + communityProfileVOList);
			
			//artistGroupVOList
			List<ArtistGroupVO> artistGroupVOList = shopService.artstGroupList(usersVO);
			log.info("artistGroupVOList : " + artistGroupVOList);
			
			model.addAttribute("communityProfileVOList", communityProfileVOList);
			model.addAttribute("artistGroupVOList", artistGroupVOList);
			
		}
		
		return "shop/home";
	}
	
	/* Goods Shop Detail */
	/* localhost:28080/shop/artistGroup/6/detail/24 */
	@GetMapping("/artistGroup/{artistGroup}/detail/{gdsNo}")
	public String goodsDetailForm(@PathVariable int artistGroup, @PathVariable int gdsNo, Model model) {
		
		// URL param 조회
		log.info("artistGroup : " + artistGroup);
		log.info("gdsNo : " + gdsNo);
		
		GoodsVO goodsVO = new GoodsVO();
		goodsVO.setArtGroupNo(artistGroup);
		goodsVO.setGdsNo(gdsNo);
		
		//Goods Shop artist
		goodsVO = shopService.goodsDetail(goodsVO);
		log.info("goodsVO : " + goodsVO);
		
		//goodsVO가 값이 없는 경우
		if(goodsVO == null ) {
			return "redirect:/shop/home";
		}else {
			model.addAttribute("goodsVO", goodsVO);
			return "shop/detail";
		}
	}
	
	/* Goods Shop orders*/
	@PostMapping("/ordersPost")
	public String goodsPostOrdersForm() {
		return "shop/orders";
	}
	
	@ResponseBody
	@PostMapping("/ordersPostAiax")
	public String goodsOrdersPost(@RequestBody List<GoodsVO> goodsVO) {
		log.info("goodsVO : "+ goodsVO);
		return "shop/orders";
	}
	
	/* Goods Shop 등록 폼 */
	@GetMapping("/create")
	public String goodsCreateForm() {
		return "shop/create";
	}
	
	/* Goods Shop DB 저장 */
	@PostMapping("/createPost")
	public String goodsCreateFormPost(GoodsVO goodsVO) {
		
		log.info("goodsVO : " + goodsVO);
		
		int result = shopService.goodsShopInsert(goodsVO);
		
		return "shop/create";
	}
}