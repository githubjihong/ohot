<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohot.admin.mapper.AdminReportMapper">

	<!-- 신고 목록 총 개수
	public int getTotalCount(Map<String, Object> data) -->
	<select id="getTotalCount" resultType="int" parameterType="hashMap">
        SELECT count(*)
		FROM REPORT_BOARD_POST R
		LEFT JOIN MEMBER M ON R.MEM_NO = M.MEM_NO
		WHERE R.REPORT_DEL_YN = 'N'
		<if test="reportGubun != null and reportGubun != ''">
			AND R.REPORT_POST_NO = #{reportPostNo}
		</if>
    </select>
    
    <!-- 신고 관리 리스트 -->	
	<select id="reportListSearchPost" resultMap="reportmanageMapInfo">
		   WITH T AS (
		         SELECT 
					ROW_NUMBER() OVER(ORDER BY REPORT_POST_NO) AS RRNUM,
					R.REPORT_POST_NO AS REPORT_POST_NO,
					R.REPORT_GUBUN AS REPORT_GUBUN,
					R.REPORT_TITLE AS REPORT_TITLE,
					M.MEM_LAST_NAME || ' ' ||M.MEM_FIRST_NAME AS PI_MEM_NAME,
		            R.REPORT_REG_DT AS REPORT_REG_DT,
					R.REPORT_TERMINATION AS REPORT_TERMINATION,
					R.REPORT_RESULT AS REPORT_RESULT,
					R.REPORT_DEL_YN AS REPORT_DEL_YN
					FROM REPORT_BOARD_POST R
					LEFT JOIN MEMBER M ON R.MEM_NO
					= M.MEM_NO
				WHERE R.REPORT_DEL_YN = 'N'
				<if test="reportResult != null and reportResult != ''">
					AND R.REPORT_RESULT = #{reportResult}
				</if>
				<if test="reportGubun != null and reportGubun != ''">
					AND R.REPORT_GUBUN = #{reportGubun}
				</if>
				<if test="piMemName != null and piMemName != ''">
					AND R.PI_MEM_NAME = #{piMemName}
				</if>
				
				
		  )
		  SELECT T.* FROM T
		 WHERE RRNUM BETWEEN #{startRow} AND #{endRow}
		
		
	</select>
	
	<select id="reportmanageDetail"
		parameterType="com.ohot.vo.ReportmanageVO" resultMap="reportmanageMap">
		SELECT
		a.report_post_no
		, a.report_board_no
		, (SELECT E.MEM_FIRST_NAME || E.MEM_LAST_NAME FROM MEMBER E WHERE
		  E.MEM_NO = (SELECT D.MEM_NO FROM COMMUNITY_POST D WHERE D.BOARD_NO =
		  a.report_board_no)) PI_MEM_NAME
		, (SELECT E.MEM_EMAIL FROM MEMBER E WHERE E.MEM_NO = (SELECT D.MEM_NO
		FROM COMMUNITY_POST D WHERE D.BOARD_NO = a.report_board_no))
		PI_MEM_EMAIL
		, a.report_title
		, a.report_cn
		, a.report_reg_dt
		, a.report_chg_dt
		, a.report_del_yn
		, a.mem_no
		, a.report_cnt
		, a.report_termination
		, a.caller_email
		, a.file_group_no
		, b.mem_no
		, b.mem_email
		, b.mem_first_name || ' ' || b.mem_last_name AS MEM_NAME
		, C.FILE_REGDATE
		, D.FILE_SN, D.FILE_ORIGINAL_NAME, D.FILE_SAVE_NAME,
		  D.FILE_SAVE_LOCATE, D.FILE_SIZE
		, D.FILE_EXT, D.FILE_MIME, D.FILE_FANCYSIZE, D.FILE_SAVE_DATE,
		  D.FILE_DOWNCOUNT
		
		FROM report_board_post a INNER JOIN member b ON(a.mem_no = b.mem_no)
		LEFT OUTER JOIN FILE_GROUP C ON(A.FILE_GROUP_NO = C.FILE_GROUP_NO)
		LEFT OUTER JOIN FILE_DETAIL D ON(C.FILE_GROUP_NO = D.FILE_GROUP_NO)
		WHERE 1
		= 1
		AND report_post_no = #{reportPostNo}
	</select>
	
	<!-- 신고글에 대한 관리자의 처리 public int reportUpdate(ReportmanageVO reportmanageVO 
		ReportmanageVO(reportPostNo=3, .. reportResult=002,... -->
	<update id="아직미정"
		parameterType="com.ohot.vo.ReportmanageVO">
		UPDATE report_board_post
		SET REPORT_RESULT =
		#{reportResult}
		WHERE report_post_no = #{reportPostNo}

	</update>
	
	
	
	<resultMap type="com.ohot.vo.ReportmanageVO" id="reportmanageMapInfo">
		<result property="reportPostNo" column="REPORT_POST_NO"/>
		<result property="reportGubun" column="REPORT_GUBUN"/>
		<result property="reportTitle" column="REPORT_TITLE"/>
		<result property="piMemName" column="PI_MEM_NAME"/>
		<result property="reportRegDt" column="REPORT_REG_DT"/>
		<result property="reportTermination" column="REPORT_TERMINATION"/>
		<result property="reportResult" column="REPORT_RESULT"/>
		<result property="reportDelYn" column="REPORT_DEL_YN"/>
		<result property="memNo" column="MEM_NO"/>
	</resultMap>
	
	<resultMap type="com.ohot.vo.ReportmanageVO"
		id="reportmanageMap">
		<result property="reportPostNo" column="REPORT_POST_NO" />
		<result property="reportBoardNo" column="REPORT_BOARD_NO" />
		<result property="reportTitle" column="REPORT_TITLE" />
		<result property="reportGubun" column="REPORT_GUBUN" />
		<result property="reportCn" column="REPORT_CN" />
		<result property="reportRegDt" column="REPORT_REG_DT" />
		<result property="reportChgDt" column="REPORT_CHG_DT" />
		<result property="reportDelYn" column="REPORT_DEL_YN" />
		<result property="memNo" column="MEM_NO" />
		<result property="memEmail" column="MEM_EMAIL" />
		<result property="memName" column="MEM_NAME" />
		<result property="reportCnt" column="REPORT_CNT" />
		<result property="reportTermination"
			column="REPORT_TERMINATION" />
		<result property="callerEmail" column="CALLER_EMAIL" />
		<result property="fileGroupNo" column="FILE_GROUP_NO" />
		<result property="reportResult" column="REPORT_RESULT" />
		<result property="piMemName" column="PI_MEM_NAME" />
		<result property="piMemEmail" column="PI_MEM_EMAIL" />
		<association property="fileGroupVO"
			resultMap="fileGroupMap"></association>
	</resultMap>

	<resultMap type="com.ohot.vo.FileGroupVO" id="fileGroupMap">
		<result property="fileGroupNo" column="FILE_GROUP_NO" />
		<result property="fileRegdate" column="FILE_REGDATE" />
		<collection property="fileDetailVOList"
			resultMap="fileDetailMap"></collection>
	</resultMap>

	<resultMap type="com.ohot.vo.FileDetailVO" id="fileDetailMap">
		<result property="fileSn" column="FILE_SN" />
		<result property="fileGroupNo" column="FILE_GROUP_NO" />
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME" />
		<result property="fileSaveName" column="FILE_SAVE_NAME" />
		<result property="fileSaveLocate" column="FILE_SAVE_LOCATE" />
		<result property="fileSize" column="FILE_SIZE" />
		<result property="fileExt" column="FILE_EXT" />
		<result property="fileMime" column="FILE_MIME" />
		<result property="fileFancysize" column="FILE_FANCYSIZE" />
		<result property="fileSaveDate" column="FILE_SAVE_DATE" />
		<result property="fileDowncount" column="FILE_DOWNCOUNT" />
	</resultMap>
	
	
</mapper>
