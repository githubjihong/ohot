<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div class="wrapper" class="sidebar-mini" style="height: auto;">

		<!-- 관리자 헤더네비바  -->
		<%@ include file="../adminHeader.jsp"%>

		<!-- 관리자 사이드바 -->
		<%@ include file="../adminSidebar.jsp"%>
		<!-- 신고관리 -->
		<div class="content-wrapper"><br>
		${ReportManageList }<br><br>


			<div class="container mt-4">
			<h2>신고 목록</h2>
				<div class="row">
				
				
		<!-- 검색 옵션 영역 -->
		<div class="serch-option">
			<div class="card card-primary">
              <div class="card-header">
                <h3 class="card-title">검색 옵션</h3>
              </div>
              
              <!-- /.card-header -->
              <!-- form start -->
              <form onsubmit="return false;">
                <!-- /.card-body -->
				<div class="card-body">
				  <div class="row mb-6" style="margin-bottom: 0px !important">
				    <!-- 커뮤니티 선택 폼 그룹 -->
				    <div class="col-md-4 form-group mr-3">
				      <label for="community-name">신고타입 선택</label>
				      <select id="community-name" class="form-control select2bs4 select2-hidden-accessible" style="width: 100%;" data-select2-id="17" tabindex="-1" aria-hidden="true">
				        <option value="" disabled="disabled" selected="selected" hidden="hidden">신고유형 선택</option>
				        <c:forEach var="reportmanageVO" items="${ReportManageList }" varStatus="stat">
				          <option value="all">전체 보기</option>
				          <option value="${reportmanageVO.reportGubun }">${reportmanageVO.reportGubun }</option>
				        </c:forEach>
				      </select>
				    </div>

				    <!-- 멤버십 여부 선택 -->
				    <div class="col-md-2 form-group">
				      <label for="membership-filter">신고처리 여부</label>
				      <select id="membership-filter" class="form-control select2bs4" style="width: 100%;">
				        <option value="" selected="selected">전체</option>
				        <option value="Y">신고처리</option>
				        <option value="N">비신고처리</option>
				      </select>
				    </div>

				    
				    <!-- 삭제 여부 선택 -->
				    <div class="col-md-2 form-group">
				      <label for="delete-filter">삭제 여부</label>
				      <select id="delete-filter" class="form-control select2bs4" style="width: 100%;">
				        <option value="" selected="selected">전체</option>
				        <option value="Y">삭제</option>
				        <option value="N">게시중</option>
				      </select>
				    </div>
				  </div>
				  <!-- 검색 1행 끝 -->
				   <!-- 검색 2행 시작 -->
				  <div class="row mb-6" style="margin-bottom: 0px !important; margin-top: 0px !important">
				    <!-- 시작일 선택 -->
				    <div class="col-md-2 form-group gap-5">
				      <label>검색 기간 시작일</label>
				      <div class="input-group date " id="start-date" data-target-input="nearest">
				        <input type="text" class="form-control datetimepicker-input" data-target="#start-date">
				        <div class="input-group-append" data-target="#start-date" data-toggle="datetimepicker">
				          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
				        </div>
				      </div>
				    </div>
				    
				    <!-- 종료일 선택 -->
				    <div class="col-md-2 form-group gap-5">
				      <label>검색 기간 종료일</label>
				      <div class="input-group date" id="end-date" data-target-input="nearest">
				        <input type="text" class="form-control datetimepicker-input" data-target="#end-date">
				        <div class="input-group-append" data-target="#end-date" data-toggle="datetimepicker">
				          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
				        </div>
				      </div>
				    </div>
				    
				  	<div class="col-md-8 form-group" style="padding: 0 25px;">
				    	<label for="search-title">게시글 제목</label>
				    	<div class="input-group">
				      <input id="search-title" type="text" class="form-control rounded-0" placeholder="게시글 제목 입력">
				    </div>
				  </div>

				  </div>
				</div>
				<!-- 검색옵션 2행 끝  -->
				
                <!-- card-footer -->
                <div class="card-footer d-flex justify-content-end">
                  <button type="button" class="btn btn-primary">검색</button>
                </div>
              </form>
            </div>
		</div>
		  <!-- 검색옵션 끝 -->

				
				<div class="tab-content" id="myTabContent">
					<div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab"><!--신고글목록  -->
						<table class="table table-hover mt-3">
							<thead >
								<tr>
									<th>신고No</th>
									<th>신고사유</th>
									<th>회원이름</th>
									<th>등록일시</th>
									<th>정지기간</th>
									<th>신고횟수</th>
									<th>회원번호</th>
									<th></th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								<c:forEach var="reportmanageVO" items="${ReportManageList}">
									<tr>
										<td>${reportmanageVO.reportPostNo }</td>
										<td>${reportmanageVO.reportTitle }</td>
										<td>${reportmanageVO.memName }</td>
										<td>${reportmanageVO.reportRegDt }</td>
										<td id="terminationStatus">${reportmanageVO.reportTermination}일</td>
										<td>${reportmanageVO.reportCnt }</td>
										<td>${reportmanageVO.memNo }</td>
										<td>
											<button type="button" class="btn btn-secondary"
												data-toggle="modal" data-target="#updateModal"
												id="updateReportmanage" onclick="updateReportmanage('${reportmanageVO.reportPostNo}')">신고상세</button>
										</td>
										<td>
											<button type="button" class="btn btn-danger"
												data-toggle="modal" id="deleteReport"
												onclick="deleteReport(${reportmanageVO.reportPostNo})">삭제</button>
										</td>
									</tr>
								</c:forEach>
							</tbody>
						</table>
					</div>
					<!-- 신고글 목록 -->
					
					<!-- 신고관리 상세보기 폼 -->
					<form id="editForm" name="editForm">
			<div class="modal" id="updateModal">
				<div
					class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
					<div class="modal-content">

						<input type="text" id="reportPostNo" name="reportPostNo" />
						<!-- Modal Header -->
						<div class="modal-header">
							<h4 class="modal-title">신고상세</h4>
							<button type="button" class="close" data-dismiss="modal">&times;</button>
						</div>

						<!-- Modal body -->
						<div class="modal-body">
							<input type="hidden" id="memNo" name="memNo" /> <input
								type="hidden" id="fileGroupNo" name="fileGroupNo" />


							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고자 이메일</label>
								<div class="col-sm-8">
									<input type="text" id="piMemEmail2" name="piMemEmail2"
										class="form-control" />
									<code>* ex) 신고한 유저 이메일</code>
								</div>
							</div>
							
							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고자 이름</label>
								<div class="col-sm-8">
									<input type="text" id="piMemEmail" name="piMemEmail"
										class="form-control" />
									<code>* ex) 신고한 유저 이름</code>
								</div>
							</div>
							
							
							<div class="form-group row">
								<label class="col-sm-4 col-form-label">피신고유저</label>
								<div class="col-sm-8">
									<input type="text" id="memBirth" name="memBirth"
										class="form-control" />
									<code>* ex) 피신고 유저 이메일</code>
								</div>
							</div>
							
							<div class="form-group row">
								<label class="col-sm-4 col-form-label">피신고 회원 이름</label>
								<div class="col-sm-8">
									<input type="text" id="memFirstName" name="memFirstName"
										class="form-control" />
								</div>
							</div>

							


							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고사유</label>
								<div class="col-sm-8">
									<input type="text" id="joinYmd" name="joinYmd"
										class="form-control" />
									<code>* ex) 부적절한 댓글입니다</code>
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고상세사유</label>
								<div class="col-sm-8">
									<input type="text" id="secsnYmd" name="secsnYmd"
										class="form-control" />
									<code>* ex) ...때문입니다</code>
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고조치</label>
								<div class="col-sm-8">
									<select class="form-select" aria-label="Default select example"
										name="reportResult" id="reportResult">
										<option value="001">신고해지</option>
										<option value="004">활동정지(7일)</option>
									</select>
								</div>
							</div>

							<div class="form-group row">
								<label class="col-sm-4 col-form-label">신고이미지</label>
								<div class="col-sm-8" id="imgContainer">

								</div>
							</div>
						</div>

						<!-- Modal footer -->
						<div class="modal-footer">
							<button type="button" class="btn btn-danger" data-dismiss="modal">취소</button>
							<button type="button" class="btn btn-primary"
								data-dismiss="modal" onclick="editPost()">신고처리</button>
						</div>
					</div>
				</div>
			</div>
		</form>
					
					
				</div>
			</div>
		</div>
		
		<!-- 관리자 풋터 -->
		<%@ include file="../adminFooter.jsp"%>	
	</div>
	<script type="text/javascript">
	function updateReportmanageupdateReportmanage(reportPostNo){
		fetch("/admin/reportmanage/reportmanageDetailPost?reportPostNo="+reportPostNo).then(resp=>{
			
		});
	}
	</script>

</body>
<script type="text/javascript">
function editPost(){
	
	//1) REPORT_POST_NO
	//2) reportResult
	let reportPostNo = document.getElementById("reportPostNo").value;
	let reportResult = document.getElementById("reportResult").value;
	
	let formData = new FormData();
	formData.append("reportPostNo", reportPostNo);
	formData.append("reportResult", reportResult);
	
	
	for(let [key,value] of formData.entries()) {
        console.log(key + ', ' + value);
    }
	
	//관리자가 신고 요청에 대한 처리
	fetch("/admin/reportmanage/reportmanageDetailPost", {
			method : "post",
			body : formData
			
	}).then(resp=>{
		console.log("resp :", resp);
		
		resp.json().then(data=>{
			console.log("회원정보업뎃 : ", data);
			alert("됐나");
			location.href = location.href;
			
		})
	});
}




//어떤 신고 글(reportPostNo)의 상세인가?
function updateReportmanage(reportPostNo) {
    fetch("/admin/reportmanage/reportmanageDetail?reportPostNo=" + reportPostNo)
        .then(resp => resp.json())
        .then(data => {
        	/*
        	{
			    "reportPostNo": 3,
			    "reportBoardNo": 2,
			    "reportTitle": "댓글신고",
			    "reportCn": "욕설",
			    "reportRegDt": "2025-04-05 14:41:23",
			    "reportChgDt": null,
			    "reportDelYn": "N",
			    "memNo": 5,
			    "reportCnt": 1,
			    "reportTermination": "7",
			    "memberVO": null,
			    "memName": null,
			    "memLastName": null,
			    "memFirstName": null,
			    "memNicknm": null,
			    "memEmail": null,
			    "memTelno": null,
			    "memBirth": null,
			    "memPswd": null,
			    "joinYmd": null,
			    "secsnYmd": null,
			    "memAccessToken": null,
			    "enabled": 0,
			    "memStatSecCodeNo": null,
			    "memSecCodeNo": null,
			    "memDelYn": null,
			    "reportlist": null,
			    "pictureUrl": null,
			    "uploadFile": null,
			    "fileGroupNo": 20250406006,
			    "fileRegdate": null
			}
        	*/
        	console.log("data : ", data);
        	
        	//<input type="text" id="memFirstName" name="memFirstName" class="form-control">
        	
        	$("#reportPostNo").val(reportPostNo);
        	$("#piMemEmail2").val(data.memEmail);
        	$("#piMemEmail").val(data.memName);
        	$("#memBirth").val(data.piMemEmail);
        	$("#memFirstName").val(data.piMemName);
        	$("#joinYmd").val(data.reportTitle);
        	$("#secsnYmd").val(data.reportCn);
    
        	// 이미지 업데이트도 가능
            if (data.fileGroupNo) {
                $("#imgContainer").html(`<img src="/upload\${data.fileGroupVO.fileDetailVOList[0].fileSaveLocate}" />`);  // 경로 확인 필요
            }
        	
        	// ❶ 등록일시 기준으로 남은 해지 일수 계산 함수
        	function calculateTerminationDate(registrationDate) {
        	    const regDate = new Date(registrationDate);  // 등록일
        	    const today = new Date();                    // 오늘

        	    const terminationDate = new Date(regDate);
        	    terminationDate.setDate(regDate.getDate() + 7); // 등록일 + 7일

        	    const diffTime = terminationDate - today;
        	    const remainingDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        	    if (remainingDays > 0) {
        	        return `${remainingDays}일 남음`;
        	    } else if (remainingDays === 0) {
        	        return "오늘 해지됨";
        	    } else {
        	        return "해지일시 지남";
        	    }
        	}

        	// ❷ 신고 상세 조회 후 해지일시 계산 및 DOM 업데이트
        	function updateReportmanage(reportPostNo) {
        	    fetch("/admin/reportmanage/reportmanageDetail?reportPostNo=" + reportPostNo)
        	        .then(resp => resp.json())
        	        .then(data => {
        	            console.log("data : ", data);

        	            // 예: '2025-04-07 14:00:00' → 시간 제외
        	            const dateOnly = data.reportRegDt.split(" ")[0];

        	            const remainingDays = calculateTerminationDate(dateOnly);

        	            // 화면에 해지일시 남은 날짜 업데이트
        	            document.querySelector("#terminationStatus").innerText = remainingDays;

        	            // 기타 모달 필드 채우기 등
        	            $("#memBirth").val(data.memEmail);
        	            $("#memFirstName").val(data.memName);
        	            $("#joinYmd").val(data.reportTitle);
        	            $("#secsnYmd").val(data.reportCn);
        	            $("#fileGroupNo").val(data.fileGroupNo);  // 추가

        	            // 이미지 업데이트도 가능
        	            if (data.fileGroupNo) {
        	                $("img").attr("src", "/upload/" + data.fileGroupNo);  // 경로 확인 필요
        	            }
        	        })
        	        .catch(error => {
        	            console.error("신고 상세 조회 실패:", error);
        	            alert("데이터를 불러오는 중 오류가 발생했습니다.");
        	        });
        	}

		            
        })
        .catch(error => console.error("Error fetching report details:", error));
    
}
    //신고글 삭제
    function deleteReport(reportPostNo){
    	fetch("/admin/reportmanage/reportmanageDelete?reportPostNo="+reportPostNo, {
    		method : "post"
    	}).then(resp=>{
    		console.log(resp);
    		resp.text().then(data=>{
    			console.log("회원정보삭제 : ", data);
    			alert("삭제되었습니다.");
    			let trs = document.querySelectorAll("table > tbody > tr ")
    			console.log("새로 고침",trs);
    			

    			if(trs.length == 1){
    				 let queryString = location.href.split("?")[1];
    				 let startIndex = queryString.indexOf("currentPage=")+12;
    				 let endIndex = queryString.indexOf("&",startIndex);
    				 console.log("페이지 넘버",queryString.substring(startIndex,endIndex));
    				 let pageNum = queryString.substring(startIndex,endIndex);
    				 
    				 // 1페이지 일 때  마지막 멤버 삭제 시 0이 되어버림
    				 // 방지하기 위해 최솟값 1로 유지
    				 pageNum = Math.max(1, pageNum-1);
    				
    				 queryString = queryString.substring(0,startIndex) + pageNum + queryString.substring(endIndex);		 
    				 //alert(queryString);
    				 location.href = location.href.split("?")[0]+"?"+queryString;
    				
    			}else {
    				
    				location.href = location.href;					
    			}
    			
    			
    		})
    	})
  
}

</script>
</body>
</html>

