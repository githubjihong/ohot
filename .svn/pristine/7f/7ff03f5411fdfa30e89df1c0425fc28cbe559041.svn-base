
$(function () {
    // Summernote 에디터 초기화
    // 안쓸게 될거 같은데 일단 남겨둠
    $('.summernote').summernote({
        height: 300,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'underline', 'clear']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link', 'picture']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ]
    });
    
    // 파일 입력 시 파일명 표시
    bsCustomFileInput.init();
    
    // 게시글 유형에 따른 필드 표시/숨김 처리
    $('input[name="mediaMebershipYn"]').change(function() {
        if (this.value === 'N') {
            $('.normal-media-field').show();
            $('.membership-media-field').hide();
        } else {
            $('.normal-media-field').hide();
            $('.membership-media-field').show();
        }
    });
    
 // 폼 제출 전 유효성 검사
    $('#mediaPostForm').submit(function(e) {
        var mediaType = $('input[name="mediaMebershipYn"]:checked').val();
        
        // 일반 미디어인 경우 URL 필수
        if (mediaType === 'N' && !$('#media-url').val()) {
            e.preventDefault();
            alert('미디어 URL을 입력해주세요.');
            $('#media-url').focus();
            return false;
        }
        
        // 멤버십 또는 지난 라이브인 경우 썸네일 및 비디오 필수
        if (mediaType !== 'N') {
            if (!$('#thumbnail-upload').val()) {
                e.preventDefault();
                alert('썸네일 이미지를 업로드 해주세요.');
                $('#thumbnail-upload').focus(); // 디테일 그만 깎아
                return false;
            }
            
            if (!$('#video-upload').val()) {
                e.preventDefault();
                alert('비디오 파일을 업로드 해주세요.');
                $('#video-upload').focus();
                return false;
            }
        }
        
        return true;
    });
 
 // 썸네일 이미지 미리보기
    $('#thumbnail-upload').change(function() {
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function(e) {
                $('#thumbnail-preview').attr('src', e.target.result);
                $('#thumbnail-preview-container').show();
            }
            
            reader.readAsDataURL(this.files[0]);
        } else {
            $('#thumbnail-preview-container').hide();
        }
    });
    
    // 비디오 파일 미리보기
    $('#video-upload').change(function() {
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function(e) {
                $('#video-preview source').attr('src', e.target.result);
                $('#video-preview')[0].load(); // 비디오 로드
                $('#video-preview-container').show();
            }
            
            reader.readAsDataURL(this.files[0]);
        } else {
            $('#video-preview-container').hide();
        }
    });
    
    // YouTube URL 미리보기
    $('#media-url').on('input', function() {
        var youtubeUrl = $(this).val();
        if (youtubeUrl) {
            // YouTube ID 추출
            var youtubeId = extractYoutubeId(youtubeUrl);
            if (youtubeId) {
                $('#youtube-preview').attr('src', 'https://www.youtube.com/embed/' + youtubeId);
                $('#youtube-preview-container').show();
            } else {
                $('#youtube-preview-container').hide();
            }
        } else {
            $('#youtube-preview-container').hide();
        }
    });
    
    // YouTube ID 추출 함수
    function extractYoutubeId(url) {
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        var match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }
    
    // 게시글 유형에 따른 필드 표시/숨김 처리 - 수정
    $('input[name="mediaMebershipYn"]').change(function() {
        if (this.value === 'N') {
            $('.normal-media-field').show();
            $('.membership-media-field').hide();
            // 미리보기 컨테이너도 초기화
            $('#thumbnail-preview-container, #video-preview-container').hide();
        } else {
            $('.normal-media-field').hide();
            $('.membership-media-field').show();
            // YouTube 미리보기 컨테이너 초기화
            $('#youtube-preview-container').hide();
        }
    });
	
	// 삭제 버튼 처리
	$("#deleteBtn").on("click", function(){
		console.log("삭제 이벤트");
		// ajax로 삭제
		if(confirm("정말 삭제하시겠습니까?")){
			$.ajax({
				url: 'api/media/deletePost',
				type: 'POST',
				data: {
					'mediaPostNo':'${mediaPostVO.mediaPostNo}'
				},
				success: function(result){
					alert('게시글을 삭제했습니다.');
					window.location.href = '/admin/media';
				},
				error: function(xhr, status, error){
					alert('삭제를 실패했습니다: ' + error);
				}
			})
		}
	});
	
});
